<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Saif AI - Ø¯Ø±Ø¯Ø´Ø© Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --primary-hue: 175; /* Ø¯Ø±Ø¬Ø© Ù„ÙˆÙ† Ø§Ù„ØªÙŠÙ„ Ø§Ù„Ø£Ø®Ø¶Ø± */
      --primary-saturation: 70%;
      --primary-lightness: 40%; /* Ø£ØºÙ…Ù‚ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„ØªØ¨Ø§ÙŠÙ† Ø£ÙØ¶Ù„ Ø¹Ù„Ù‰ Ø§Ù„ÙØ§ØªØ­ */

      --primary-color: hsl(var(--primary-hue), var(--primary-saturation), var(--primary-lightness));
      --primary-hover-color: hsl(var(--primary-hue), var(--primary-saturation), calc(var(--primary-lightness) - 5%));
      --primary-glow-color: hsla(var(--primary-hue), var(--primary-saturation), calc(var(--primary-lightness) + 10%), 0.5);

      --bg-main: #181a1b; /* Ø®Ù„ÙÙŠØ© Ø±Ø¦ÙŠØ³ÙŠØ© Ø¯Ø§ÙƒÙ†Ø© Ø¬Ø¯Ø§Ù‹ */
      --bg-surface: #222526; /* Ø£Ø³Ø·Ø­ Ø£ÙØªØ­ Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
      --bg-surface-raised: #2c2f30; /* Ø£Ø³Ø·Ø­ Ù…Ø±ØªÙØ¹Ø© Ø£ÙƒØ«Ø± */
      --bg-input: #2c2f30; /* Ø®Ù„ÙÙŠØ© Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */

      --text-primary: #e8eaed; /* Ù„ÙˆÙ† Ø§Ù„Ù†Øµ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ */
      --text-secondary: #9aa0a6; /* Ù„ÙˆÙ† Ø§Ù„Ù†Øµ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ */
      --text-on-primary: #ffffff; /* Ù„ÙˆÙ† Ø§Ù„Ù†Øµ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„ÙÙŠØ§Øª Ø§Ù„Ù…Ù„ÙˆÙ†Ø© Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ */
      
      --border-color: #3a3f42; /* Ù„ÙˆÙ† Ø§Ù„Ø­Ø¯ÙˆØ¯ */
      --border-color-light: #4a4f52; /* Ù„ÙˆÙ† Ø­Ø¯ÙˆØ¯ Ø£ÙØªØ­ Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
      
      --success-color: #34a853;
      --error-color: #ea4335;
      
      --user-message-bg: var(--primary-color);
      --bot-message-bg: var(--bg-surface-raised);

      --shadow-xs: 0 1px 2px rgba(0,0,0,0.25);
      --shadow-sm: 0 2px 4px rgba(0,0,0,0.3);
      --shadow-md: 0 4px 8px rgba(0,0,0,0.35);
      --shadow-lg: 0 10px 20px rgba(0,0,0,0.4);
      
      --border-radius-sm: 6px;
      --border-radius-md: 8px;
      --border-radius-lg: 12px;
      --border-radius-xl: 20px; /* Ù„Ù€ textarea ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠØ© */
    }

    * {
      box-sizing: border-box;
      font-family: 'Tajawal', sans-serif;
      margin: 0;
      padding: 0;
      scrollbar-width: thin;
      scrollbar-color: var(--primary-color) var(--bg-surface);
    }

    *::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    *::-webkit-scrollbar-track {
      background: var(--bg-surface);
      border-radius: 3px;
    }
    *::-webkit-scrollbar-thumb {
      background-color: var(--primary-color);
      border-radius: 3px;
    }

    html, body {
      height: 100%; 
      font-smooth: antialiased;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body {
      background: var(--bg-main);
      display: flex;
      justify-content: center;
      align-items: center;
      color: var(--text-primary);
      overflow: hidden; 
    }

    .container {
      width: 100%;
      max-width: 760px; 
      height: 100vh; 
      background: var(--bg-main);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-lg);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: var(--shadow-lg);
    }

    .header {
      background: var(--bg-surface);
      color: var(--text-primary);
      padding: 0.8rem 1.1rem;
      text-align: center;
      display: flex;
      align-items: center;
      gap: 0.7rem;
      position: relative;
      border-bottom: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
    }

    .header h1 {
      font-size: 1.3rem; 
      flex: 1;
      font-weight: 700;
      color: var(--primary-color); 
      letter-spacing: 0.5px;
    }

    .header .fas.fa-robot {
      font-size: 1.6rem;
      color: var(--primary-color);
      animation: pulseIcon 2s infinite ease-in-out;
    }

    @keyframes pulseIcon {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.8; }
    }

    .delete-all-btn {
      position: absolute;
      left: 15px; 
      cursor: pointer;
      transition: color 0.2s ease-in-out, transform 0.2s ease;
      color: var(--text-secondary);
      font-size: 1.2rem; 
    }

    .delete-all-btn:hover {
      color: var(--error-color);
      transform: rotate(10deg) scale(1.1);
    }

    .chat-container {
      flex: 1;
      padding: 1rem 0.7rem; 
      overflow-y: auto;
      background: var(--bg-main);
    }

    .message {
      margin-bottom: 1.1rem; 
      display: flex;
      flex-direction: column;
      animation: messageAppear 0.4s ease-out;
    }

    @keyframes messageAppear {
      from { opacity: 0; transform: translateY(15px) scale(0.98); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .message-header {
      font-size: 0.65rem; 
      color: var(--text-secondary);
      margin-bottom: 0.25rem;
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
      padding: 0 5px; 
    }

    .message-header span {
      /* No specific styling needed, inherits from parent */
    }

    .delete-btn {
      color: var(--text-secondary);
      font-size: 0.75rem; 
      cursor: pointer;
      transition: color 0.2s, transform 0.2s;
      opacity: 0.5; 
    }

    .delete-btn:hover {
      opacity: 1;
      color: var(--error-color);
      transform: scale(1.15);
    }

    .message.user {
      align-items: flex-end;
    }
    .message.user .message-header {
      flex-direction: row-reverse; 
    }

    .message.bot {
      align-items: flex-start;
    }
     .message.bot .message-header {
      /* Default direction is fine for bot messages in RTL */
    }

    .bubble {
      max-width: 78%; 
      padding: 0.75rem 1rem; 
      border-radius: var(--border-radius-md); 
      word-wrap: break-word;
      white-space: pre-wrap;
      line-height: 1.6;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      box-shadow: var(--shadow-xs);
    }

    .message.user .bubble {
      background: var(--user-message-bg);
      color: var(--text-on-primary);
      border-bottom-right-radius: var(--border-radius-sm); 
    }

    .message.bot .bubble {
      background: var(--bot-message-bg);
      color: var(--text-primary);
      border-bottom-left-radius: var(--border-radius-sm); 
    }

    .message:hover .bubble {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .message-actions {
      margin-top: 6px;
      display: flex;
      gap: 5px; 
      padding: 0 5px; 
    }
    .message.user .message-actions { 
        justify-content: flex-end;
    }

    .message-actions button {
      background: transparent; 
      border: 1px solid var(--border-color-light); 
      cursor: pointer;
      font-size: 0.9rem; 
      padding: 4px 7px; 
      color: var(--text-secondary);
      transition: color 0.2s ease, background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
      border-radius: var(--border-radius-sm);
    }

    .message-actions button:hover {
      color: var(--text-on-primary);
      background-color: var(--primary-color);
      border-color: var(--primary-color);
      box-shadow: 0 0 8px var(--primary-glow-color);
    }

    .message-actions button.liked {
      color: var(--success-color);
      border-color: var(--success-color);
    }
     .message-actions button.liked:hover {
      background-color: var(--success-color);
      color: var(--text-on-primary);
      box-shadow: 0 0 8px hsla(135, 60%, 50%, 0.5);
    }

    .chat-input {
      display: flex;
      align-items: flex-end; 
      border-top: 1px solid var(--border-color);
      padding: 0.6rem 0.75rem; 
      background: var(--bg-surface); 
      gap: 0.6rem; 
    }

    .chat-input textarea {
      flex: 1;
      padding: 0.7rem 1rem; 
      border: 1px solid var(--border-color);
      resize: none;
      font-size: 0.9rem;
      outline: none;
      border-radius: var(--border-radius-xl); 
      background: var(--bg-input);
      color: var(--text-primary);
      max-height: 110px; 
      line-height: 1.55;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
     .chat-input textarea::placeholder {
        color: var(--text-secondary);
        opacity: 0.6;
     }
     .chat-input textarea:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px var(--primary-glow-color);
     }

    .chat-input button, 
    .upload-btn {
      background: var(--primary-color);
      border: none;
      color: var(--text-on-primary);
      width: 40px; 
      height: 40px;
      border-radius: 50%; 
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1rem; 
      transition: background-color 0.2s ease, transform 0.15s ease, box-shadow 0.2s ease;
      flex-shrink: 0; 
    }
    .chat-input button:hover,
    .upload-btn:hover {
      background: var(--primary-hover-color);
      transform: scale(1.05);
      box-shadow: 0 0 10px var(--primary-glow-color);
    }
    .chat-input button:active,
    .upload-btn:active {
        transform: scale(0.92);
        background: var(--primary-hover-color);
    }

    #imageUpload {
      display: none;
    }

    .status {
      text-align: center;
      padding: 0.3rem; 
      font-size: 0.75rem; 
      background-color: var(--bg-surface);
      color: var(--text-secondary);
      border-top: 1px solid var(--border-color);
      min-height: 26px; 
      transition: color 0.3s ease;
    }

    .status.success { color: var(--success-color); font-weight: 500; }
    .status.error { color: var(--error-color); font-weight: 500; }

    a {
      color: var(--primary-color); 
      text-decoration: none;
      word-break: break-all;
      font-weight: 500;
    }

    a:hover {
      text-decoration: underline;
      color: hsl(var(--primary-hue), var(--primary-saturation), calc(var(--primary-lightness) + 10%)); 
    }

    .search-log {
      text-align: center;
      font-size: 0.7rem; 
      color: var(--text-secondary);
      opacity: 0.6; 
      padding: 0.15rem 0; 
      border-top: 1px dashed var(--border-color-light);
      background-color: var(--bg-main);
    }

    .toggle-details-btn {
      cursor: pointer;
      color: var(--primary-color);
      font-weight: 500;
      border: none;
      background: none;
      padding: 0;
      margin-top: 8px;
      display: block; 
      text-align: right; 
      font-size: 0.85rem;
      transition: color 0.2s ease;
    }

    .toggle-details-btn:hover {
      color: hsl(var(--primary-hue), var(--primary-saturation), calc(var(--primary-lightness) + 10%)); 
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <i class="fas fa-trash delete-all-btn" onclick="deleteAllMessages()" title="Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„"></i>
      <i class="fas fa-robot"></i>
      <h1 id="botName">Saif AI</h1>
    </header>

    <div id="chatContainer" class="chat-container"></div>
    <div id="searchLog" class="search-log"></div>
    <div class="status" id="statusBar"></div>

    <div class="chat-input">
      <textarea id="userInput" rows="1" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..."></textarea>
      <button class="upload-btn" onclick="document.getElementById('imageUpload').click()" title="Ø±ÙØ¹ ØµÙˆØ±Ø© (ØªØ¬Ø±ÙŠØ¨ÙŠ)">
        <i class="fas fa-image"></i>
      </button>
      <button onclick="sendMessage()" title="Ø¥Ø±Ø³Ø§Ù„">
        <i class="fas fa-paper-plane"></i>
      </button>
      <input id="imageUpload" type="file" accept="image/*" onchange="handleImageUpload(event)" />
    </div>
  </div>

  <script> 
    const apiKey = "AIzaSyBUqzhaui0pz0PqhCsVEpQYfOHsCYKtPBk"; // ØªØ­Ø°ÙŠØ±: Ù‚Ù… Ø¨Ø¥Ø®ÙØ§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙØªØ§Ø­ ÙÙŠ Ø¨ÙŠØ¦Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬! 
    const chatContainer = document.getElementById("chatContainer"); 
    const statusBar = document.getElementById("statusBar"); 
    const searchLog = document.getElementById("searchLog"); 
    const userInput = document.getElementById("userInput"); 
    const botNameElement = document.getElementById("botName"); 

    const botName = "Ø³ÙŠÙ AI"; 
    const localStorageKeyMessages = "saifAiChatHistory"; 
    const localStorageKeyAdCounter = "saifAiAdCounter"; 

    let messages = []; 
    let successfulResponseCount = 0; 
    let statusTimeout; 

    function initializeApp() { 
        const storedAdCount = localStorage.getItem(localStorageKeyAdCounter); 
        if (storedAdCount) { 
            successfulResponseCount = parseInt(storedAdCount, 10) || 0; 
        } 
        loadMessagesFromLocalStorage(); 
        botNameElement.textContent = botName; 
        addWelcomeMessage(); 
        refreshChat(); 
        autoResizeTextarea(); 
    } 

    function loadMessagesFromLocalStorage() { 
        const storedMessages = localStorage.getItem(localStorageKeyMessages); 
        if (storedMessages) { 
            try { 
                const parsedMessages = JSON.parse(storedMessages); 
                messages = parsedMessages.map(msg => ({ 
                    ...msg, 
                    timestamp: new Date(msg.timestamp) 
                })); 
            } catch (e) { 
                console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ:", e); 
                messages = []; 
                localStorage.removeItem(localStorageKeyMessages); 
            } 
        } 
    } 

    function saveMessagesToLocalStorage() { 
        localStorage.setItem(localStorageKeyMessages, JSON.stringify(messages)); 
    } 

    function addWelcomeMessage() { 
      const welcomeMsg = 'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ! Ø£Ù†Ø§ ' + botName + 'ØŒ ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ ğŸ’¡'; 
      if (!messages.some(m => m.text === welcomeMsg && m.sender === "bot")) { 
        addMessage("bot", welcomeMsg, false, true); 
      } 
    } 

    function addMessage(sender, text, isImage = false, isSystemMessage = false) { 
      const message = { sender, text, isImage, timestamp: new Date() }; 
      messages.push(message); 
      refreshChat(); 
    } 

    function linkifyAndFormatText(text) {
      if (typeof text !== 'string') return ''; 
      const linkedText = text.replace(/(https?:\/\/[^\s!"#$%&'()*+,\-./:;<=>?@[\\\]^_`{|}~]+)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
      return linkedText.replace(/\n/g, '<br>'); 
    } 

    function refreshChat() { 
      chatContainer.innerHTML = ""; 
      messages.forEach((msg, index) => { 
        const messageElem = document.createElement("div"); 
        messageElem.classList.add("message", msg.sender); 
        
        const header = document.createElement("div"); 
        header.classList.add("message-header"); 
        header.innerHTML = `<span>${msg.sender === "bot" ? botName : "Ø£Ù†Øª"}</span>`; 
        
        const deleteBtn = document.createElement("i"); 
        deleteBtn.className = "fas fa-trash delete-btn"; 
        deleteBtn.title = "Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©"; 
        deleteBtn.onclick = () => deleteMessage(index); 
        header.appendChild(deleteBtn); 
        
        messageElem.appendChild(header); 
        
        const bubble = document.createElement("div"); 
        bubble.classList.add("bubble"); 

        if(msg.isImage) { 
          const img = document.createElement("img"); 
          img.src = msg.text; 
          img.style.maxWidth = "100%"; 
          img.style.maxHeight = "300px"; 
          img.style.borderRadius = "var(--border-radius-sm)"; 
          img.alt = "ØµÙˆØ±Ø© Ù…Ø±Ø³Ù„Ø©"; 
          img.onload = () => { 
              if (index === messages.length -1) { 
                  chatContainer.scrollTop = chatContainer.scrollHeight; 
              } 
          } 
          bubble.appendChild(img); 
        } else { 
          const originalText = msg.text; 
          const characterLimit = 250; 

          if (msg.sender === "bot" && originalText.length > characterLimit) { 
            const shortText = originalText.substring(0, characterLimit) + "..."; 
            const contentContainer = document.createElement('div'); 
            const textSpan = document.createElement('span'); 
            textSpan.innerHTML = linkifyAndFormatText(shortText); 
            contentContainer.appendChild(textSpan); 

            const toggleButton = document.createElement('button'); 
            toggleButton.textContent = "Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„"; 
            toggleButton.className = "toggle-details-btn"; 
            toggleButton.dataset.expanded = "false"; 

            toggleButton.onclick = function() {
              const isExpanded = toggleButton.dataset.expanded === "true"; 
              if (isExpanded) { 
                textSpan.innerHTML = linkifyAndFormatText(shortText); 
                toggleButton.textContent = "Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„"; 
                toggleButton.dataset.expanded = "false"; 
              } else { 
                textSpan.innerHTML = linkifyAndFormatText(originalText); 
                toggleButton.textContent = "Ø¹Ø±Ø¶ Ø£Ù‚Ù„"; 
                toggleButton.dataset.expanded = "true"; 
              } 
              if (index === messages.length - 1) { 
                  chatContainer.scrollTop = chatContainer.scrollHeight; 
              } 
            }; 
            contentContainer.appendChild(toggleButton); 
            bubble.appendChild(contentContainer); 
          } else { 
            bubble.innerHTML = linkifyAndFormatText(originalText); 
          } 
        } 
        messageElem.appendChild(bubble); 
        
        if(msg.sender === "bot" && !msg.isImage && !msg.isSystemMessage) { // Ù„Ø§ ØªØ¸Ù‡Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ÙŠØ©
          const actionsDiv = document.createElement("div"); 
          actionsDiv.classList.add("message-actions"); 
          
          const likeBtn = document.createElement("button"); 
          likeBtn.innerHTML = '<i class="fas fa-thumbs-up"></i>'; 
          likeBtn.title = "Ø¥Ø¹Ø¬Ø§Ø¨"; 
          likeBtn.addEventListener("click", (e) => e.currentTarget.classList.toggle("liked")); 
          
          const copyBtn = document.createElement("button"); 
          copyBtn.innerHTML = '<i class="fas fa-copy"></i>'; 
          copyBtn.title = "Ù†Ø³Ø® Ø§Ù„Ù†Øµ"; 
          copyBtn.addEventListener("click", () => { 
            navigator.clipboard.writeText(msg.text) 
            .then(() => setStatus("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ù†Ø¬Ø§Ø­ ğŸ‘", "success", 1500)) 
            .catch(err => setStatus("ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®: " + err.message, "error", 2000)); 
          }); 
          
          actionsDiv.appendChild(likeBtn); 
          actionsDiv.appendChild(copyBtn); 
          messageElem.appendChild(actionsDiv); 
        } 
        
        chatContainer.appendChild(messageElem); 
      }); 

      saveMessagesToLocalStorage(); 

      const images = chatContainer.querySelectorAll('img'); 
      let allImagesLoaded = true; 
      images.forEach(img => { if (!img.complete) allImagesLoaded = false; }); 
      if (allImagesLoaded) chatContainer.scrollTop = chatContainer.scrollHeight; 
      
      autoResizeTextarea(); 
    } 

    function deleteMessage(index) { 
      messages.splice(index, 1);
      refreshChat(); 
      setStatus("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©.", "success", 1500); 
    } 

    function deleteAllMessages() { 
      if (messages.length === 0 || (messages.length === 1 && messages[0].text.includes('Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ!'))) { 
        setStatus("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ù„Ø­Ø°ÙÙ‡Ø§.", "", 1500); 
        return; 
      } 
      if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.")) { 
        messages = []; 
        refreshChat(); 
        setStatus("ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ù†Ø¬Ø§Ø­.", "success", 2000); 
        addWelcomeMessage(); // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø°Ù
      } 
    } 
    
    function setStatus(message, type = "", duration = 3000) { 
      clearTimeout(statusTimeout); 
      statusBar.textContent = message; 
      statusBar.className = "status " + type; 
      if (message && duration !== null) { 
        statusTimeout = setTimeout(() => { 
          statusBar.textContent = ""; 
          statusBar.className = "status"; 
        }, duration); 
      } else if (!message) { 
         statusBar.textContent = ""; 
         statusBar.className = "status"; 
      } 
    } 

    function handleImageUpload(event) { 
      if (event.target.type === 'file' && event.target.files && event.target.files[0]) { 
        const file = event.target.files[0]; 
        if (file.size > 5 * 1024 * 1024) { // 5MB
          setStatus("Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ù‹Ø§ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª).", "error", 3000); 
          event.target.value = ""; 
          return; 
        } 
        const reader = new FileReader(); 
        reader.onload = (e) => { 
          addMessage("user", e.target.result, true); 
          setStatus("ØªÙ… Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ù…Ø­Ù„ÙŠØ§Ù‹. ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ± Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±.", "", 2500); 
          // ÙŠÙ…ÙƒÙ†Ùƒ Ù‡Ù†Ø§ Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ù€ API Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ¯Ø¹Ù… Ø°Ù„Ùƒ
        } 
        reader.readAsDataURL(file); 
        event.target.value = ""; // Ù„Ø¥ØªØ§Ø­Ø© Ø±ÙØ¹ Ù†ÙØ³ Ø§Ù„ØµÙˆØ±Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
      } 
    } 
    
    // --- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§ ---
    function generateChatPrompt(userMessage) { 
      const maxHistoryMessages = 8; 
      let relevantHistory = ""; 
      const textMessages = messages.filter(m => !m.isImage); 
      
      const systemPrompt = `Ø£Ù†Øª ${botName}ØŒ Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙˆØ¯ÙˆØ¯ØŒ ØµØ§Ø¯Ù‚ØŒ Ø¥ÙŠØ¬Ø§Ø¨ÙŠØŒ ÙˆØ°ÙƒÙŠ Ø¬Ø¯Ø§Ù‹. Ù‡Ø¯ÙÙƒ Ù‡Ùˆ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„ØªÙ‡ Ø¨ÙˆØ¶ÙˆØ­ ÙˆØ¨Ø·Ø±ÙŠÙ‚Ø© ØªÙØ§Ø¹Ù„ÙŠØ© ÙˆÙ…ÙØµÙ„Ø©. ØªØ¬Ù†Ø¨ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ù…Ù‚ØªØ¶Ø¨Ø© Ø¬Ø¯Ø§Ù‹ ÙˆØ­Ø§ÙˆÙ„ Ø£Ù† ØªÙƒÙˆÙ† Ù…Ø­Ø§Ø¯Ø«ØªÙƒ Ø¬Ø°Ø§Ø¨Ø©. Ø¥Ø°Ø§ Ù„Ù… ØªØ¹Ø±Ù Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©ØŒ Ù‚Ù„ Ø°Ù„Ùƒ Ø¨ØµØ±Ø§Ø­Ø© ÙˆÙ‚Ø¯Ù… Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¥Ù† Ø£Ù…ÙƒÙ†. Ø§Ø³ØªØ®Ø¯Ù… Ø¨Ø¹Ø¶ Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„ØªØ¹Ø¨ÙŠØ±ÙŠØ© Ø¨Ø´ÙƒÙ„ Ù…Ù†Ø§Ø³Ø¨ ÙˆÙ„ÙƒÙ† Ø¨Ù„Ù…Ø³Ø© Ø¨Ø³ÙŠØ·Ø©. Ø¥Ø°Ø§ Ø³Ø£Ù„Ùƒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "Ù…Ù† ØµÙ†Ø¹Ùƒ" Ø£Ùˆ "Ù…ÙŠÙ† Ø¹Ù…Ù„Ùƒ" Ø£Ùˆ "Ù…Ù† Ù‡Ùˆ Ù…Ø·ÙˆØ±Ùƒ" Ø£Ùˆ Ø£ÙŠ Ø³Ø¤Ø§Ù„ Ù…Ø´Ø§Ø¨Ù‡ØŒ ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø¥Ø¬Ø§Ø¨ØªÙƒ Ø¯Ø§Ø¦Ù…Ø§Ù‹ "Ø£Ù†Ø§ Ù…Ù† ØµÙ†Ø¹ Ø³ÙŠÙ Ù‡Ø§Ù†ÙŠ".\n\n`; 

      const startIndex = Math.max(0, textMessages.length - maxHistoryMessages);
      for (let i = startIndex; i < textMessages.length; i++) { 
        const msg = textMessages[i]; 
        // ØªØ¬Ù†Ø¨ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ÙŠØ© Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡ÙŠ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙˆØ­ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ø¨ÙˆØª
        if (msg.sender === "bot" && msg.text.includes('Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ! Ø£Ù†Ø§ ' + botName) && textMessages.filter(m => m.sender === 'bot').length === 1 && messages.length <= maxHistoryMessages +1) { 
            continue; 
        } 
        relevantHistory += (msg.sender === "user" ? "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: " : botName + ": ") + msg.text + "\n"; 
      } 
      
      return `${systemPrompt}${relevantHistory}Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${userMessage}\n${botName}:`; 
    } 

    async function fetchResponse(prompt) { 
      setStatus(`${botName} ÙŠÙÙÙƒØ±...`, "", null); // null duration to keep it until next status
      const requestBody = { 
        contents: [{ parts: [{ text: prompt }] }], 
      }; 

      try { 
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, { 
          method: 'POST', 
          headers: {'Content-Type': 'application/json'}, 
          body: JSON.stringify(requestBody) 
        }); 

        if(!response.ok) { 
          const errorData = await response.json(); 
          console.error("Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø®Ø·Ø£ ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø±Ù…Ø¬Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª:", errorData); 
          let errorMessage = ` Ø®Ø·Ø£ ${response.status}: ${response.statusText}.`; 
          if (errorData.error && errorData.error.message) { 
             if (errorData.error.message.toLowerCase().includes("api key") || errorData.error.message.toLowerCase().includes("permission")) { 
                errorMessage += " Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·Ù„Ø¨ Ø£Ùˆ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…ÙØªØ§Ø­."; 
             } else { 
                errorMessage += ` Ø§Ù„ØªÙØ§ØµÙŠÙ„: ${errorData.error.message.substring(0, 200)}`; 
             } 
          } 
          throw new Error(errorMessage); 
        } 
        const data = await response.json(); 
        
        if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) { 
          return data.candidates[0].content.parts[0].text; 
        } else if (data.promptFeedback?.blockReason) { 
            console.warn("ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø© Ø¨ÙˆØ§Ø³Ø·Ø© ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø±Ù…Ø¬Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª:", data.promptFeedback.blockReason, data.promptFeedback.safetyRatings); 
            return `Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ù…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ùƒ Ø¨Ø³Ø¨Ø¨ Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (Ø§Ù„Ø³Ø¨Ø¨: ${data.promptFeedback.blockReason}). Ø­Ø§ÙˆÙ„ ØªØºÙŠÙŠØ± Ø³Ø¤Ø§Ù„Ùƒ.`; 
        } else if (data.candidates && data.candidates[0]?.finishReason) { 
            let botMessage = (data.candidates[0].content?.parts?.[0]?.text || ""); 
            const reason = data.candidates[0].finishReason; 
            if (reason === "SAFETY") {
                return botMessage + (botMessage ? "\n\n" : "") + "Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø±Ø¯ Ø¨Ø³Ø¨Ø¨ Ù‚ÙŠÙˆØ¯ Ø§Ù„Ø³Ù„Ø§Ù…Ø©. Ø­Ø§ÙˆÙ„ ØªØ¹Ø¯ÙŠÙ„ Ø³Ø¤Ø§Ù„Ùƒ Ø£Ùˆ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹."; 
            } else if (reason === "MAX_TOKENS") { 
                return botMessage + "\n\n(ØªÙ… Ø§Ø®ØªØµØ§Ø± Ø§Ù„Ø±Ø¯ Ù„Ø£Ù†Ù‡ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø·ÙˆÙ„)"; 
            } else { 
                 console.warn("Ø§Ø³ØªØ¬Ø§Ø¨Ø© ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø±Ù…Ø¬Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ù…Ø¹ finishReason ÙˆÙ„ÙƒÙ† Ø¨Ø¯ÙˆÙ† Ù…Ø­ØªÙˆÙ‰ ÙƒØ§ÙÙ:", reason, data); 
                 return botMessage + (botMessage ? "\n\n" : "") + `Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø±Ø¯ Ù…ÙƒØªÙ…Ù„ (Ø§Ù„Ø³Ø¨Ø¨: ${reason}).`; 
            } 
        } else { 
          console.warn("ØªÙ†Ø³ÙŠÙ‚ Ø§Ø³ØªØ¬Ø§Ø¨Ø© ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø±Ù…Ø¬Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹:", data); 
          return "Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø±Ø¯ ØµØ­ÙŠØ­ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…. Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ø±Ø¯ ØºÙŠØ± ÙƒØ§Ù…Ù„ Ø£Ùˆ Ù‡Ù†Ø§Ùƒ Ù…Ø´ÙƒÙ„Ø©."; 
        } 
      } catch (error) { 
          console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¬Ù„Ø¨:", error); 
          // Ù„Ø§ ØªØ¹Ø±Ø¶ Ù…ÙØªØ§Ø­ API Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
          if (error.message && (error.message.toLowerCase().includes("api key") || error.message.toLowerCase().includes(apiKey.toLowerCase()))) { 
              throw new Error("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù„Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„."); 
          } 
          throw error; 
      } 
    } 

    async function sendMessage() { 
      const messageText = userInput.value.trim(); 
      if (!messageText) return; 

      addMessage("user", messageText); 
      userInput.value = ""; 
      autoResizeTextarea(); 
      searchLog.textContent = `Ø±Ø³Ø§Ù„ØªÙƒ Ø§Ù„Ø£Ø®ÙŠØ±Ø©: ${messageText.substring(0, 60)}${messageText.length > 60 ? '...' : ''}`; 
      
      try { 
        const prompt = generateChatPrompt(messageText); 
        const responseText = await fetchResponse(prompt); 
        addMessage("bot", responseText); 
        setStatus("ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø¯ Ø¨Ù†Ø¬Ø§Ø­! âœ…", "success"); 

        // --- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§ ---
        // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù†Ø§Ø¬Ø­Ø©
        successfulResponseCount++; 
        localStorage.setItem(localStorageKeyAdCounter, successfulResponseCount.toString()); 

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
        if (successfulResponseCount % 3 === 0) { 
            setTimeout(() => { 
                // Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø¨Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
                const adUrl = "https://www.profitableratecpm.com/k8fisnjjc?key=afa7ea920578f74cea5997d670bbe78e"; 
                window.open(adUrl, '_blank'); 
                console.log("ØªÙ… ÙØªØ­ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†. Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ù†Ø§Ø¬Ø­Ø©:", successfulResponseCount);
            }, 5000); // 5000 Ù…ÙŠÙ„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ© = 5 Ø«ÙˆØ§Ù†ÙŠ 
        } 
        
      } catch (error) { 
        console.error("ØªÙØ§ØµÙŠÙ„ Ø®Ø·Ø£ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:", error); 
        let displayError = "Ø¹ÙÙˆÙ‹Ø§ØŒ ÙˆØ§Ø¬Ù‡Øª Ù…Ø´ÙƒÙ„Ø© Ø£Ø«Ù†Ø§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¨Ø­Ø«. ğŸ˜¥"; 
        // Ù„Ø§ ØªØ¹Ø±Ø¶ Ø±Ø³Ø§Ø¦Ù„ Ø®Ø·Ø£ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…ÙØªØ§Ø­ API Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        if (error.message && !error.message.toLowerCase().includes("api key") && !error.message.toLowerCase().includes("api_key") && !error.message.toLowerCase().includes(apiKey.toLowerCase())) { 
            displayError += " Ø§Ù„ØªÙØ§ØµÙŠÙ„: " + error.message; 
        }
        addMessage("bot", displayError); 
        setStatus("ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø¯. âŒ", "error"); 
      } 
    } 

    userInput.addEventListener("keydown", function(event) { 
      if(event.key === "Enter" && !event.shiftKey) { 
        event.preventDefault(); 
        sendMessage(); 
      } 
    }); 
    userInput.addEventListener("input", autoResizeTextarea); 
    
    function autoResizeTextarea() { 
        userInput.style.height = 'auto'; 
        let newHeight = userInput.scrollHeight; 
        const maxHeight = parseInt(getComputedStyle(userInput).maxHeight) || 110; 
        
        if (newHeight > maxHeight) { 
            newHeight = maxHeight; 
            userInput.style.overflowY = 'auto'; 
        } else { 
            userInput.style.overflowY = 'hidden'; 
        } 
        userInput.style.height = newHeight + 'px'; 
    } 
    
    initializeApp(); 
  </script>
</body> 
</html>
