
<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- PWA: Link to Manifest File -->
  <link rel="manifest" href="manifest.json">
  <!-- PWA: Theme color for browser UI -->
  <meta name="theme-color" content="#1a1c24" />
  <!-- PWA: Favicon for the site -->
  <link rel="icon" href="https://i.postimg.cc/nhkF1YqX/Screenshot-680d03679600f7af0b4c700c6b270fe7-2.jpg" type="image/jpeg">

  <!-- Social Share Meta Tags -->
  <title>Saif AI - دردشة ذكاء اصطناعي</title>
  <meta property="og:title" content="Saif AI - دردشة ذكاء اصطناعي" />
  <meta property="og:description" content="مساعد ذكاء اصطناعي عربي متقدم للإجابة على كافة أسئلتك، مع دعم متخصص للمواد الدراسية." />
  <meta property="og:image" content="https://i.postimg.cc/nhkF1YqX/Screenshot-680d03679600f7af0b4c700c6b270fe7-2.jpg" />
  <meta property="og:url" content="https://tinyurl.com/saif-ai" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Saif AI - دردشة ذكاء اصطناعي" />
  <meta name="twitter:description" content="مساعد ذكاء اصطناعي عربي متقدم للإجابة على كافة أسئلتك، مع دعم متخصص للمواد الدراسية." />
  <meta name="twitter:image" content="https://i.postimg.cc/nhkF1YqX/Screenshot-680d03679600f7af0b4c700c6b270fe7-2.jpg" />

  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    :root {
      --primary-hue: 195;
      --secondary-hue: 280;
      
      --primary-color: hsl(var(--primary-hue), 100%, 50%);
      --primary-glow: hsl(var(--primary-hue), 100%, 60%, 0.5);
      --secondary-color: hsl(var(--secondary-hue), 100%, 65%);
      --secondary-glow: hsl(var(--secondary-hue), 100%, 70%, 0.4);

      --bg-main: #101116;
      --bg-glass: rgba(26, 28, 36, 0.7);
      --bg-glass-light: rgba(36, 40, 50, 0.75);
      --bg-input: rgba(16, 17, 22, 0.8);
      
      --text-primary: #f0f4f8;
      --text-secondary: #a0a8b4;
      --text-on-primary: #ffffff;
      
      --border-color: rgba(255, 255, 255, 0.1);
      --border-color-light: rgba(255, 255, 255, 0.2);
      
      --success-color: #00e096;
      --error-color: #ff5274;
      
      --user-message-bg: linear-gradient(135deg, hsl(var(--secondary-hue), 80%, 55%), hsl(var(--secondary-hue), 90%, 65%));
      --bot-message-bg: var(--bg-glass-light);

      --shadow-sm: 0 4px 10px rgba(0,0,0,0.3);
      --shadow-md: 0 8px 20px rgba(0,0,0,0.4);
      --shadow-lg: 0 15px 35px rgba(0,0,0,0.5);
      
      --border-radius-md: 14px;
      --border-radius-lg: 20px;
      --border-radius-xl: 28px;
    }

    * {
      box-sizing: border-box;
      font-family: 'Tajawal', sans-serif;
      margin: 0;
      padding: 0;
      scrollbar-width: thin;
      scrollbar-color: var(--primary-color) transparent;
    }

    *::-webkit-scrollbar { width: 6px; }
    *::-webkit-scrollbar-track { background: transparent; }
    *::-webkit-scrollbar-thumb { background-color: var(--primary-color); border-radius: 6px; }

    html, body {
      height: 100%; 
      font-smooth: antialiased;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow: hidden; 
    }

    body {
      display: flex;
      justify-content: center;
      align-items: center;
      color: var(--text-primary);
      overflow: hidden; 
      padding: 1rem;
      background: var(--bg-main);
      animation: aurora-bg 20s infinite linear;
    }

    @keyframes aurora-bg {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }
    
    body::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background-image: 
          radial-gradient(at 20% 20%, hsla(var(--primary-hue),100%,70%,0.15) 0px, transparent 50%),
          radial-gradient(at 80% 20%, hsla(var(--secondary-hue),100%,70%,0.15) 0px, transparent 50%),
          radial-gradient(at 20% 80%, hsla(var(--secondary-hue),100%,70%,0.2) 0px, transparent 50%),
          radial-gradient(at 80% 80%, hsla(var(--primary-hue),100%,70%,0.2) 0px, transparent 50%);
        z-index: -1;
    }

    .container {
      width: 100%;
      max-width: 800px; 
      height: calc(100vh - 2rem);
      background: var(--bg-glass); 
      border: 1px solid var(--border-color); 
      border-radius: var(--border-radius-xl); 
      display: flex;
      flex-direction: column; 
      overflow: hidden; 
      position: relative; 
      box-shadow: var(--shadow-lg), 0 0 100px rgba(0,0,0,0.5);
      backdrop-filter: blur(20px) saturate(150%);
      -webkit-backdrop-filter: blur(20px) saturate(150%);
    }

    /* --- All new/modified styles below this point --- */

    .download-notification {
      display: flex; align-items: center; justify-content: space-between;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: var(--text-on-primary); text-align: center; font-weight: 500;
      z-index: 100; box-shadow: var(--shadow-md);
      border-bottom: 1px solid var(--border-color); overflow: hidden;
      max-height: 0; padding: 0 20px;
      transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
    }
    .download-notification.show { max-height: 80px; padding: 12px 20px; }
    .notification-buttons { display: flex; align-items: center; gap: 10px; margin-right: auto; padding-right: 20px; }
    .download-btn {
      background-color: rgba(255, 255, 255, 0.95); color: var(--primary-color);
      border: none; padding: 8px 16px; border-radius: var(--border-radius-md);
      cursor: pointer; font-weight: 700; transition: all 0.25s ease;
      white-space: nowrap; font-family: 'Tajawal', sans-serif;
    }
    .download-btn:hover { background-color: #fff; transform: scale(1.05); box-shadow: 0 0 15px rgba(255,255,255,0.3); }
    .close-btn {
      background: none; border: none; color: var(--text-on-primary);
      font-size: 1.8rem; cursor: pointer; padding: 0 5px; line-height: 1;
      opacity: 0.8; transition: all 0.25s ease;
    }
    .close-btn:hover { opacity: 1; transform: rotate(90deg) scale(1.1); }

    .header { 
      background: rgba(36, 40, 50, 0.5);
      backdrop-filter: blur(10px) saturate(120%);
      -webkit-backdrop-filter: blur(10px) saturate(120%);
      color: var(--text-primary); padding: 0.75rem 1rem; 
      display: flex; align-items: center; gap: 0.75rem; 
      border-bottom: 1px solid var(--border-color); box-shadow: var(--shadow-sm);
      flex-shrink: 0; z-index: 10;
    }
    .header .fas.fa-robot { 
      font-size: 1.6rem; color: var(--primary-color);
      text-shadow: 0 0 15px var(--primary-glow);
      animation: pulseIcon 3s infinite ease-in-out;
    }
    @keyframes pulseIcon {
      0%, 100% { transform: scale(1); opacity: 0.9; }
      50% { transform: scale(1.15); opacity: 1; text-shadow: 0 0 25px var(--primary-glow); }
    }
    .header h1 { 
      font-size: 1.2rem; font-weight: 700; color: var(--text-primary);
      text-shadow: 0 1px 3px rgba(0,0,0,0.5);
      margin: 0 auto; text-align: center;
    }
    .header-icon-btn {
      cursor: pointer; transition: all 0.25s ease;
      color: var(--text-secondary); font-size: 1.3rem; z-index: 11; 
      padding: 8px; border-radius: 50%;
    }
    .header-icon-btn:hover {
      color: var(--text-primary);
      background-color: rgba(255,255,255,0.1);
      transform: scale(1.1);
    }
    .header-icon-btn#shareBtn:hover { color: var(--success-color); }
    .header-icon-btn#deleteAllBtn:hover { color: var(--error-color); }

    #subjectControls { display: flex; gap: 0.5rem; }
    .header-btn {
      background-color: rgba(255,255,255,0.05); color: var(--text-secondary);
      border: 1px solid var(--border-color); padding: 0.5rem 1rem; 
      border-radius: var(--border-radius-md); cursor: pointer;
      font-size: 0.8rem; font-weight: 500; transition: all 0.25s ease;
      white-space: nowrap; box-shadow: var(--shadow-sm);
    }
    .header-btn:hover {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: var(--text-on-primary); border-color: transparent;
      transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.3);
    }

    .chat-wrapper, #subjectsViewContainer { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0; }
    #subjectsViewContainer {
      background: transparent; padding: 2rem; display: none; align-items: center; 
    }
    .subjects-view-header {
      width: 100%; display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border-color);
    }
    .subjects-view-header h2 { font-size: 1.8rem; color: var(--primary-color); text-shadow: 0 0 15px var(--primary-glow); }
    .back-to-chat-btn {
      background: transparent; color: var(--text-primary);
      border: 1px solid var(--border-color); padding: 0.8rem 1.5rem;
      border-radius: var(--border-radius-md); cursor: pointer;
      font-size: 0.9rem; font-weight: 500; transition: all 0.25s ease;
      box-shadow: var(--shadow-sm); display: flex; align-items: center; gap: 0.75rem;
    }
    .back-to-chat-btn:hover {
      background-color: var(--primary-color); color: var(--text-on-primary); border-color: var(--primary-color);
      transform: translateY(-2px); box-shadow: 0 0 20px var(--primary-glow);
    }
    #subjectListContainer { 
      display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px; width: 100%; max-width: 800px; overflow-y: auto; padding: 10px;
    }
    .subject-item-btn {
      background: var(--bg-glass-light); backdrop-filter: blur(5px);
      color: var(--text-primary); border: 1px solid var(--border-color);
      padding: 25px; font-size: 1.1rem; font-weight: 500;
      border-radius: var(--border-radius-lg); cursor: pointer;
      transition: all 0.3s ease; text-align: center;
      box-shadow: var(--shadow-sm); display: flex;
      flex-direction: column; align-items: center; gap: 15px; 
      position: relative; overflow: hidden;
    }
    .subject-item-btn::before {
        content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: radial-gradient(circle at 50% 0, var(--primary-glow) 0%, transparent 70%);
        opacity: 0; transition: opacity 0.4s ease; transform: scaleY(1.5);
    }
    .subject-item-btn:hover {
      transform: translateY(-5px); border-color: var(--primary-color);
      box-shadow: 0 10px 25px rgba(0,0,0,0.4), 0 0 20px var(--primary-glow);
    }
    .subject-item-btn:hover::before { opacity: 1; }
    .subject-item-btn i { font-size: 2.5rem; margin-bottom: 5px; color: var(--primary-color); transition: all 0.3s ease; }
    .subject-item-btn:hover i { color: var(--text-on-primary); transform: scale(1.1); text-shadow: 0 0 10px var(--text-on-primary); }
    
    .chat-container { flex: 1; padding: 1.5rem 1rem; overflow-y: auto; background: transparent; scroll-behavior: smooth; min-height: 0; }
    .message {
      margin-bottom: 1.5rem; display: flex; flex-direction: column;
      animation: messageAppear 0.5s cubic-bezier(0.25, 1, 0.5, 1);
    }
    @keyframes messageAppear { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .message-header { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.4rem; display: flex; align-items: center; gap: 8px; font-weight: 500; padding: 0 10px; }
    .delete-btn { color: var(--text-secondary); font-size: 0.85rem; cursor: pointer; transition: all 0.2s; opacity: 0.4; padding: 4px; }
    .delete-btn:hover { opacity: 1; color: var(--error-color); transform: scale(1.2); }
    .message.user { align-items: flex-end; }
    .message.user .message-header { flex-direction: row-reverse; }
    .message.bot { align-items: flex-start; }
    .bubble {
      max-width: 85%; padding: 1rem 1.4rem; border-radius: var(--border-radius-lg);
      word-wrap: break-word; white-space: pre-wrap; line-height: 1.7;
      transition: all 0.3s ease; box-shadow: var(--shadow-sm); position: relative;
      border: 1px solid transparent;
    }
    .message.user .bubble { background: var(--user-message-bg); color: var(--text-on-primary); border-bottom-right-radius: 5px; }
    .message.bot .bubble { background: var(--bot-message-bg); color: var(--text-primary); border-bottom-left-radius: 5px; border-color: var(--border-color); }
    .message:hover .bubble { transform: translateY(-3px); box-shadow: var(--shadow-md); }
    .message-actions { margin-top: 10px; display: flex; gap: 10px; padding: 0 10px; }
    .message-actions button {
      background: rgba(255,255,255,0.08); border: 1px solid var(--border-color);
      cursor: pointer; font-size: 0.9rem; padding: 6px 12px; color: var(--text-secondary);
      transition: all 0.25s ease; border-radius: var(--border-radius-md);
      display: flex; align-items: center; gap: 6px;
    }
    .message-actions button:hover { color: var(--text-on-primary); background-color: var(--primary-color); border-color: var(--primary-color); box-shadow: 0 0 15px var(--primary-glow); transform: translateY(-1px); }
    .message-actions button.liked { color: var(--success-color); border-color: var(--success-color); background: rgba(0, 224, 150, 0.1); }
    .message-actions button.liked:hover { background-color: var(--success-color); color: var(--text-on-primary); box-shadow: 0 0 15px rgba(0, 224, 150, 0.5); }
    .chat-input-area { flex-shrink: 0; background: rgba(36, 40, 50, 0.5); backdrop-filter: blur(10px); border-top: 1px solid var(--border-color); }
    
    .chat-input {
      display: flex; align-items: flex-end; padding: 1rem; gap: 0.75rem; z-index: 5;
    }
    .chat-input textarea {
      flex: 1; padding: 0.9rem 1.2rem; border: 1px solid var(--border-color);
      resize: none; font-size: 1rem; outline: none;
      border-radius: var(--border-radius-xl); background: var(--bg-input);
      color: var(--text-primary); max-height: 150px; line-height: 1.6;
      transition: all 0.25s ease;
    }
    .chat-input textarea::placeholder { color: var(--text-secondary); opacity: 0.7; }
    .chat-input textarea:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px var(--primary-glow), inset 0 0 10px rgba(0,0,0,0.3); }

    .chat-input-btn {
      background: transparent; border: 1px solid var(--border-color);
      color: var(--text-secondary); width: 48px; height: 48px;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-size: 1.2rem; transition: all 0.25s ease;
      flex-shrink: 0;
    }
    .chat-input-btn#sendBtn {
        background: var(--primary-color);
        color: var(--text-on-primary);
        border-color: transparent;
    }
    .chat-input-btn:hover {
      color: var(--text-primary);
      border-color: var(--primary-color);
      transform: scale(1.1);
      box-shadow: 0 0 10px var(--primary-glow);
    }
    .chat-input-btn#sendBtn:hover {
        background: hsl(var(--primary-hue), 100%, 55%);
        box-shadow: 0 0 20px var(--primary-glow);
    }
    .chat-input-btn.recording {
        background: var(--error-color); color: white; border: none;
        animation: pulseRecording 1.5s infinite;
    }
    @keyframes pulseRecording {
      0% { box-shadow: 0 0 0 0 rgba(255, 82, 116, 0.5); }
      70% { box-shadow: 0 0 0 15px rgba(255, 82, 116, 0); }
      100% { box-shadow: 0 0 0 0 rgba(255, 82, 116, 0); }
    }
    
    #imageUpload { display: none; }
    .upload-options-container {
      position: absolute; bottom: calc(100% + 10px); right: 120px;
      background-color: var(--bg-glass-light); border: 1px solid var(--border-color);
      border-radius: var(--border-radius-md); box-shadow: var(--shadow-md);
      display: flex; flex-direction: column; gap: 8px; padding: 10px; z-index: 10;
      opacity: 0; visibility: hidden; transform: translateY(10px);
      transition: all 0.3s ease; backdrop-filter: blur(10px);
    }
    .upload-options-container.active { opacity: 1; visibility: visible; transform: translateY(0); }
    .upload-options-container button {
      background-color: transparent; color: var(--text-secondary);
      border: 1px solid transparent; padding: 10px 14px;
      border-radius: var(--border-radius-md); cursor: pointer;
      display: flex; align-items: center; gap: 10px; font-size: 0.9rem;
      transition: all 0.25s ease;
    }
    .upload-options-container button:hover { background-color: rgba(255,255,255,0.1); color: var(--text-primary); }
    .status {
      text-align: center; padding: 0.5rem; font-size: 0.8rem;
      color: var(--text-secondary); transition: all 0.3s ease;
      font-weight: 500; min-height: 28px;
    }
    .status.success { color: var(--success-color); }
    .status.error { color: var(--error-color); }
    a { color: var(--primary-color); text-decoration: none; font-weight: 500; }
    a:hover { text-decoration: underline; color: hsl(var(--primary-hue), 100%, 65%); }
    .search-log {
      text-align: center; font-size: 0.75rem; color: var(--text-secondary); opacity: 0.6;
      padding: 0.3rem 0; background-color: rgba(0,0,0,0.2);
    }

    /* Modals */
    .camera-modal, .share-modal { 
        display: none; position: fixed; z-index: 1000; left: 0; top: 0;
        width: 100%; height: 100%; overflow: auto;
        background-color: rgba(16, 17, 22, 0.5);
        align-items: center; justify-content: center;
        backdrop-filter: blur(10px) brightness(0.7);
        -webkit-backdrop-filter: blur(10px) brightness(0.7);
        animation: fadeIn 0.4s ease;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .camera-modal-content, .share-modal-content { 
        background-color: var(--bg-glass); border: 1px solid var(--border-color);
        padding: 30px; border-radius: var(--border-radius-xl); text-align: center;
        width: 90%; max-width: 500px; display: flex; flex-direction: column; align-items: center;
        position: relative; box-shadow: var(--shadow-lg);
        animation: slideIn 0.5s cubic-bezier(0.25, 1, 0.5, 1);
    }
    @keyframes slideIn { from { transform: translateY(-40px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }

    #cameraView { width: 100%; max-width: 450px; height: auto; border-radius: var(--border-radius-lg); margin-bottom: 25px; background-color: #000; }
    .camera-controls button {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        border: none; color: var(--text-on-primary); padding: 12px 28px;
        font-size: 1rem; border-radius: var(--border-radius-md); cursor: pointer; margin: 8px;
        transition: all 0.25s ease; font-weight: 500; box-shadow: var(--shadow-sm);
    }
    .camera-controls button:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); filter: brightness(1.1); }
    .camera-controls button#cancelCameraBtn { background: var(--error-color); }
    
    .share-modal-content h2 { color: var(--primary-color); margin-bottom: 15px; font-size: 2rem; text-shadow: 0 0 15px var(--primary-glow); }
    .share-modal-content p { color: var(--text-secondary); font-size: 1rem; margin-bottom: 30px; }
    .share-link-container { display: flex; width: 100%; margin-bottom: 20px; }
    .share-link-container input {
        flex-grow: 1; background-color: var(--bg-input); border: 1px solid var(--border-color);
        color: var(--text-primary); padding: 14px; border-radius: var(--border-radius-md) 0 0 var(--border-radius-md);
        font-size: 1rem; text-align: left; direction: ltr; border-right: none;
    }
    .share-link-container button {
        background: var(--primary-color); border: none; color: var(--text-on-primary);
        padding: 14px 20px; cursor: pointer; border-radius: 0 var(--border-radius-md) var(--border-radius-md) 0;
        font-size: 1rem; font-weight: 500; transition: all 0.25s ease;
        display: flex; align-items: center; gap: 8px;
    }
    .share-link-container button:hover { filter: brightness(1.15); box-shadow: 0 0 15px var(--primary-glow); }
    .close-share-modal {
        color: var(--text-secondary); position: absolute; top: 15px; right: 20px; font-size: 2rem;
        font-weight: bold; cursor: pointer; transition: all 0.3s ease;
    }
    .close-share-modal:hover { color: var(--text-primary); transform: rotate(90deg); }

    .scroll-btn {
      position: absolute; right: 25px; background-color: var(--bg-glass-light);
      border: 1px solid var(--border-color); color: var(--text-primary);
      width: 42px; height: 42px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-size: 1.1rem; box-shadow: var(--shadow-md);
      transition: all 0.3s ease; z-index: 3; opacity: 0;
      visibility: hidden; backdrop-filter: blur(5px);
    }
    .scroll-btn:hover { background-color: var(--primary-color); transform: scale(1.1); border-color: var(--primary-color); box-shadow: 0 0 15px var(--primary-glow); }
    .scroll-btn.visible { opacity: 0.8; visibility: visible; }
    #scrollToBottomBtn { bottom: 100px; }
    #scrollToTopBtn { bottom: 150px; }

    @media (max-width: 768px) {
        body { padding: 0; }
        .container { border-radius: 0; height: 100vh; }
        .bubble { max-width: 90%; }
        #scrollToBottomBtn { bottom: 90px; }
        #scrollToTopBtn { bottom: 140px; }
        .header { padding: 0.5rem 0.75rem; }
        .header h1 { font-size: 1.1rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="downloadNotification" class="download-notification">
      <span id="downloadNotificationText">ثبّت التطبيق على جهازك للوصول السريع!</span>
      <div class="notification-buttons">
          <button id="downloadAppBtn" class="download-btn">تثبيت</button>
          <button id="closeNotificationBtn" class="close-btn">&times;</button>
      </div>
    </div>

    <header class="header">
      <i id="shareBtn" class="fas fa-share-alt header-icon-btn" title="مشاركة التطبيق"></i>
      <i id="deleteAllBtn" class="fas fa-trash-alt header-icon-btn" onclick="deleteAllMessages()" title="حذف كل الرسائل"></i>
      <i class="fas fa-robot"></i>
      <h1 id="botName">Saif AI</h1>
      <div id="subjectControls">
        <button id="enterSubjectsBtn" class="header-btn">مواد متخصصة</button>
        <button id="generalChatBtn" class="header-btn" style="display: none;">عام</button>
      </div>
    </header>

    <div class="chat-wrapper" id="chatWrapper"> 
        <div id="chatContainer" class="chat-container">
          <!-- Messages will be here -->
        </div>

        <button id="scrollToTopBtn" class="scroll-btn" title="الانتقال إلى الأعلى">
          <i class="fas fa-arrow-up"></i>
        </button>
        <button id="scrollToBottomBtn" class="scroll-btn" title="الانتقال إلى الأسفل">
          <i class="fas fa-arrow-down"></i>
        </button>
        
        <div class="chat-input-area"> 
            <div id="searchLog" class="search-log"></div>
            <div class="status" id="statusBar"></div>

            <div class="chat-input">
              <button class="chat-input-btn" id="toggleUploadBtn" title="إرفاق ملف">
                <i class="fas fa-paperclip"></i>
              </button>
              
              <button class="chat-input-btn" id="voiceInputBtn" title="التحدث">
                <i class="fas fa-microphone-alt"></i>
              </button>
              
              <textarea id="userInput" rows="1" placeholder="اكتب رسالتك هنا..."></textarea>
              
              <div class="voice-indicator" id="voiceIndicator" style="display:none;">
                <i class="fas fa-microphone"></i>
                <span>جاري الاستماع...</span>
              </div>
              
              <div class="upload-options-container" id="uploadOptionsContainer">
                <button onclick="triggerImageUpload()">
                  <i class="fas fa-images"></i> رفع من المعرض
                </button>
                <button onclick="openCamera()">
                  <i class="fas fa-camera"></i> استخدام الكاميرا
                </button>
              </div>
              
              <button id="sendBtn" class="chat-input-btn" onclick="sendMessage()" title="إرسال">
                <i class="fas fa-paper-plane"></i>
              </button>
              <input id="imageUpload" type="file" accept="image/*" onchange="handleFileSelect(event)" />
            </div>
        </div>
    </div>

    <div id="subjectsViewContainer"> 
        <div class="subjects-view-header">
            <h2>اختر المادة الدراسية</h2>
            <button id="backToChatBtn" class="back-to-chat-btn">
                <i class="fas fa-arrow-left"></i> العودة للدردشة
            </button>
        </div>
        <div id="subjectListContainer">
            <!-- Subject items will be populated here by JS -->
        </div>
    </div>
  </div>

  <!-- Camera Modal -->
  <div id="cameraModal" class="camera-modal">
    <div class="camera-modal-content">
      <video id="cameraView" autoplay playsinline></video>
      <div class="camera-controls">
        <button id="captureBtn">التقاط صورة</button>
        <button id="cancelCameraBtn">إلغاء</button>
      </div>
    </div>
  </div>

  <!-- Share Modal -->
  <div id="shareModal" class="share-modal">
    <div class="share-modal-content">
      <span class="close-share-modal" id="closeShareModal">&times;</span>
      <h2>مشاركة التطبيق</h2>
      <p>شارك الرابط مع أصدقائك لدعمنا!</p>
      <div class="share-link-container">
        <input type="text" value="https://tinyurl.com/saif-ai" id="shareLinkInput" readonly>
        <button id="copyLinkBtn"><i class="fas fa-copy"></i> نسخ</button>
      </div>
      <p class="support-message" style="color:var(--success-color); font-weight:bold;">ارجو دعمنا للاستمرار</p>
    </div>
  </div>

  <script>
    // THE JAVASCRIPT IS IDENTICAL TO THE ORIGINAL.
    // NO CHANGES HAVE BEEN MADE TO THIS SCRIPT BLOCK.
    const geminiApiKey = "AIzaSyBUqzhaui0pz0PqhCsVEpQYfOHsCYKtPBk"; 
    const ocrApiKey = "K83201031288957";     

    const chatWrapper = document.getElementById("chatWrapper");
    const chatContainer = document.getElementById("chatContainer");
    const statusBar = document.getElementById("statusBar");
    const searchLog = document.getElementById("searchLog");
    const userInput = document.getElementById("userInput");
    const botNameElement = document.getElementById("botName");
    const imageUploadInput = document.getElementById("imageUpload");
    const toggleUploadBtn = document.getElementById("toggleUploadBtn");
    const uploadOptionsContainer = document.getElementById("uploadOptionsContainer");
    const scrollToTopBtn = document.getElementById('scrollToTopBtn');
    const scrollToBottomBtn = document.getElementById('scrollToBottomBtn');
    const voiceInputBtn = document.getElementById('voiceInputBtn');
    const voiceIndicator = document.getElementById('voiceIndicator');
    
    const subjectsViewContainer = document.getElementById('subjectsViewContainer');
    const subjectListContainer = document.getElementById('subjectListContainer'); 
    const backToChatBtn = document.getElementById('backToChatBtn');


    const cameraModal = document.getElementById('cameraModal');
    const cameraView = document.getElementById('cameraView');
    const captureBtn = document.getElementById('captureBtn');
    const cancelCameraBtn = document.getElementById('cancelCameraBtn');
    let cameraStream = null;

    const enterSubjectsBtn = document.getElementById('enterSubjectsBtn');
    const generalChatBtn = document.getElementById('generalChatBtn');
    
    // Share Modal Elements
    const shareBtn = document.getElementById('shareBtn');
    const shareModal = document.getElementById('shareModal');
    const closeShareModalBtn = document.getElementById('closeShareModal');
    const copyLinkBtn = document.getElementById('copyLinkBtn');
    const shareLinkInput = document.getElementById('shareLinkInput');
    
    // Notification Bar Elements
    const downloadNotification = document.getElementById('downloadNotification');
    const downloadNotificationText = document.getElementById('downloadNotificationText');
    const downloadAppBtn = document.getElementById('downloadAppBtn');
    const closeNotificationBtn = document.getElementById('closeNotificationBtn');
    
    const botName = "سيف AI";
    const localStorageKeyAllChats = "saifAiAllChatsHistory_v2"; 
    const localStorageKeyAdCounter = "saifAiAdCounter";
    const localStorageKeyImageUploadDate = "saifAiImageUploadDate";
    const localStorageKeyImageUploadCount = "saifAiImageUploadCount";
    const localStorageKeyCurrentSubject = "saifAiCurrentSubject_v2";


    const AD_URL = "https://www.profitableratecpm.com/k8fisnjjc?key=afa7ea920578f74cea5997d670bbe78e";
    const AD_DELAY_MS = 10000; 

    let allMessages = {}; 
    let messages = [];    
    
    let successfulResponseCount = 0;
    let userMessageCounterForAds = 0;
    let statusTimeout;
    
    let currentSubject = "general"; 
    const subjects = [ 
        { name: "فيزياء", icon: "fas fa-atom" },
        { name: "كيمياء", icon: "fas fa-flask" },
        { name: "أحياء", icon: "fas fa-dna" },
        { name: "علوم", icon: "fas fa-microscope" },
        { name: "لغة عربية", icon: "fas fa-pen-nib" },
        { name: "فلسفة", icon: "fas fa-brain" },
        { name: "لغة إنجليزية", icon: "fas fa-language" },
        { name: "رياضيات", icon: "fas fa-calculator" },
        { name: "تربية دينية", icon: "fas fa-mosque" }
    ];
    
    let recognition;
    let isListening = false;
    let deferredPrompt; // PWA: For storing the install prompt event

    // --- Notification Functions ---
    function showAppNotification() {
      // This function will now always show the install prompt message
      downloadNotificationText.textContent = "ثبّت التطبيق على جهازك للوصول السريع!";
      downloadAppBtn.textContent = "تثبيت";
      downloadNotification.classList.add('show');
    }

    function hideAppNotification() {
      downloadNotification.classList.remove('show');
    }
    // --- END: Notification Functions ---

    function initSpeechRecognition() {
        if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'ar-SA';

            recognition.onstart = function() {
                isListening = true;
                voiceInputBtn.classList.add('recording');
                voiceIndicator.classList.add('active');
                setStatus("جاري الاستماع...", "", null);
            };

            recognition.onresult = function(event) {
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        transcript += event.results[i][0].transcript;
                    } else {
                        transcript += event.results[i][0].transcript;
                    }
                }
                userInput.value = transcript;
                autoResizeTextarea();
            };

            recognition.onerror = function(event) {
                console.error('Speech recognition error', event.error);
                let userMessage = "حدث خطأ في التعرف على الصوت: ";
                switch (event.error) {
                    case 'no-speech': userMessage += "لم يتم اكتشاف أي كلام."; break;
                    case 'audio-capture': userMessage += "مشكلة في التقاط الصوت."; break;
                    case 'not-allowed': userMessage += "لم يتم منح الإذن للميكروفون."; break;
                    case 'network': userMessage += "مشكلة في الشبكة."; break;
                    default: userMessage += event.error;
                }
                setStatus(userMessage, "error", 4000);
                stopListening();
            };

            recognition.onend = function() { stopListening(); };
        } else {
            voiceInputBtn.style.display = 'none'; 
            setStatus("المتصفح لا يدعم التعرف على الصوت", "error", 3000);
        }
    }
    
    function toggleListening() {
        if (!recognition) { setStatus("ميزة التعرف على الصوت غير متاحة.", "error", 3000); return; }
        if (isListening) { recognition.stop(); } 
        else {
            try {
                userInput.value = ""; autoResizeTextarea(); recognition.start();
            } catch (e) {
                console.error("Error starting speech recognition:", e);
                setStatus("لا يمكن بدء التعرف على الصوت.", "error", 3000); stopListening(); 
            }
        }
    }
    
    function stopListening() {
        isListening = false;
        voiceInputBtn.classList.remove('recording');
        voiceIndicator.classList.remove('active');
        if (statusBar.textContent === "جاري الاستماع...") { setStatus("", "", 100); }
    }
    
    function registerServiceWorker() {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            console.log('Service Worker registered with scope:', registration.scope);
          })
          .catch((error) => {
            console.error('Service Worker registration failed:', error);
          });
      }
    }

    function initializeApp() {
        registerServiceWorker(); 
    
        const storedAdCount = localStorage.getItem(localStorageKeyAdCounter);
        if (storedAdCount) { successfulResponseCount = parseInt(storedAdCount, 10) || 0; }

        loadAllMessagesAndSetCurrent(); 

        const storedSubject = localStorage.getItem(localStorageKeyCurrentSubject);
        if (storedSubject && (subjects.find(s => s.name === storedSubject) || storedSubject === "general")) {
            currentSubject = storedSubject;
        } else { currentSubject = "general"; }
        
        if (!allMessages[currentSubject]) { allMessages[currentSubject] = []; }
        messages = allMessages[currentSubject];

        updateSubjectUI(); 
        botNameElement.textContent = getBotDisplayName(); 

        addWelcomeMessage(); 
        refreshChat();
        autoResizeTextarea();

        toggleUploadBtn.addEventListener('click', (e) => {
            e.stopPropagation(); uploadOptionsContainer.classList.toggle('active');
        });

        document.addEventListener('click', (e) => {
            const isClickInsideSubjectsView = subjectsViewContainer.contains(e.target);
            const isClickOnEnterSubjectsBtn = e.target === enterSubjectsBtn;
            const isClickOnBackToChatBtn = e.target === backToChatBtn || backToChatBtn.contains(e.target);

            if (!uploadOptionsContainer.contains(e.target) && !toggleUploadBtn.contains(e.target) &&
                !isClickInsideSubjectsView && !isClickOnEnterSubjectsBtn && !isClickOnBackToChatBtn) { 
                uploadOptionsContainer.classList.remove('active');
            }
        });

        captureBtn.addEventListener('click', captureImageFromCamera);
        cancelCameraBtn.addEventListener('click', closeCamera);

        scrollToTopBtn.addEventListener('click', () => chatContainer.scrollTo({ top: 0, behavior: 'smooth' }));
        scrollToBottomBtn.addEventListener('click', () => chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' }));

        chatContainer.addEventListener('scroll', handleChatScroll);
        handleChatScroll(); 

        enterSubjectsBtn.addEventListener('click', openSubjectsView);
        backToChatBtn.addEventListener('click', closeSubjectsView);
        generalChatBtn.addEventListener('click', switchToGeneralMode);
        populateSubjectListInView(); 
        
        initSpeechRecognition();
        voiceInputBtn.addEventListener('click', toggleListening);

        shareBtn.addEventListener('click', () => {
            shareModal.style.display = 'flex';
        });

        closeShareModalBtn.addEventListener('click', () => {
            shareModal.style.display = 'none';
        });

        copyLinkBtn.addEventListener('click', () => {
            shareLinkInput.select();
            shareLinkInput.setSelectionRange(0, 99999);
            
            navigator.clipboard.writeText(shareLinkInput.value).then(() => {
                const originalText = copyLinkBtn.innerHTML;
                copyLinkBtn.innerHTML = '<i class="fas fa-check"></i> تم النسخ';
                setTimeout(() => {
                    copyLinkBtn.innerHTML = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                setStatus("فشل نسخ الرابط. يرجى نسخه يدوياً.", "error", 2500);
            });
        });
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showAppNotification();
        });
        
        window.addEventListener('appinstalled', () => {
          console.log('PWA was installed');
          deferredPrompt = null;
          hideAppNotification();
        });


        window.addEventListener('click', (event) => {
            if (event.target == shareModal) {
                shareModal.style.display = 'none';
            }
            if (event.target == cameraModal) {
                closeCamera();
            }
        });
        
        downloadAppBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            if (deferredPrompt) {
                hideAppNotification();
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response to the install prompt: ${outcome}`);
                deferredPrompt = null;
            }
        });
        
        closeNotificationBtn.addEventListener('click', hideAppNotification);
    }

    function handleChatScroll() {
        if (chatWrapper.style.display === 'none') {
            scrollToTopBtn.classList.remove('visible');
            scrollToBottomBtn.classList.remove('visible');
            return;
        }
        const scrollTop = chatContainer.scrollTop;
        const scrollHeight = chatContainer.scrollHeight;
        const clientHeight = chatContainer.clientHeight;
        const scrollThreshold = 150; 

        scrollToTopBtn.classList.toggle('visible', scrollTop > scrollThreshold);
        scrollToBottomBtn.classList.toggle('visible', scrollHeight > clientHeight && scrollHeight - scrollTop - clientHeight > scrollThreshold);
    }
    
    function openSubjectsView() {
        chatWrapper.style.display = 'none';
        subjectsViewContainer.style.display = 'flex'; 
        handleChatScroll(); 
    }

    function closeSubjectsView() {
        subjectsViewContainer.style.display = 'none';
        chatWrapper.style.display = 'flex'; 
        handleChatScroll(); 
    }


    function getBotDisplayName() {
        if (currentSubject === "general") { return botName; }
        return `${botName} (${currentSubject})`;
    }
    
    function updateSubjectUI() {
        botNameElement.textContent = getBotDisplayName();
        if (currentSubject === "general") {
            generalChatBtn.style.display = 'none';
            enterSubjectsBtn.textContent = "مواد متخصصة";
        } else {
            generalChatBtn.style.display = 'inline-block'; 
            enterSubjectsBtn.textContent = `مادة: ${currentSubject}`;
        }
        localStorage.setItem(localStorageKeyCurrentSubject, currentSubject);
    }

    function populateSubjectListInView() { 
        subjectListContainer.innerHTML = '';
        subjects.forEach(subjectData => {
            const btn = document.createElement('button');
            btn.className = 'subject-item-btn';
            
            const icon = document.createElement('i');
            icon.className = subjectData.icon; 
            
            const textSpan = document.createElement('span');
            textSpan.textContent = subjectData.name;
            
            btn.appendChild(icon);
            btn.appendChild(textSpan);

            btn.onclick = () => selectSubject(subjectData.name);
            subjectListContainer.appendChild(btn);
        });
    }

    function selectSubject(subjectName) {
        if (currentSubject === subjectName && subjectsViewContainer.style.display === 'flex') {
            closeSubjectsView();
            return;
        }

        allMessages[currentSubject] = messages; 
        currentSubject = subjectName;
        messages = allMessages[currentSubject] || []; 
        if (!allMessages[currentSubject]) { allMessages[currentSubject] = []; }

        updateSubjectUI();
        closeSubjectsView(); 
        addWelcomeMessage(); 
        refreshChat(); 
        setStatus(`تم التحويل إلى وضع مادة: ${currentSubject}`, "success", 3000);
        saveAllMessagesToLocalStorage(); 
    }

    function switchToGeneralMode() {
        if (currentSubject === "general") {
            if(subjectsViewContainer.style.display === 'flex') closeSubjectsView();
            return;
        }

        allMessages[currentSubject] = messages; 
        currentSubject = "general";
        messages = allMessages[currentSubject] || []; 
        if (!allMessages[currentSubject]) { allMessages[currentSubject] = []; }

        updateSubjectUI();
        if(subjectsViewContainer.style.display === 'flex') closeSubjectsView();
        addWelcomeMessage(); 
        refreshChat(); 
        setStatus("تم الرجوع إلى الوضع العام", "success", 3000);
        saveAllMessagesToLocalStorage();
    }


    function loadAllMessagesAndSetCurrent() {
        const storedAllMessages = localStorage.getItem(localStorageKeyAllChats);
        if (storedAllMessages) {
            try {
                const parsed = JSON.parse(storedAllMessages);
                if (typeof parsed === 'object' && parsed !== null) {
                    allMessages = parsed;
                    for (const subjectKey in allMessages) {
                        if (Object.hasOwnProperty.call(allMessages, subjectKey) && Array.isArray(allMessages[subjectKey])) {
                            allMessages[subjectKey] = allMessages[subjectKey].map(msg => ({
                                ...msg, timestamp: new Date(msg.timestamp) 
                            }));
                        } else { allMessages[subjectKey] = []; }
                    }
                } else { allMessages = {}; }
            } catch (e) {
                console.error("خطأ في تحليل الرسائل:", e); allMessages = {}; 
                localStorage.removeItem(localStorageKeyAllChats); 
            }
        } else { allMessages = {}; }
        if (!allMessages["general"] || !Array.isArray(allMessages["general"])) {
            allMessages["general"] = [];
        }
    }

    function saveAllMessagesToLocalStorage() {
        if (currentSubject && messages) { allMessages[currentSubject] = messages; }
        localStorage.setItem(localStorageKeyAllChats, JSON.stringify(allMessages));
    }

    function addWelcomeMessage() {
        let welcomeMsgText = `مرحباً بك! أنا ${getBotDisplayName()}، كيف يمكنني مساعدتك اليوم؟ 💡 يمكنك رفع صورتين يوميًا وسأحاول استخلاص النص منها وإرساله للتحليل.`;
        if (currentSubject !== "general") {
             welcomeMsgText = `مرحباً! أنا ${getBotDisplayName()}. حاليًا في وضع الإجابة عن أسئلة مادة ${currentSubject} بناءً على المنهج الدراسي. كيف يمكنني مساعدتك ضمن هذا الإطار؟`;
        }
      
        if (!messages.some(m => m.isInitialWelcome && m.sender === "bot")) {
            messages = messages.filter(m => !m.isInitialWelcome); 
            const welcomeMessageObject = {
                sender: "bot", text: welcomeMsgText, isImage: false,
                isSystemMessage: true, timestamp: new Date(), isInitialWelcome: true
            };
            messages.unshift(welcomeMessageObject); 
            allMessages[currentSubject] = messages; 
            saveAllMessagesToLocalStorage(); 
        } else {
            const welcomeIndex = messages.findIndex(m => m.isInitialWelcome && m.sender === "bot");
            if (welcomeIndex !== -1 && messages[welcomeIndex].text !== welcomeMsgText) {
                messages[welcomeIndex].text = welcomeMsgText;
                allMessages[currentSubject] = messages; saveAllMessagesToLocalStorage();
            }
        }
    }

    function addMessage(sender, text, isImage = false, isSystemMessage = false, isInitialWelcome = false) {
      const message = { sender, text, isImage, isSystemMessage, timestamp: new Date(), isInitialWelcome };
      messages.push(message);
      allMessages[currentSubject] = messages; 
      const wasNearBottom = chatContainer.scrollHeight - chatContainer.scrollTop - chatContainer.clientHeight < 150;
      refreshChat(); 
      if (sender === 'user' || (isInitialWelcome && messages.length <= 2) || (wasNearBottom && !isImage)) {
          chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
      }
    }

    function linkifyAndFormatText(text) {
      if (typeof text !== 'string') return '';
      const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
      const linkedText = text.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
      return linkedText.replace(/\n/g, '<br>');
    }

    function refreshChat() {
      chatContainer.innerHTML = ""; 
      messages.forEach((msg, index) => {
        const messageElem = document.createElement("div");
        messageElem.classList.add("message", msg.sender);
        const header = document.createElement("div");
        header.classList.add("message-header");
        let senderName = msg.sender === "bot" ? getBotDisplayName() : "أنت";
        if (msg.sender === "bot" && msg.isSystemMessage && !msg.isInitialWelcome) {
            senderName = `${getBotDisplayName()} (نظام)`;
        }
        header.innerHTML = `<span>${senderName}</span>`;
        const deleteBtn = document.createElement("i");
        deleteBtn.className = "fas fa-trash delete-btn";
        deleteBtn.title = "حذف الرسالة";
        deleteBtn.onclick = () => deleteMessage(index); 
        header.appendChild(deleteBtn);
        messageElem.appendChild(header);
        const bubble = document.createElement("div");
        bubble.classList.add("bubble");

        if(msg.isImage) {
          const img = document.createElement("img");
          img.src = msg.text;
          img.style.maxWidth = "100%"; img.style.maxHeight = "300px"; 
          img.style.borderRadius = "var(--border-radius-sm)"; img.alt = "صورة مرسلة";
          img.onload = () => {
              if (index === messages.length - 1 || chatContainer.scrollHeight - chatContainer.scrollTop - chatContainer.clientHeight < 350) {
                  chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
              }
          }
          img.onerror = () => { bubble.textContent = "فشل تحميل الصورة"; }
          bubble.appendChild(img);
        } else {
          const originalText = msg.text; 
          const characterLimit = 250; 
          if (msg.sender === "bot" && !msg.isSystemMessage && !msg.isInitialWelcome && originalText.length > characterLimit) {
            const shortText = originalText.substring(0, characterLimit) + "...";
            const contentContainer = document.createElement('div');
            const textSpan = document.createElement('span');
            textSpan.innerHTML = linkifyAndFormatText(shortText);
            contentContainer.appendChild(textSpan);
            const toggleButton = document.createElement('button');
            toggleButton.textContent = "المزيد"; toggleButton.className = "toggle-details-btn";
            toggleButton.dataset.expanded = "false";
            toggleButton.onclick = function() {
              const isExpanded = toggleButton.dataset.expanded === "true";
              textSpan.innerHTML = linkifyAndFormatText(isExpanded ? shortText : originalText);
              toggleButton.textContent = isExpanded ? "المزيد" : "أقل";
              toggleButton.dataset.expanded = (!isExpanded).toString();
            };
            contentContainer.appendChild(toggleButton); bubble.appendChild(contentContainer);
          } else { bubble.innerHTML = linkifyAndFormatText(originalText); }
        }
        messageElem.appendChild(bubble);
        
        if(msg.sender === "bot" && !msg.isImage && !msg.isSystemMessage && !msg.isInitialWelcome) {
            let actionsDiv = document.createElement("div");
            actionsDiv.classList.add("message-actions");
            messageElem.appendChild(actionsDiv);
            const likeBtn = document.createElement("button");
            likeBtn.innerHTML = '<i class="fas fa-thumbs-up"></i>'; likeBtn.title = "إعجاب";
            likeBtn.addEventListener("click", (e) => e.currentTarget.classList.toggle("liked"));
            actionsDiv.appendChild(likeBtn); 
            const copyBtn = document.createElement("button");
            copyBtn.innerHTML = '<i class="fas fa-copy"></i>'; copyBtn.title = "نسخ";
            copyBtn.addEventListener("click", () => {
              navigator.clipboard.writeText(msg.text) 
              .then(() => setStatus("تم النسخ 👍", "success", 1500))
              .catch(err => setStatus("فشل النسخ", "error", 2000));
            });
            actionsDiv.appendChild(copyBtn); 
            if (index > 0 && messages[index - 1]?.sender === 'user') {
              const retryBtn = document.createElement("button");
              retryBtn.innerHTML = '<i class="fas fa-redo"></i>'; retryBtn.title = "إعادة";
              retryBtn.classList.add("retry-btn"); 
              retryBtn.onclick = () => retryQuery(index); 
              actionsDiv.appendChild(retryBtn); 
            }
        }
        chatContainer.appendChild(messageElem);
      });
      saveAllMessagesToLocalStorage(); autoResizeTextarea(); handleChatScroll(); 
    }

    async function retryQuery(botMessageIndex) {
        if (botMessageIndex > 0 && messages[botMessageIndex - 1]?.sender === 'user') {
            const originalUserQuery = messages[botMessageIndex - 1].text;
            if (originalUserQuery) {
                setStatus(`إعادة: "${originalUserQuery.substring(0, 30)}..."`, "", null);
                await processQueryWithAI(originalUserQuery);
            } else { setStatus("لم يتم العثور على السؤال الأصلي.", "error", 2000); }
        } else { setStatus("خطأ: لم يتمكن من تحديد السؤال الأصلي.", "error", 3000); }
    }

    function deleteMessage(index) {
      const isWelcome = messages[index].isInitialWelcome;
      messages.splice(index, 1); 
      allMessages[currentSubject] = messages; 
      if (isWelcome && !messages.some(m => m.isInitialWelcome && m.sender === 'bot')) { addWelcomeMessage(); }
      refreshChat(); setStatus("تم حذف الرسالة.", "success", 1500);
    }

    function deleteAllMessages() {
      const nonWelcomeMessages = messages.filter(m => !m.isInitialWelcome);
      if (nonWelcomeMessages.length === 0) { setStatus("لا يوجد رسائل للحذف.", "", 1500); return; }
      if (confirm("هل أنت متأكد من حذف جميع الرسائل في هذه الدردشة؟")) {
        messages = messages.filter(m => m.isInitialWelcome); 
        allMessages[currentSubject] = messages; 
        addWelcomeMessage(); 
        refreshChat(); setStatus("تم حذف جميع الرسائل بنجاح.", "success", 2000);
      }
    }
    
    function setStatus(message, type = "", duration = 3000) {
      clearTimeout(statusTimeout);
      statusBar.textContent = message; statusBar.className = "status " + type; 
      if (message && duration !== null) {
        statusTimeout = setTimeout(() => { statusBar.textContent = ""; statusBar.className = "status"; }, duration);
      } else if (!message) { statusBar.textContent = ""; statusBar.className = "status"; }
    }

    function triggerImageUpload() {
        uploadOptionsContainer.classList.remove('active'); imageUploadInput.click();
    }

    function handleFileSelect(event) {
        if (event.target.type === 'file' && event.target.files?.[0]) {
            processAndUploadImageFile(event.target.files[0]); event.target.value = ""; 
        }
    }
    
    async function processAndUploadImageFile(file) {
        if (!checkImageUploadLimit()) return;
        setTimeout(() => { window.open(AD_URL, '_blank'); }, AD_DELAY_MS); 
        if (file.size > 5 * 1024 * 1024) { setStatus("حجم الصورة كبير (الحد 5 ميجا).", "error", 3000); return; }
        const reader = new FileReader();
        reader.onload = (e) => { addMessage("user", e.target.result, true); extractTextFromImageAndProcess(file); }
        reader.readAsDataURL(file);
        incrementImageUploadCount();
    }

    function checkImageUploadLimit() {
        const today = new Date().toISOString().split('T')[0];
        const lastUploadDate = localStorage.getItem(localStorageKeyImageUploadDate);
        let uploadCount = parseInt(localStorage.getItem(localStorageKeyImageUploadCount) || "0");
        if (lastUploadDate === today && uploadCount >= 2) {
            setStatus("تعديت حد الصور اليومي (2).", "error", 4000);
            addMessage("bot", "عفواً، استنفدت حصة رفع الصور اليومية.", false, true); return false;
        } else if (lastUploadDate !== today) {
            localStorage.setItem(localStorageKeyImageUploadDate, today);
            localStorage.setItem(localStorageKeyImageUploadCount, "0"); uploadCount = 0;
        }
        return true;
    }

    function incrementImageUploadCount() {
        localStorage.setItem(localStorageKeyImageUploadDate, new Date().toISOString().split('T')[0]); 
        let currentCount = parseInt(localStorage.getItem(localStorageKeyImageUploadCount) || "0");
        localStorage.setItem(localStorageKeyImageUploadCount, (currentCount + 1).toString());
    }

    async function extractTextFromImageAndProcess(file) {
        if (!ocrApiKey) { 
             addMessage("bot", "ميزة OCR غير مفعلة. (مفتاح مفقود)", false, true);
             setStatus("مفتاح OCR غير مكوّن.", "error", 5000); return;
        }
        setStatus(`جاري معالجة الصورة واستخلاص النص...`, "", null); 
        const formData = new FormData();
        formData.append('apikey', ocrApiKey); formData.append('language', 'ara'); 
        formData.append('isOverlayRequired', 'false'); formData.append('file', file);
        try {
            const ocrResponse = await fetch('https://api.ocr.space/parse/image', { method: 'POST', body: formData });
            if (!ocrResponse.ok) {
                const err = await ocrResponse.json().catch(() => ({}));
                throw new Error(`فشل OCR: ${err.ErrorMessage || ocrResponse.statusText}`);
            }
            const ocrData = await ocrResponse.json();
            if (ocrData.IsErroredOnProcessing) throw new Error(`خطأ معالجة OCR: ${ocrData.ErrorMessage.join(', ')}`);
            if (ocrData.ParsedResults?.[0]?.ParsedText.trim()) {
                const extractedText = ocrData.ParsedResults[0].ParsedText.trim();
                addMessage("bot", `النص من الصورة:\n"${extractedText}"`, false, true); 
                setStatus("تم استخلاص النص، جاري التحليل...", "success", 2500);
                await processQueryWithAI(extractedText); 
            } else {
                addMessage("bot", "لم يتم العثور على نص واضح في الصورة.", false, true);
                setStatus("لم يتم استخلاص نص.", "error", 3000);
            }
        } catch (error) {
            console.error("خطأ OCR:", error);
            addMessage("bot", `خطأ استخلاص النص: ${error.message}`, false, true);
            setStatus("فشل استخلاص النص.", "error", 4000);
        }
    }
    
    function generateChatPrompt(userMessage) {
      const maxHistoryMessages = 8; let relevantHistory = "";
      const textMessages = messages.filter(m => !m.isImage && !(m.sender==='bot' && m.isSystemMessage && !m.isInitialWelcome && !m.text.includes("تم تفعيل وضع مادة") && !m.text.includes("تم الرجوع إلى وضع الدردشة العام")));
      let currentBotDisplayName = getBotDisplayName();
      let baseSystemPrompt = `أنت ${currentBotDisplayName}، مساعد ذكاء اصطناعي ودود، صادق، إيجابي، وذكي جداً. هدفك هو مساعدة المستخدم والإجابة على أسئلته بوضوح وبطريقة تفاعلية ومفصلة. تجنب الردود المقتضبة جداً وحاول أن تكون محادثتك جذابة. إذا لم تعرف الإجابة، اعترف بذلك بلطف وحاول تقديم المساعدة إن أمكن. استخدم بعض الرموز التعبيرية بشكل مناسب ولكن باعتدال. إذا سألك المستخدم "من صنعك" أو "مين عملك" أو "من هو مطورك" أو أي سؤال مشابه، يجب أن تكون إجابتك دائمًا "أنا من صنع وتطوير سيف هاني".\n\n`;
      let finalSystemPrompt = baseSystemPrompt;
      if (currentSubject && currentSubject !== "general") {
          const subjectInstruction = `أنت الآن في وضع خبير مادة "${currentSubject}". جميع إجاباتك يجب أن تستند بشكل صارم وحصري إلى المنهج الدراسي المعتمد لمادة "${currentSubject}" في السياق التعليمي المصري إن أمكن، ما لم يحدد المستخدم خلاف ذلك. لا تقدم أي معلومات أو آراء خارج هذا النطاق المحدد. إذا كان السؤال لا يتعلق مباشرة بمنهج "${currentSubject}"، يجب عليك أن توضح أن السؤال خارج نطاق تخصص المادة الحالي وأنك تستطيع فقط الإجابة على الأسئلة المتعلقة بمنهج "${currentSubject}". لقد تم إعلام المستخدم بأن "الإجابات ستكون من المنهج الدراسي فقط". حافظ على تركيزك الكامل على مادة "${currentSubject}". ابدأ ردودك المتعلقة بالمادة بتأكيد أنك تجيب ضمن نطاق المادة.\n\n`;
          finalSystemPrompt = subjectInstruction + baseSystemPrompt; 
      }
      const startIndex = Math.max(0, textMessages.length - maxHistoryMessages);
      for (let i = startIndex; i < textMessages.length; i++) {
        const msg = textMessages[i];
        if (msg.sender === "bot" && msg.isInitialWelcome && msg.text.includes("كيف يمكنني مساعدتك اليوم؟")) continue;
        relevantHistory += (msg.sender === "user" ? "المستخدم: " : (currentBotDisplayName + (msg.isSystemMessage && !msg.isInitialWelcome ? " (نظام)" : "") +": ")) + msg.text + "\n";
      }
      return `${finalSystemPrompt}${relevantHistory}المستخدم: ${userMessage}\n${currentBotDisplayName}:`;
    }

    async function fetchGeminiResponse(prompt) {
      if (!geminiApiKey) { throw new Error("عفواً، خدمة AI غير مكوّنة. (مفتاح Gemini مفقود)"); }
      const requestBody = { contents: [{ parts: [{ text: prompt }] }] };
      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiApiKey}`, {
          method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(requestBody)
        });
        if(!response.ok) {
          const errorData = await response.json().catch(() => ({})); 
          let errMsg = `خطأ ${response.status}: ${response.statusText}.`;
          if (response.statusText?.toLowerCase().includes("failed to fetch")) { throw new Error("Failed to fetch"); }
          if (errorData.error?.message) {
             errMsg += errorData.error.message.toLowerCase().includes("api key") || errorData.error.message.toLowerCase().includes("permission") ? " خطأ في إعدادات الطلب أو صلاحيات Gemini." : ` التفاصيل: ${errorData.error.message.substring(0, 200)}`;
          }
          throw new Error(errMsg);
        }
        const data = await response.json();
        if (data.candidates?.[0]?.content?.parts?.[0]?.text) return data.candidates[0].content.parts[0].text;
        if (data.promptFeedback?.blockReason) return `لم أتمكن من معالجة طلبك بسبب سياسات Gemini (السبب: ${data.promptFeedback.blockReason}).`;
        if (data.candidates?.[0]?.finishReason) {
            let botMsg = (data.candidates[0].content?.parts?.[0]?.text || ""); 
            const reason = data.candidates[0].finishReason;
            if (reason === "SAFETY") return botMsg + (botMsg ? "\n\n" : "") + "لم أتمكن من إكمال الرد بسبب قيود السلامة من Gemini.";
            if (reason === "MAX_TOKENS") return botMsg + (botMsg ? "\n\n" : "") + "(تم اختصار الرد لتجاوز الحد الأقصى للطول)";
            return botMsg + (botMsg ? "\n\n" : "") + `لم يتم استلام رد مكتمل (السبب: ${reason}).`;
        }
        return "لم يتم استلام رد بالتنسيق الصحيح من Gemini.";
      } catch (error) {
          if (error.message?.toLowerCase().includes("api key") || (geminiApiKey && error.message?.toLowerCase().includes(geminiApiKey.toLowerCase()))) {
              throw new Error("خطأ أثناء الاتصال بـ Gemini. تحقق من وحدة التحكم.");
          }
          throw error; 
      }
    }

    async function processQueryWithAI(queryText) {
        if (!queryText?.trim()) return;
        searchLog.textContent = `بحث: ${queryText.substring(0, 60)}${queryText.length > 60 ? '...' : ''}`;
        setStatus(`${getBotDisplayName()} يفكر: "${queryText.substring(0,30)}..."`, "", null); 
        try {
            const responseText = await fetchGeminiResponse(generateChatPrompt(queryText));
            addMessage("bot", responseText);
            setStatus("تم استلام الرد! ✅", "success"); 
            successfulResponseCount++;
            localStorage.setItem(localStorageKeyAdCounter, successfulResponseCount.toString());
        } catch (error) {
            console.error("فشل إرسال لـ Gemini:", error);
            let displayError = "عفواً، واجهت مشكلة مع Gemini. 😥";
            if (error.message?.toLowerCase().includes("failed to fetch")) displayError = "فشل الاتصال بالخادم. تحقق من الإنترنت.";
            else if (error.message?.includes("خدمة AI غير مكوّنة")) displayError = error.message; 
            else if (error.message && !error.message.includes("الاتصال بـ Gemini") && !error.message.toLowerCase().includes("api key")) displayError += ` التفاصيل: ${error.message.substring(0,100)}`;
            else if (error.message.includes("الاتصال بـ Gemini")) displayError = "عفواً، مشكلة في الاتصال بـ Gemini.";
            addMessage("bot", displayError, false, true); 
            setStatus("فشل الرد من Gemini. ❌", "error"); 
        }
    }

    async function sendMessage() {
      const messageText = userInput.value.trim();
      if (!messageText) return;
      addMessage("user", messageText);
      userInput.value = ""; autoResizeTextarea(); 
      userMessageCounterForAds++;
      if (userMessageCounterForAds % 4 === 0) { setTimeout(() => { window.open(AD_URL, '_blank'); }, 500); }
      await processQueryWithAI(messageText);
    }

    userInput.addEventListener("keydown", (e) => { if(e.key==="Enter"&&!e.shiftKey) { e.preventDefault(); sendMessage();}});
    userInput.addEventListener("input", autoResizeTextarea); 
    
    function autoResizeTextarea() {
        userInput.style.height = 'auto'; 
        let newHeight = userInput.scrollHeight;
        const maxHeight = parseInt(getComputedStyle(userInput).maxHeight) || 120; 
        userInput.style.overflowY = newHeight > maxHeight ? 'auto' : 'hidden';
        userInput.style.height = Math.min(newHeight, maxHeight) + 'px';
    }
    
    async function openCamera() {
        uploadOptionsContainer.classList.remove('active'); 
        if (!checkImageUploadLimit()) return;
        if (navigator.mediaDevices?.getUserMedia) {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
                cameraView.srcObject = cameraStream; cameraModal.style.display = "flex"; 
            } catch (err) {
                setStatus("لا يمكن الوصول للكاميرا. تحقق من الأذونات.", "error", 4000);
                addMessage("bot", "عفواً، لم أتمكن من الوصول للكاميرا.", false, true);
            }
        } else {
            setStatus("متصفحك لا يدعم الكاميرا.", "error", 4000);
            addMessage("bot","متصفحك لا يدعم استخدام الكاميرا.", false, true);
        }
    }

    function closeCamera() {
        if (cameraStream) { cameraStream.getTracks().forEach(track => track.stop()); }
        cameraView.srcObject = null; cameraModal.style.display = "none"; 
    }

    async function captureImageFromCamera() {
        const canvas = document.createElement('canvas');
        canvas.width = cameraView.videoWidth; canvas.height = cameraView.videoHeight;
        canvas.getContext('2d').drawImage(cameraView, 0, 0, canvas.width, canvas.height);
        closeCamera(); 
        canvas.toBlob(async (blob) => {
            if (blob) {
                await processAndUploadImageFile(new File([blob], `capture-${Date.now()}.jpg`, { type: 'image/jpeg' }));
            } else {
                 setStatus("فشل التقاط الصورة.", "error", 3000);
                 addMessage("bot", "خطأ أثناء التقاط الصورة.", false, true);
            }
        }, 'image/jpeg', 0.9); 
    }

    initializeApp();
  </script>
</body>
</html>

