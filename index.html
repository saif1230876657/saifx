<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Saif AI - دردشة ذكاء اصطناعي</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --primary-hue: 175;
      --primary-saturation: 70%;
      --primary-lightness: 40%;

      --primary-color: hsl(var(--primary-hue), var(--primary-saturation), var(--primary-lightness));
      --primary-hover-color: hsl(var(--primary-hue), var(--primary-saturation), calc(var(--primary-lightness) - 5%));
      --primary-glow-color: hsla(var(--primary-hue), var(--primary-saturation), calc(var(--primary-lightness) + 10%), 0.5);

      --bg-main: #181a1b;
      --bg-surface: #222526;
      --bg-surface-raised: #2c2f30;
      --bg-input: #2c2f30;

      --text-primary: #e8eaed;
      --text-secondary: #9aa0a6;
      --text-on-primary: #ffffff;
      
      --border-color: #3a3f42;
      --border-color-light: #4a4f52;
      
      --success-color: #34a853;
      --error-color: #ea4335;
      
      --user-message-bg: var(--primary-color);
      --bot-message-bg: var(--bg-surface-raised);

      --shadow-xs: 0 1px 2px rgba(0,0,0,0.25);
      --shadow-sm: 0 2px 4px rgba(0,0,0,0.3);
      --shadow-md: 0 4px 8px rgba(0,0,0,0.35);
      --shadow-lg: 0 10px 20px rgba(0,0,0,0.4);
      
      --border-radius-sm: 6px;
      --border-radius-md: 8px;
      --border-radius-lg: 12px;
      --border-radius-xl: 20px;
      --border-radius-lg-buttons: 10px; 


      /* Heights for bottom elements */
      --chat-input-area-height: 55px; 
      --status-bar-area-height: 22px; 
      --search-log-area-height: 18px; 

      --scroll-btn-size: 38px; 
      --scroll-btn-spacing: 8px; 
    }

    * {
      box-sizing: border-box;
      font-family: 'Tajawal', sans-serif;
      margin: 0;
      padding: 0;
      scrollbar-width: thin;
      scrollbar-color: var(--primary-color) var(--bg-surface);
    }

    *::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    *::-webkit-scrollbar-track {
      background: var(--bg-surface);
      border-radius: 3px;
    }
    *::-webkit-scrollbar-thumb {
      background-color: var(--primary-color);
      border-radius: 3px;
    }

    html, body {
      height: 100%; 
      font-smooth: antialiased;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      margin: 0; 
      padding: 0; 
    }

    body {
      background: var(--bg-main); 
      display: flex;
      justify-content: center;
      align-items: center;
      color: var(--text-primary);
      overflow: hidden; 
      padding-top: 10px;    /*  الهامش العلوي للجسم (لإعطاء مسافة حول الحاوية الرئيسية على الشاشات الكبيرة) */
      padding-bottom: 10px; /*  الهامش السفلي للجسم (لإعطاء مسافة حول الحاوية الرئيسية على الشاشات الكبيرة) */
      /* لا يوجد padding-left أو padding-right هنا بشكل افتراضي، الحاوية تتمركز بنفسها */
    }

    .container {
      width: 100%;
      max-width: 760px; /* يحدد أقصى عرض للحاوية على الشاشات الكبيرة (مثل اللابتوب) */
      height: 100%; /* تجعل الحاوية تملأ ارتفاع المنطقة المتاحة داخل body */
      background: var(--bg-surface); 
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-lg);
      display: flex;
      flex-direction: column; 
      overflow: hidden; /* يمنع محتويات الحاوية من تجاوز حدودها */
      position: relative; 
      box-shadow: var(--shadow-lg);
    }

    .header {
      background: var(--bg-surface);
      color: var(--text-primary);
      padding: 0.6rem 1rem; 
      text-align: center;
      display: flex;
      align-items: center;
      gap: 0.6rem; 
      position: relative; 
      border-bottom: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
      flex-shrink: 0; 
      z-index: 10; 
    }

    .header .delete-all-btn {
      cursor: pointer;
      transition: color 0.2s ease-in-out, transform 0.2s ease;
      color: var(--text-secondary);
      font-size: 1.1rem; 
      z-index: 11; 
      order: -1; 
      margin-right: auto; 
    }
    .delete-all-btn:hover {
      color: var(--error-color);
      transform: rotate(10deg) scale(1.1);
    }
    
    .header .fas.fa-robot {
      font-size: 1.4rem; 
      color: var(--primary-color);
      animation: pulseIcon 2s infinite ease-in-out;
    }

    @keyframes pulseIcon {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.8; }
    }
    
    .header h1 {
      font-size: 1.15rem; 
      font-weight: 700;
      color: var(--primary-color); 
      letter-spacing: 0.5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-left: 0.4rem; 
      margin-right: 0.4rem;
      flex-grow: 0; 
      text-align: center;
    }

    #subjectControls {
        display: flex;
        gap: 0.6rem; 
    }

    .header-btn {
        background-color: var(--bg-surface-raised); 
        color: var(--text-primary);
        border: 1px solid var(--border-color-light);
        padding: 0.5rem 0.8rem; 
        border-radius: var(--border-radius-md); 
        cursor: pointer;
        font-size: 0.8rem; 
        transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
        white-space: nowrap;
        box-shadow: var(--shadow-xs);
    }
    .header-btn:hover {
        background-color: var(--primary-color);
        color: var(--text-on-primary);
        border-color: var(--primary-color);
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm), 0 0 6px var(--primary-glow-color);
    }
    .header-btn:active {
        transform: translateY(0px);
        box-shadow: var(--shadow-xs);
    }

    .chat-container {
      flex: 1; /* يجعل حاوية الدردشة تملأ المساحة المتبقية عمودياً */
      padding: 1rem 0.7rem; 
      overflow-y: auto; /* يضيف شريط تمرير عمودي عند الحاجة */
      background: var(--bg-main);
      scroll-behavior: smooth; 
      min-height: 0; /* ضروري لعمل flex:1 مع overflow:auto بشكل صحيح */
    }

    .message {
      margin-bottom: 1.1rem; 
      display: flex;
      flex-direction: column;
      animation: messageAppear 0.4s ease-out;
    }

    @keyframes messageAppear {
      from { opacity: 0; transform: translateY(15px) scale(0.98); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .message-header {
      font-size: 0.65rem; 
      color: var(--text-secondary);
      margin-bottom: 0.25rem;
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
      padding: 0 5px; 
    }

    .delete-btn {
      color: var(--text-secondary);
      font-size: 0.75rem; 
      cursor: pointer;
      transition: color 0.2s, transform 0.2s;
      opacity: 0.5; 
    }

    .delete-btn:hover {
      opacity: 1;
      color: var(--error-color);
      transform: scale(1.15);
    }

    .message.user {
      align-items: flex-end;
    }
    .message.user .message-header {
      flex-direction: row-reverse; 
    }

    .message.bot {
      align-items: flex-start;
    }

    .bubble {
      max-width: 78%; 
      padding: 0.75rem 1rem; 
      border-radius: var(--border-radius-md); 
      word-wrap: break-word;
      white-space: pre-wrap;
      line-height: 1.6;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      box-shadow: var(--shadow-xs);
    }

    .message.user .bubble {
      background: var(--user-message-bg);
      color: var(--text-on-primary);
      border-bottom-right-radius: var(--border-radius-sm); 
    }

    .message.bot .bubble {
      background: var(--bot-message-bg);
      color: var(--text-primary);
      border-bottom-left-radius: var(--border-radius-sm); 
    }

    .message:hover .bubble {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .message-actions {
      margin-top: 6px;
      display: flex;
      gap: 5px; 
      padding: 0 5px; 
    }
    .message.user .message-actions { 
        justify-content: flex-end;
    }

    .message-actions button {
      background: transparent; 
      border: 1px solid var(--border-color-light); 
      cursor: pointer;
      font-size: 0.9rem; 
      padding: 4px 7px; 
      color: var(--text-secondary);
      transition: color 0.2s ease, background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
      border-radius: var(--border-radius-sm);
    }

    .message-actions button:hover {
      color: var(--text-on-primary);
      background-color: var(--primary-color);
      border-color: var(--primary-color);
      box-shadow: 0 0 8px var(--primary-glow-color);
    }

    .message-actions button.liked {
      color: var(--success-color);
      border-color: var(--success-color);
    }
     .message-actions button.liked:hover {
      background-color: var(--success-color);
      color: var(--text-on-primary);
      box-shadow: 0 0 8px hsla(135, 60%, 50%, 0.5);
    }
    .message-actions button.retry-btn i { 
      color: hsl(var(--primary-hue), var(--primary-saturation), calc(var(--primary-lightness) + 15%));
    }
    .message-actions button.retry-btn:hover i {
      color: var(--text-on-primary); 
    }


    .chat-input {
      display: flex;
      align-items: flex-end; 
      border-top: 1px solid var(--border-color);
      padding: 0.5rem 0.7rem; 
      background: var(--bg-surface); 
      gap: 0.6rem; 
      position: relative; 
      z-index: 5; 
      flex-shrink: 0; 
      min-height: var(--chat-input-area-height); 
    }

    .chat-input textarea {
      flex: 1;
      padding: 0.6rem 0.9rem; 
      border: 1px solid var(--border-color);
      resize: none;
      font-size: 0.9rem;
      outline: none;
      border-radius: var(--border-radius-xl); 
      background: var(--bg-input);
      color: var(--text-primary);
      max-height: 90px; 
      line-height: 1.55;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
     .chat-input textarea::placeholder {
        color: var(--text-secondary);
        opacity: 0.6;
     }
     .chat-input textarea:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px var(--primary-glow-color);
     }

    .chat-input-btn { 
      background: var(--primary-color);
      border: none;
      color: var(--text-on-primary);
      width: 38px; 
      height: 38px; 
      border-radius: 50%; 
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1rem; 
      transition: background-color 0.2s ease, transform 0.15s ease, box-shadow 0.2s ease;
      flex-shrink: 0; 
    }
    .chat-input-btn:hover {
      background: var(--primary-hover-color);
      transform: scale(1.05);
      box-shadow: 0 0 10px var(--primary-glow-color);
    }
    .chat-input-btn:active {
        transform: scale(0.92);
        background: var(--primary-hover-color);
    }

    #imageUpload {
      display: none;
    }

    .upload-options-container {
      position: absolute;
      bottom: calc(100% + 5px); 
      right: 48px; 
      background-color: var(--bg-surface-raised);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-md);
      box-shadow: var(--shadow-md);
      display: flex;
      flex-direction: column;
      gap: 5px;
      padding: 8px;
      z-index: 10;
      opacity: 0;
      visibility: hidden;
      transform: translateY(10px);
      transition: opacity 0.2s ease, visibility 0s linear 0.2s, transform 0.2s ease;
    }
    .upload-options-container.active {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
      transition: opacity 0.2s ease, visibility 0s linear 0s, transform 0.2s ease;
    }
    .upload-options-container button {
      background-color: var(--bg-input);
      color: var(--text-secondary);
      border: 1px solid var(--border-color-light);
      padding: 8px 12px;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      transition: background-color 0.2s ease, color 0.2s ease;
    }
    .upload-options-container button:hover {
      background-color: var(--primary-color);
      color: var(--text-on-primary);
      border-color: var(--primary-color);
    }
    .upload-options-container button i {
      font-size: 1rem;
    }

    .status {
      text-align: center;
      padding: 0.25rem; 
      font-size: 0.75rem; 
      background-color: var(--bg-surface);
      color: var(--text-secondary);
      border-top: 1px solid var(--border-color);
      min-height: var(--status-bar-area-height); 
      transition: color 0.3s ease;
      flex-shrink: 0; 
    }

    .status.success { color: var(--success-color); font-weight: 500; }
    .status.error { color: var(--error-color); font-weight: 500; }

    a {
      color: var(--primary-color); 
      text-decoration: none;
      word-break: break-all;
      font-weight: 500;
    }

    a:hover {
      text-decoration: underline;
      color: hsl(var(--primary-hue), var(--primary-saturation), calc(var(--primary-lightness) + 10%)); 
    }

    .search-log {
      text-align: center;
      font-size: 0.7rem; 
      color: var(--text-secondary);
      opacity: 0.6; 
      padding: 0.1rem 0; 
      border-top: 1px dashed var(--border-color-light);
      background-color: var(--bg-main);
      min-height: var(--search-log-area-height);
      flex-shrink: 0; 
    }

    .toggle-details-btn {
      cursor: pointer;
      color: var(--primary-color);
      font-weight: 500;
      border: none;
      background: none;
      padding: 0;
      margin-top: 8px;
      display: block; 
      text-align: right; 
      font-size: 0.85rem;
      transition: color 0.2s ease;
    }

    .toggle-details-btn:hover {
      color: hsl(var(--primary-hue), var(--primary-saturation), calc(var(--primary-lightness) + 10%)); 
      text-decoration: underline;
    }

    .camera-modal, .subject-modal { 
        display: none; 
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.7);
        align-items: center;
        justify-content: center;
    }
    .camera-modal-content { 
        background-color: var(--bg-surface);
        padding: 20px;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-lg);
        text-align: center;
        max-width: 90%;
        max-height: 90%;
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative; 
    }
    .subject-modal-content {
        background-color: var(--bg-surface);
        padding: 25px; 
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-lg);
        text-align: center;
        max-width: 90%;
        width: 500px; 
        max-height: 90%;
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        box-shadow: var(--shadow-lg);
    }

    #cameraView {
        width: 100%;
        max-width: 400px;
        height: auto;
        border-radius: var(--border-radius-md);
        margin-bottom: 15px;
        background-color: #000; 
    }
    .camera-controls button { 
        background: var(--primary-color);
        border: none;
        color: var(--text-on-primary);
        padding: 10px 20px;
        font-size: 0.9rem;
        border-radius: var(--border-radius-md);
        cursor: pointer;
        margin: 5px; 
        transition: background-color 0.2s ease;
    }
     .camera-controls button:hover { 
        background: var(--primary-hover-color);
    }
    .camera-controls button#cancelCameraBtn {
        background-color: var(--error-color);
    }
    .camera-controls button#cancelCameraBtn:hover {
        background-color: hsl(var(--primary-hue,0), 90%, 30%); 
    }

    .subject-modal-content h2 {
        font-size: 1.7rem; 
        color: var(--primary-color);
        margin-bottom: 25px; 
        font-weight: 700;
    }
    .subject-modal-content .close-modal-btn {
        position: absolute;
        top: 10px;
        left: 15px; 
        font-size: 1.5rem;
        color: var(--text-secondary);
        cursor: pointer;
        background: none;
        border: none;
        padding: 0;
    }
     .subject-modal-content .close-modal-btn:hover {
        color: var(--text-primary);
     }
    #subjectListContainer {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 15px; 
        margin-top: 15px;
        width: 100%;
    }
    #subjectListContainer button {
        background: var(--bg-input); 
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        padding: 14px 22px; 
        font-size: 0.95rem; 
        font-weight: 500;
        min-width: 140px; 
        border-radius: var(--border-radius-lg-buttons); 
        cursor: pointer;
        transition: background-color 0.25s ease, color 0.25s ease, border-color 0.25s ease, transform 0.15s ease, box-shadow 0.25s ease;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
    }
    #subjectListContainer button:hover {
        background-color: var(--primary-color);
        color: var(--text-on-primary);
        border-color: var(--primary-hover-color);
        transform: translateY(-2px) scale(1.02); 
        box-shadow: 0 4px 8px rgba(0,0,0,0.3), 0 0 10px var(--primary-glow-color); 
    }
    #subjectListContainer button:active {
        transform: translateY(0px) scale(1);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .scroll-btn {
      position: absolute; 
      right: 20px;
      background-color: var(--primary-color);
      color: var(--text-on-primary);
      border: none;
      width: var(--scroll-btn-size);   
      height: var(--scroll-btn-size);  
      border-radius: 50%;
      display: none; 
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1rem; 
      box-shadow: var(--shadow-md);
      transition: background-color 0.2s ease, transform 0.2s ease, opacity 0.3s ease, visibility 0.3s ease;
      z-index: 3; 
      opacity: 0;
      visibility: hidden;
    }
    .scroll-btn:hover {
      background-color: var(--primary-hover-color);
      transform: scale(1.1);
    }
    .scroll-btn.visible {
        display: flex;
        opacity: 0.8; 
        visibility: visible;
    }
    .scroll-btn.visible:hover {
        opacity: 1; 
    }

    #scrollToBottomBtn {
      bottom: calc(var(--chat-input-area-height) + var(--status-bar-area-height) + var(--search-log-area-height) + var(--scroll-btn-spacing));
    }
    #scrollToTopBtn {
      bottom: calc(var(--chat-input-area-height) + var(--status-bar-area-height) + var(--search-log-area-height) + var(--scroll-btn-spacing) + var(--scroll-btn-size) + var(--scroll-btn-spacing));
    }

    /* Media Queries for Responsiveness */
    @media (max-width: 768px) { /* Styles for tablets and smaller devices */
      .container {
        border-radius: 0; 
        border-left: none;
        border-right: none;
        max-width: 100%; /* Container takes full width */
      }
      body { 
        padding-top: 5px; /* Reduce body padding on smaller screens */
        padding-bottom: 5px;
      }
      :root { /* Adjust variable values for smaller screens */
        --chat-input-area-height: 52px; 
        --status-bar-area-height: 20px;
        --search-log-area-height: 16px;
        --scroll-btn-size: 36px;
        --scroll-btn-spacing: 7px;
      }
      .header { padding: 0.5rem 1rem; gap: 0.5rem;}
      .header h1 { font-size: 1.1rem; margin-left: 0.3rem; margin-right: 0.3rem;}
      .header .fas.fa-robot { font-size: 1.3rem; }
      .delete-all-btn { font-size: 1.05rem; }
      .header-btn { font-size: 0.75rem; padding: 0.4rem 0.7rem;}
      #subjectControls { gap: 0.3rem;}

      .bubble { max-width: 85%; padding: 0.65rem 0.9rem; line-height: 1.55; }
      .chat-input { padding: 0.4rem 0.6rem; gap: 0.5rem; } 
      .chat-input textarea { font-size: 0.85rem; padding: 0.5rem 0.8rem; } 
      .chat-input-btn { width: 36px; height: 36px; font-size: 0.9rem; } 
      .upload-options-container { right: 43px; } 
      .upload-options-container button { padding: 7px 10px; font-size: 0.8rem; }
    }

    @media (max-width: 480px) { /* Styles for mobile phones */
      :root {
        --chat-input-area-height: 50px; 
        --status-bar-area-height: 18px;
        --search-log-area-height: 15px;
        --scroll-btn-size: 34px;
        --scroll-btn-spacing: 5px;
      }
       body { 
        padding-top: 3px; /* Further reduce body padding */
        padding-bottom: 3px;
      }
      .header { 
        padding: 0.4rem 0.7rem; 
        gap: 0.3rem; 
        flex-wrap: wrap; /* Allow header items to wrap on very small screens */
        justify-content: center;
      }
       .header .delete-all-btn {
        order: 1; 
        margin: 0 5px; 
        font-size: 1rem;
      }
      .header .fas.fa-robot {
        order: 2;
        margin: 0 5px;
        font-size: 1.2rem;
      }
      .header h1 { 
        order: 3;
        font-size: 1.0rem; 
        width: 100%; 
        text-align: center;
        margin: 3px 0; 
      }
      #subjectControls { 
        order: 4; 
        width: 100%; 
        justify-content: center; 
        margin-top: 0.3rem; 
        gap: 0.4rem;
      }
      
      .subject-modal-content {
        width: 90%;
        padding: 20px;
      }
      .subject-modal-content h2 {
        font-size: 1.5rem;
        margin-bottom: 20px;
      }
      #subjectListContainer button {
        padding: 12px 18px;
        font-size: 0.9rem;
        min-width: 120px;
      }

      .chat-container { padding: 0.8rem 0.5rem; }
      .message-header { font-size: 0.6rem; gap: 4px; }
      .bubble { max-width: 90%; padding: 0.6rem 0.8rem; line-height: 1.5; }
      .message.user .bubble { border-bottom-right-radius: 4px; }
      .message.bot .bubble { border-bottom-left-radius: 4px; }
      .message-actions button { font-size: 0.8rem; padding: 3px 6px; }
      
      .chat-input { padding: 0.35rem 0.45rem; gap: 0.4rem; }
      .chat-input textarea { font-size: 0.8rem; padding: 0.45rem 0.7rem; max-height: 80px; }
      .chat-input-btn { width: 34px; height: 34px; font-size: 0.85rem; }
      .upload-options-container { right: 40px; } 
      .upload-options-container button { padding: 6px 8px; font-size: 0.75rem; }
      .upload-options-container button i { font-size: 0.9rem; }
      .status { font-size: 0.7rem; padding: 0.25rem;}
      .search-log { font-size: 0.65rem; padding: 0.1rem 0;}
      .scroll-btn { right: 15px; }
      .toggle-details-btn { font-size: 0.8rem; }
      .header-btn { font-size: 0.7rem; padding: 0.3rem 0.6rem;}
    }

    @media (max-width: 360px) { /* Styles for very small mobile screens */
       :root {
        --chat-input-area-height: 48px;
        --status-bar-area-height: 18px; 
        --search-log-area-height: 14px;
        --scroll-btn-size: 32px;
       }
      .header h1 { font-size: 1rem; }
      .bubble { padding: 0.5rem 0.7rem; }
      .chat-input textarea { padding: 0.35rem 0.6rem; }
      .chat-input-btn { width: 32px; height: 32px; }
      .upload-options-container { right: 38px; } 
    }

  </style>
</head><body>
  <div class="container">
    <header class="header">
      <i class="fas fa-trash delete-all-btn" onclick="deleteAllMessages()" title="حذف كل الرسائل"></i>
      <i class="fas fa-robot"></i>
      <h1 id="botName">Saif AI</h1>
      <div id="subjectControls">
        <button id="enterSubjectsBtn" class="header-btn">مواد متخصصة</button>
        <button id="generalChatBtn" class="header-btn" style="display: none;">عام</button>
      </div>
    </header>

    <div id="chatContainer" class="chat-container">
      <!-- Messages will be here -->
    </div>

    <button id="scrollToTopBtn" class="scroll-btn" title="الانتقال إلى الأعلى">
      <i class="fas fa-arrow-up"></i>
    </button>
    <button id="scrollToBottomBtn" class="scroll-btn" title="الانتقال إلى الأسفل">
      <i class="fas fa-arrow-down"></i>
    </button>

    <div id="searchLog" class="search-log"></div>
    <div class="status" id="statusBar"></div>

    <div class="chat-input">
      <textarea id="userInput" rows="1" placeholder="اكتب رسالتك هنا..."></textarea>
      
      <div class="upload-options-container" id="uploadOptionsContainer">
        <button onclick="triggerImageUpload()">
          <i class="fas fa-images"></i> رفع من المعرض
        </button>
        <button onclick="openCamera()">
          <i class="fas fa-camera"></i> استخدام الكاميرا
        </button>
      </div>
      
      <button class="chat-input-btn" id="toggleUploadBtn" title="إرفاق ملف">
        <i class="fas fa-plus"></i>
      </button>
      
      <button class="chat-input-btn" onclick="sendMessage()" title="إرسال">
        <i class="fas fa-paper-plane"></i>
      </button>
      <input id="imageUpload" type="file" accept="image/*" onchange="handleFileSelect(event)" />
    </div>
  </div>

  <!-- Camera Modal -->
  <div id="cameraModal" class="camera-modal">
    <div class="camera-modal-content">
      <video id="cameraView" autoplay playsinline></video>
      <div class="camera-controls">
        <button id="captureBtn">التقاط صورة</button>
        <button id="cancelCameraBtn">إلغاء</button>
      </div>
    </div>
  </div>

  <!-- Subject Selection Modal -->
  <div id="subjectModal" class="subject-modal">
    <div class="subject-modal-content">
      <button class="close-modal-btn" onclick="closeSubjectModal()" title="إغلاق">×</button>
      <h2>اختر المادة</h2>
      <div id="subjectListContainer">
        <!-- Subject buttons will be populated here -->
      </div>
    </div>
  </div>

  <script>
    const geminiApiKey = "AIzaSyBUqzhaui0pz0PqhCsVEpQYfOHsCYKtPBk"; 
    const ocrApiKey = "K83201031288957";     

    const chatContainer = document.getElementById("chatContainer");
    const statusBar = document.getElementById("statusBar");
    const searchLog = document.getElementById("searchLog");
    const userInput = document.getElementById("userInput");
    const botNameElement = document.getElementById("botName");
    const imageUploadInput = document.getElementById("imageUpload");
    const toggleUploadBtn = document.getElementById("toggleUploadBtn");
    const uploadOptionsContainer = document.getElementById("uploadOptionsContainer");
    const scrollToTopBtn = document.getElementById('scrollToTopBtn');
    const scrollToBottomBtn = document.getElementById('scrollToBottomBtn');

    const cameraModal = document.getElementById('cameraModal');
    const cameraView = document.getElementById('cameraView');
    const captureBtn = document.getElementById('captureBtn');
    const cancelCameraBtn = document.getElementById('cancelCameraBtn');
    let cameraStream = null;

    const enterSubjectsBtn = document.getElementById('enterSubjectsBtn');
    const generalChatBtn = document.getElementById('generalChatBtn');
    const subjectModal = document.getElementById('subjectModal');
    const subjectListContainer = document.getElementById('subjectListContainer');

    const botName = "سيف AI";
    const localStorageKeyAllChats = "saifAiAllChatsHistory_v2"; 
    const localStorageKeyAdCounter = "saifAiAdCounter";
    const localStorageKeyImageUploadDate = "saifAiImageUploadDate";
    const localStorageKeyImageUploadCount = "saifAiImageUploadCount";
    const localStorageKeyCurrentSubject = "saifAiCurrentSubject_v2";


    const AD_URL = "https://www.profitableratecpm.com/k8fisnjjc?key=afa7ea920578f74cea5997d670bbe78e";
    const AD_DELAY_MS = 10000; 

    let allMessages = {}; 
    let messages = [];    
    
    let successfulResponseCount = 0;
    let userMessageCounterForAds = 0;
    let statusTimeout;
    
    let currentSubject = "general"; 
    const subjects = ["فيزياء", "كيمياء", "أحياء", "علوم", "لغة عربية", "فلسفة", "لغة إنجليزية", "رياضيات", "تربية دينية"];


    function initializeApp() {
        const storedAdCount = localStorage.getItem(localStorageKeyAdCounter);
        if (storedAdCount) {
            successfulResponseCount = parseInt(storedAdCount, 10) || 0;
        }

        loadAllMessagesAndSetCurrent(); 

        const storedSubject = localStorage.getItem(localStorageKeyCurrentSubject);
        if (storedSubject && (subjects.includes(storedSubject) || storedSubject === "general")) {
            currentSubject = storedSubject;
        } else {
            currentSubject = "general"; 
        }
        
        if (!allMessages[currentSubject]) {
            allMessages[currentSubject] = [];
        }
        messages = allMessages[currentSubject];


        updateSubjectUI(); 
        botNameElement.textContent = getBotDisplayName(); 

        addWelcomeMessage(); 
        refreshChat();
        autoResizeTextarea();

        toggleUploadBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            uploadOptionsContainer.classList.toggle('active');
        });

        document.addEventListener('click', (e) => {
            if (!uploadOptionsContainer.contains(e.target) && !toggleUploadBtn.contains(e.target) &&
                !subjectModal.contains(e.target) && e.target !== enterSubjectsBtn) { 
                uploadOptionsContainer.classList.remove('active');
            }
        });

        captureBtn.addEventListener('click', captureImageFromCamera);
        cancelCameraBtn.addEventListener('click', closeCamera);

        scrollToTopBtn.addEventListener('click', () => {
            chatContainer.scrollTo({ top: 0, behavior: 'smooth' });
        });

        scrollToBottomBtn.addEventListener('click', () => {
            chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
        });

        chatContainer.addEventListener('scroll', () => {
            const scrollTop = chatContainer.scrollTop;
            const scrollHeight = chatContainer.scrollHeight;
            const clientHeight = chatContainer.clientHeight;
            const scrollThreshold = 150;

            if (scrollTop > scrollThreshold) {
                scrollToTopBtn.classList.add('visible');
            } else {
                scrollToTopBtn.classList.remove('visible');
            }

            if (scrollHeight > clientHeight && scrollHeight - scrollTop - clientHeight > scrollThreshold) {
                scrollToBottomBtn.classList.add('visible');
            } else {
                scrollToBottomBtn.classList.remove('visible');
            }
        });
        chatContainer.dispatchEvent(new Event('scroll'));

        enterSubjectsBtn.addEventListener('click', openSubjectModal);
        generalChatBtn.addEventListener('click', switchToGeneralMode);
        populateSubjectList();
    }

    function getBotDisplayName() {
        if (currentSubject === "general") {
            return botName;
        }
        return `${botName} (${currentSubject})`;
    }
    
    function updateSubjectUI() {
        botNameElement.textContent = getBotDisplayName();
        if (currentSubject === "general") {
            generalChatBtn.style.display = 'none';
            enterSubjectsBtn.textContent = "مواد متخصصة";
        } else {
            generalChatBtn.style.display = 'inline-block'; 
            enterSubjectsBtn.textContent = `مادة: ${currentSubject}`;
        }
        localStorage.setItem(localStorageKeyCurrentSubject, currentSubject);
    }

    function openSubjectModal() {
        subjectModal.style.display = "flex";
    }

    function closeSubjectModal() {
        subjectModal.style.display = "none";
    }

    function populateSubjectList() {
        subjectListContainer.innerHTML = '';
        subjects.forEach(subject => {
            const btn = document.createElement('button');
            btn.textContent = subject;
            btn.onclick = () => selectSubject(subject);
            subjectListContainer.appendChild(btn);
        });
    }

    function selectSubject(subject) {
        if (currentSubject === subject) { 
            closeSubjectModal();
            return;
        }
        allMessages[currentSubject] = messages; 

        currentSubject = subject;
        messages = allMessages[currentSubject] || []; 
        if (!allMessages[currentSubject]) {
             allMessages[currentSubject] = []; 
        }

        updateSubjectUI();
        closeSubjectModal();
        addWelcomeMessage(); 
        refreshChat(); 
        setStatus(`تم التحويل إلى وضع مادة: ${currentSubject}`, "success", 3000);
        saveAllMessagesToLocalStorage(); 
    }

    function switchToGeneralMode() {
        if (currentSubject === "general") return; 

        allMessages[currentSubject] = messages; 

        currentSubject = "general";
        messages = allMessages[currentSubject] || []; 
         if (!allMessages[currentSubject]) {
             allMessages[currentSubject] = [];
        }

        updateSubjectUI();
        addWelcomeMessage(); 
        refreshChat(); 
        setStatus("تم الرجوع إلى الوضع العام", "success", 3000);
        saveAllMessagesToLocalStorage();
    }


    function loadAllMessagesAndSetCurrent() {
        const storedAllMessages = localStorage.getItem(localStorageKeyAllChats);
        if (storedAllMessages) {
            try {
                const parsed = JSON.parse(storedAllMessages);
                if (typeof parsed === 'object' && parsed !== null) {
                    allMessages = parsed;
                    for (const subjectKey in allMessages) {
                        if (Object.hasOwnProperty.call(allMessages, subjectKey) && Array.isArray(allMessages[subjectKey])) {
                            allMessages[subjectKey] = allMessages[subjectKey].map(msg => ({
                                ...msg,
                                timestamp: new Date(msg.timestamp) 
                            }));
                        } else {
                             allMessages[subjectKey] = []; 
                        }
                    }
                } else {
                    allMessages = {}; 
                }
            } catch (e) {
                console.error("خطأ في تحليل هيكل الرسائل الكلي من التخزين المحلي:", e);
                allMessages = {}; 
                localStorage.removeItem(localStorageKeyAllChats); 
            }
        } else {
            allMessages = {}; 
        }
        if (!allMessages["general"] || !Array.isArray(allMessages["general"])) {
            allMessages["general"] = [];
        }
    }

    function saveAllMessagesToLocalStorage() {
        if (currentSubject && messages) { 
           allMessages[currentSubject] = messages;
        }
        localStorage.setItem(localStorageKeyAllChats, JSON.stringify(allMessages));
    }

    function addWelcomeMessage() {
        let welcomeMsgText = `مرحباً بك! أنا ${getBotDisplayName()}، كيف يمكنني مساعدتك اليوم؟ 💡 يمكنك رفع صورتين يوميًا وسأحاول استخلاص النص منها وإرساله للتحليل.`;
        if (currentSubject !== "general") {
             welcomeMsgText = `مرحباً! أنا ${getBotDisplayName()}. حاليًا في وضع الإجابة عن أسئلة مادة ${currentSubject} بناءً على المنهج الدراسي. كيف يمكنني مساعدتك ضمن هذا الإطار؟`;
        }
      
        if (!messages.some(m => m.isInitialWelcome && m.sender === "bot")) {
            messages = messages.filter(m => !m.isInitialWelcome);
            
            const welcomeMessageObject = {
                sender: "bot",
                text: welcomeMsgText,
                isImage: false,
                isSystemMessage: true, 
                timestamp: new Date(),
                isInitialWelcome: true
            };
            messages.unshift(welcomeMessageObject); 
            allMessages[currentSubject] = messages; 
            saveAllMessagesToLocalStorage(); 
        } else {
            const welcomeIndex = messages.findIndex(m => m.isInitialWelcome && m.sender === "bot");
            if (welcomeIndex !== -1 && messages[welcomeIndex].text !== welcomeMsgText) {
                messages[welcomeIndex].text = welcomeMsgText;
                allMessages[currentSubject] = messages;
                saveAllMessagesToLocalStorage();
            }
        }
    }

    function addMessage(sender, text, isImage = false, isSystemMessage = false, isInitialWelcome = false) {
      const message = { sender, text, isImage, isSystemMessage, timestamp: new Date(), isInitialWelcome };
      
      messages.push(message);
      allMessages[currentSubject] = messages; 
      
      const wasNearBottom = chatContainer.scrollHeight - chatContainer.scrollTop - chatContainer.clientHeight < 150;

      refreshChat(); 

      if (sender === 'user') {
          chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
      } else if (isInitialWelcome) {
          if (messages.length <= 2) { // Only scroll for initial welcome if chat is nearly empty
            chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
          }
      } else if (wasNearBottom && !isImage) { 
          chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
      }
    }

    function linkifyAndFormatText(text) {
      if (typeof text !== 'string') return '';
      const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
      const linkedText = text.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
      return linkedText.replace(/\n/g, '<br>');
    }

    function refreshChat() {
      chatContainer.innerHTML = ""; 
      messages.forEach((msg, index) => {
        const messageElem = document.createElement("div");
        messageElem.classList.add("message", msg.sender);
        
        const header = document.createElement("div");
        header.classList.add("message-header");
        
        let senderName = msg.sender === "bot" ? getBotDisplayName() : "أنت";
        if (msg.sender === "bot" && msg.isSystemMessage && !msg.isInitialWelcome) {
            senderName = `${getBotDisplayName()} (نظام)`;
        }
        header.innerHTML = `<span>${senderName}</span>`;
        
        const deleteBtn = document.createElement("i");
        deleteBtn.className = "fas fa-trash delete-btn";
        deleteBtn.title = "حذف الرسالة";
        deleteBtn.onclick = () => deleteMessage(index); 
        header.appendChild(deleteBtn);
        
        messageElem.appendChild(header);
        
        const bubble = document.createElement("div");
        bubble.classList.add("bubble");

        if(msg.isImage) {
          const img = document.createElement("img");
          img.src = msg.text;
          img.style.maxWidth = "100%";
          img.style.maxHeight = "300px";
          img.style.borderRadius = "var(--border-radius-sm)";
          img.alt = "صورة مرسلة";
          img.onload = () => {
              const isLastMessage = index === messages.length - 1;
              const wasNearBottomForImage = chatContainer.scrollHeight - chatContainer.scrollTop - chatContainer.clientHeight < 350; // Larger threshold for images
              if (isLastMessage || wasNearBottomForImage) {
                  chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
              }
          }
          img.onerror = () => {
              console.warn("فشل تحميل الصورة:", msg.text);
              bubble.textContent = "فشل تحميل الصورة";
          }
          bubble.appendChild(img);
        } else {
          const originalText = msg.text;
          const characterLimit = 250; 

          if (msg.sender === "bot" && !msg.isSystemMessage && originalText.length > characterLimit) {
            const shortText = originalText.substring(0, characterLimit) + "...";
            const contentContainer = document.createElement('div');
            const textSpan = document.createElement('span');
            textSpan.innerHTML = linkifyAndFormatText(shortText);
            contentContainer.appendChild(textSpan);

            const toggleButton = document.createElement('button');
            toggleButton.textContent = "المزيد من التفاصيل";
            toggleButton.className = "toggle-details-btn";
            toggleButton.dataset.expanded = "false";

            toggleButton.onclick = function() {
              const isExpanded = toggleButton.dataset.expanded === "true";
              if (isExpanded) {
                textSpan.innerHTML = linkifyAndFormatText(shortText);
                toggleButton.textContent = "المزيد من التفاصيل";
                toggleButton.dataset.expanded = "false";
              } else {
                textSpan.innerHTML = linkifyAndFormatText(originalText);
                toggleButton.textContent = "عرض أقل";
                toggleButton.dataset.expanded = "true";
              }
            };
            contentContainer.appendChild(toggleButton);
            bubble.appendChild(contentContainer);
          } else {
            bubble.innerHTML = linkifyAndFormatText(originalText);
          }
        }
        messageElem.appendChild(bubble);
        
        if(msg.sender === "bot" && !msg.isImage && !msg.isSystemMessage) {
          const actionsDiv = document.createElement("div");
          actionsDiv.classList.add("message-actions");
          
          const likeBtn = document.createElement("button");
          likeBtn.innerHTML = '<i class="fas fa-thumbs-up"></i>';
          likeBtn.title = "إعجاب";
          likeBtn.addEventListener("click", (e) => e.currentTarget.classList.toggle("liked"));
          
          const copyBtn = document.createElement("button");
          copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
          copyBtn.title = "نسخ النص";
          copyBtn.addEventListener("click", () => {
            navigator.clipboard.writeText(msg.text)
            .then(() => setStatus("تم نسخ المحتوى بنجاح 👍", "success", 1500))
            .catch(err => setStatus("فشل النسخ: " + err.message, "error", 2000));
          });

          const retryBtn = document.createElement("button");
          retryBtn.innerHTML = '<i class="fas fa-redo"></i>';
          retryBtn.title = "إعادة السؤال";
          retryBtn.classList.add("retry-btn"); 
          retryBtn.onclick = () => retryQuery(index); 
          
          actionsDiv.appendChild(likeBtn);
          actionsDiv.appendChild(copyBtn);
          actionsDiv.appendChild(retryBtn); 
          messageElem.appendChild(actionsDiv);
        }
        
        chatContainer.appendChild(messageElem);
      });

      saveAllMessagesToLocalStorage(); 
      autoResizeTextarea(); 
      chatContainer.dispatchEvent(new Event('scroll')); 
    }

    async function retryQuery(botMessageIndex) {
        if (botMessageIndex > 0 && messages[botMessageIndex - 1] && messages[botMessageIndex - 1].sender === 'user') {
            const originalUserQuery = messages[botMessageIndex - 1].text;
            if (originalUserQuery) {
                setStatus(`جاري إعادة إرسال السؤال: "${originalUserQuery.substring(0, 30)}..."`, "", null);
                await processQueryWithAI(originalUserQuery);
            } else {
                setStatus("لم يتم العثور على السؤال الأصلي.", "error", 2000);
            }
        } else {
            console.warn("Could not find preceding user message for retry for bot message at index:", botMessageIndex, messages);
            setStatus("خطأ: لم يتمكن من تحديد السؤال الأصلي لإعادته.", "error", 3000);
        }
    }

    function deleteMessage(index) {
      const isWelcome = messages[index].isInitialWelcome;
      messages.splice(index, 1); 
      allMessages[currentSubject] = messages; 

      if (isWelcome && messages.filter(m => m.sender === 'bot' && m.isInitialWelcome).length === 0) {
          addWelcomeMessage(); 
      }
      refreshChat(); 
      setStatus("تم حذف الرسالة.", "success", 1500);
    }

    function deleteAllMessages() {
      const nonWelcomeMessages = messages.filter(m => !m.isInitialWelcome);
      if (nonWelcomeMessages.length === 0) {
        setStatus("لا يوجد رسائل لحذفها (غير رسالة الترحيب).", "", 1500);
        return;
      }
      if (confirm("هل أنت متأكد أنك تريد حذف جميع الرسائل في هذه الدردشة؟ هذا الإجراء لا يمكن التراجع عنه.")) {
        messages = messages.filter(m => m.isInitialWelcome); 
        allMessages[currentSubject] = messages; 
        
        if (messages.length === 0) { 
            addWelcomeMessage(); 
        } else { 
            // Ensure the welcome message is correctly updated if it exists
            addWelcomeMessage(); 
        }
        refreshChat(); 
        setStatus("تم حذف جميع الرسائل في هذه الدردشة بنجاح.", "success", 2000);
      }
    }
    
    function setStatus(message, type = "", duration = 3000) {
      clearTimeout(statusTimeout);
      statusBar.textContent = message;
      statusBar.className = "status " + type; 
      if (message && duration !== null) {
        statusTimeout = setTimeout(() => {
          statusBar.textContent = "";
          statusBar.className = "status";
        }, duration);
      } else if (!message) { // Clear status if message is empty
         statusBar.textContent = "";
         statusBar.className = "status";
      }
    }

    function triggerImageUpload() {
        uploadOptionsContainer.classList.remove('active');
        imageUploadInput.click();
    }

    function handleFileSelect(event) {
        if (event.target.type === 'file' && event.target.files && event.target.files[0]) {
            const file = event.target.files[0];
            processAndUploadImageFile(file);
            event.target.value = ""; // Reset file input
        }
    }
    
    async function processAndUploadImageFile(file) {
        if (!checkImageUploadLimit()) return;

        setTimeout(() => {
            window.open(AD_URL, '_blank');
            console.log("تم فتح الرابط الإعلاني بسبب رفع الصورة (بعد ~10 ثوان).");
        }, AD_DELAY_MS); 

        if (file.size > 5 * 1024 * 1024) { // 5MB limit
            setStatus("حجم الصورة كبير جدًا (الحد الأقصى 5 ميجا بايت).", "error", 3000);
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
            addMessage("user", e.target.result, true); 
            extractTextFromImageAndProcess(file); 
        }
        reader.readAsDataURL(file);
        
        incrementImageUploadCount();
    }

    function checkImageUploadLimit() {
        const today = new Date().toISOString().split('T')[0];
        const lastUploadDate = localStorage.getItem(localStorageKeyImageUploadDate);
        let uploadCount = parseInt(localStorage.getItem(localStorageKeyImageUploadCount) || "0");

        if (lastUploadDate === today) {
            if (uploadCount >= 2) {
                setStatus("لقد تعديت الحد الأقصى لعدد الصور لهذا اليوم (صورتان).", "error", 4000);
                addMessage("bot", "عفواً، لقد استنفدت الحصة اليومية لرفع الصور (صورتان). يمكنك المحاولة مرة أخرى غداً.", false, true);
                return false;
            }
        } else {
            // Reset count for a new day
            localStorage.setItem(localStorageKeyImageUploadDate, today);
            localStorage.setItem(localStorageKeyImageUploadCount, "0");
            uploadCount = 0;
        }
        return true;
    }

    function incrementImageUploadCount() {
        const today = new Date().toISOString().split('T')[0];
        localStorage.setItem(localStorageKeyImageUploadDate, today); // Ensure date is current
        let currentCount = parseInt(localStorage.getItem(localStorageKeyImageUploadCount) || "0");
        localStorage.setItem(localStorageKeyImageUploadCount, (currentCount + 1).toString());
    }

    async function extractTextFromImageAndProcess(file) {
        if (!ocrApiKey) { 
             addMessage("bot", "ميزة استخلاص النص من الصور غير مفعلة حاليًا. (مفتاح OCR مفقود)", false, true);
             setStatus("مفتاح خدمة OCR غير مكوّن.", "error", 5000);
             return;
        }
        // If ocrApiKey is "K83201031288957" (your provided example), it will proceed. 
        // For actual OCR functionality, this key would need to be a valid, working key from OCR.space.

        setStatus(`جاري معالجة الصورة واستخلاص النص منها...`, "", null); 
        const formData = new FormData();
        formData.append('apikey', ocrApiKey);
        formData.append('language', 'ara'); 
        formData.append('isOverlayRequired', 'false');
        formData.append('file', file);

        try {
            const ocrResponse = await fetch('https://api.ocr.space/parse/image', {
                method: 'POST',
                body: formData,
            });

            if (!ocrResponse.ok) {
                const errorData = await ocrResponse.json().catch(() => ({ ErrorMessage: "فشل في تحليل استجابة الخطأ من OCR" }));
                console.error("خطأ من OCR.space:", errorData);
                throw new Error(`فشل استخلاص النص: ${errorData.ErrorMessage || ocrResponse.statusText}`);
            }

            const ocrData = await ocrResponse.json();

            if (ocrData.IsErroredOnProcessing) {
                console.error("خطأ في معالجة OCR:", ocrData.ErrorMessage);
                throw new Error(`خطأ في معالجة الصورة: ${ocrData.ErrorMessage.join(', ')}`);
            }
            
            if (ocrData.ParsedResults && ocrData.ParsedResults.length > 0 && ocrData.ParsedResults[0].ParsedText.trim() !== "") {
                const extractedText = ocrData.ParsedResults[0].ParsedText.trim();
                addMessage("bot", `تم استخلاص النص التالي من الصورة:\n"${extractedText}"`, false, true);
                setStatus("تم استخلاص النص بنجاح، جاري إرساله للتحليل...", "success", 2500);
                await processQueryWithAI(extractedText); 
            } else {
                addMessage("bot", "لم يتم العثور على نص واضح في الصورة أو أن النص غير مدعوم.", false, true);
                setStatus("لم يتم استخلاص نص من الصورة.", "error", 3000);
            }
        } catch (error) {
            console.error("خطأ أثناء استخلاص النص من الصورة:", error);
            addMessage("bot", `عفواً، حدث خطأ أثناء محاولة استخلاص النص من الصورة. ${error.message}`, false, true);
            setStatus("فشل استخلاص النص من الصورة.", "error", 4000);
        }
    }
    
    function generateChatPrompt(userMessage) {
      const maxHistoryMessages = 8; 
      let relevantHistory = "";
      const textMessages = messages.filter(m => 
        !m.isImage && 
        !(m.sender === 'bot' && m.isSystemMessage && !m.isInitialWelcome && !m.text.includes("تم تفعيل وضع مادة") && !m.text.includes("تم الرجوع إلى وضع الدردشة العام"))
      );
      
      let currentBotDisplayName = getBotDisplayName();
      let baseSystemPrompt = `أنت ${currentBotDisplayName}، مساعد ذكاء اصطناعي ودود، صادق، إيجابي، وذكي جداً. هدفك هو مساعدة المستخدم والإجابة على أسئلته بوضوح وبطريقة تفاعلية ومفصلة. تجنب الردود المقتضبة جداً وحاول أن تكون محادثتك جذابة. إذا لم تعرف الإجابة، اعترف بذلك بلطف وحاول تقديم المساعدة إن أمكن. استخدم بعض الرموز التعبيرية بشكل مناسب ولكن باعتدال. إذا سألك المستخدم "من صنعك" أو "مين عملك" أو "من هو مطورك" أو أي سؤال مشابه، يجب أن تكون إجابتك دائمًا "أنا من صنع وتطوير سيف هاني".\n\n`;

      let finalSystemPrompt = baseSystemPrompt;

      if (currentSubject && currentSubject !== "general") {
          const subjectInstruction = `أنت الآن في وضع خبير مادة "${currentSubject}". جميع إجاباتك يجب أن تستند بشكل صارم وحصري إلى المنهج الدراسي المعتمد لمادة "${currentSubject}" في السياق التعليمي المصري إن أمكن، ما لم يحدد المستخدم خلاف ذلك. لا تقدم أي معلومات أو آراء خارج هذا النطاق المحدد. إذا كان السؤال لا يتعلق مباشرة بمنهج "${currentSubject}"، يجب عليك أن توضح أن السؤال خارج نطاق تخصص المادة الحالي وأنك تستطيع فقط الإجابة على الأسئلة المتعلقة بمنهج "${currentSubject}". لقد تم إعلام المستخدم بأن "الإجابات ستكون من المنهج الدراسي فقط". حافظ على تركيزك الكامل على مادة "${currentSubject}". ابدأ ردودك المتعلقة بالمادة بتأكيد أنك تجيب ضمن نطاق المادة.\n\n`;
          finalSystemPrompt = subjectInstruction + baseSystemPrompt; 
      }

      const startIndex = Math.max(0, textMessages.length - maxHistoryMessages);
      for (let i = startIndex; i < textMessages.length; i++) {
        const msg = textMessages[i];
        // Avoid including the generic part of the welcome message if chat history is short
        if (msg.sender === "bot" && msg.isInitialWelcome && textMessages.filter(m => m.sender === 'bot').length <= 2 && messages.length <= maxHistoryMessages + 2) {
            if (msg.text.includes("كيف يمكنني مساعدتك اليوم؟")) continue; // Skip generic welcome
        }
        relevantHistory += (msg.sender === "user" ? "المستخدم: " : (currentBotDisplayName + (msg.isSystemMessage && !msg.isInitialWelcome ? " (نظام)" : "") +": ")) + msg.text + "\n";
      }
      
      return `${finalSystemPrompt}${relevantHistory}المستخدم: ${userMessage}\n${currentBotDisplayName}:`;
    }

    async function fetchGeminiResponse(prompt) {
      if (!geminiApiKey) { 
          console.error("لم يتم تكوين مفتاح Gemini API.");
          throw new Error("عفواً، خدمة الذكاء الاصطناعي غير مكوّنة حالياً. (مفتاح Gemini مفقود)");
      }
      // If geminiApiKey is "AIzaSyBUqzhaui0pz0PqhCsVEpQYfOHsCYKtPBk" (your provided example), it will proceed.
      // For actual Gemini functionality, this key would need to be a valid, working key.

      const requestBody = {
        contents: [{ parts: [{ text: prompt }] }],
        // generationConfig: { // Example config, can be tuned
            // temperature: 0.7, 
            // maxOutputTokens: 2048, 
        // }
      };

      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiApiKey}`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(requestBody)
        });

        if(!response.ok) {
          const errorData = await response.json().catch(() => null); // Try to parse error
          console.error("استجابة خطأ من واجهة برمجة تطبيقات Gemini:", errorData || response.statusText);
          let errorMessage = `خطأ ${response.status}: ${response.statusText}.`;
          
          if (response.statusText && response.statusText.toLowerCase().includes("failed to fetch")) { // Specific check for network errors
             throw new Error("Failed to fetch"); // Re-throw a more specific error for handling
          }
          if (errorData && errorData.error && errorData.error.message) {
             if (errorData.error.message.toLowerCase().includes("api key") || errorData.error.message.toLowerCase().includes("permission")) {
                 errorMessage += " قد يكون هناك خطأ في إعدادات الطلب أو صلاحيات مفتاح Gemini.";
             } else {
                 errorMessage += ` التفاصيل: ${errorData.error.message.substring(0, 200)}`;
             }
          }
          throw new Error(errorMessage);
        }

        const data = await response.json();

        if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
          return data.candidates[0].content.parts[0].text;
        } else if (data.promptFeedback?.blockReason) {
            console.warn("تم حظر الطلب بواسطة واجهة برمجة تطبيقات Gemini:", data.promptFeedback.blockReason, data.promptFeedback.safetyRatings);
            return `لم أتمكن من معالجة طلبك بسبب سياسات المحتوى الخاصة بـ Gemini (السبب: ${data.promptFeedback.blockReason}). حاول تعديل سؤالك.`;
        } else if (data.candidates && data.candidates[0]?.finishReason) {
            // Handle cases where there might be partial content along with a finish reason
            let botMessage = (data.candidates[0].content?.parts?.[0]?.text || ""); // Get any partial text
            const reason = data.candidates[0].finishReason;
            if (reason === "SAFETY") {
                return botMessage + (botMessage ? "\n\n" : "") + "لم أتمكن من إكمال الرد بسبب قيود السلامة من Gemini. حاول تعديل سؤالك أو الموضوع.";
            } else if (reason === "MAX_TOKENS") {
                return botMessage + (botMessage ? "\n\n" : "") + "(تم اختصار الرد لأنه تجاوز الحد الأقصى للطول المسموح به من Gemini)";
            } else {
                 console.warn("استجابة واجهة برمجة تطبيقات Gemini مع finishReason ولكن بدون محتوى كافٍ:", reason, data);
                 return botMessage + (botMessage ? "\n\n" : "") + `لم يتم استلام رد مكتمل من Gemini (السبب: ${reason}).`;
            }
        } else {
          console.warn("تنسيق استجابة واجهة برمجة تطبيقات Gemini غير متوقع:", data);
          return "لم يتم استلام رد بالتنسيق الصحيح من خادم Gemini. قد يكون الرد غير كامل أو هناك مشكلة فنية.";
        }
      } catch (error) {
          console.error("خطأ في جلب الاستجابة من Gemini:", error);
          if (error.message && (error.message.toLowerCase().includes("api key") || (geminiApiKey && error.message.toLowerCase().includes(geminiApiKey.toLowerCase())))) {
              // Avoid exposing API key directly in user-facing error if it's part of the error message
              throw new Error("حدث خطأ أثناء الاتصال بخادم Gemini. يرجى مراجعة وحدة التحكم للمزيد من التفاصيل.");
          }
          throw error; // Re-throw other errors to be caught by processQueryWithAI
      }
    }

    async function processQueryWithAI(queryText) {
        if (!queryText || queryText.trim() === "") return;
        
        searchLog.textContent = `آخر استعلام: ${queryText.substring(0, 60)}${queryText.length > 60 ? '...' : ''}`;
        setStatus(`${getBotDisplayName()} يفكر بالاستعلام: "${queryText.substring(0,30)}..."`, "", null); 

        try {
            const prompt = generateChatPrompt(queryText);
            const responseText = await fetchGeminiResponse(prompt);
            addMessage("bot", responseText);
            setStatus("تم استلام الرد بنجاح! ✅", "success"); 

            successfulResponseCount++;
            localStorage.setItem(localStorageKeyAdCounter, successfulResponseCount.toString());

        } catch (error) {
            console.error("فشل إرسال الرسالة إلى Gemini أو معالجة الرد:", error);
            let displayError;
            if (error.message && error.message.toLowerCase().includes("failed to fetch")) {
                displayError = "فشل الاتصال بالخادم. يرجى التحقق من اتصالك بالإنترنت والمحاولة مرة أخرى.";
            } else if (error.message && error.message.includes("عفواً، خدمة الذكاء الاصطناعي غير مكوّنة حالياً.")) {
                displayError = error.message; // Use the specific message from fetchGeminiResponse
            } else {
                displayError = "عفواً، واجهت مشكلة أثناء محاولة معالجة طلبك مع Gemini. 😥";
                // Optionally add more detail if it's not a generic API key or connection error
                if (error.message && !error.message.includes("حدث خطأ أثناء الاتصال بخادم Gemini") && !error.message.toLowerCase().includes("api key")) {
                    displayError += " التفاصيل: " + error.message.substring(0,100); // Add a snippet of the error
                } else if (error.message.includes("حدث خطأ أثناء الاتصال بخادم Gemini")) {
                     displayError = "عفواً، واجهت مشكلة في الاتصال بخدمة Gemini."; // More generic for API key related issues
                }
            }
            addMessage("bot", displayError, false, true); 
            setStatus("فشل في الحصول على الرد من Gemini. ❌", "error"); 
        }
    }

    async function sendMessage() {
      const messageText = userInput.value.trim();
      if (!messageText) return;

      addMessage("user", messageText);
      userInput.value = ""; 
      autoResizeTextarea(); 

      userMessageCounterForAds++;
      if (userMessageCounterForAds % 4 === 0) { // Open ad every 4 user messages
        setTimeout(() => {
            window.open(AD_URL, '_blank');
            console.log(`تم فتح رابط الإعلان بعد الرسالة رقم ${userMessageCounterForAds} من المستخدم.`);
        }, 500); // Short delay before opening ad
      }
      
      await processQueryWithAI(messageText);
    }

    userInput.addEventListener("keydown", function(event) {
      if(event.key === "Enter" && !event.shiftKey) {
        event.preventDefault(); 
        sendMessage();
      }
    });
    userInput.addEventListener("input", autoResizeTextarea);
    
    function autoResizeTextarea() {
        userInput.style.height = 'auto'; // Temporarily shrink to get correct scrollHeight
        let newHeight = userInput.scrollHeight;
        const maxHeight = parseInt(getComputedStyle(userInput).maxHeight) || 90; // Fallback to 90px if not set
        
        if (newHeight > maxHeight) {
            newHeight = maxHeight;
            userInput.style.overflowY = 'auto'; // Show scrollbar if content exceeds max-height
        } else {
            userInput.style.overflowY = 'hidden'; // Hide scrollbar if content is within bounds
        }
        userInput.style.height = newHeight + 'px';
    }
    
    async function openCamera() {
        uploadOptionsContainer.classList.remove('active'); 
        if (!checkImageUploadLimit()) return;

        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
                cameraView.srcObject = cameraStream;
                cameraModal.style.display = "flex"; 
            } catch (err) {
                console.error("خطأ في الوصول إلى الكاميرا:", err);
                setStatus("لا يمكن الوصول إلى الكاميرا. تأكد من منح الأذونات.", "error", 4000);
                addMessage("bot", "عفواً، لم أتمكن من الوصول إلى الكاميرا. يرجى التأكد من أنك سمحت بالوصول إليها في إعدادات المتصفح.", false, true);
            }
        } else {
            setStatus("متصفحك لا يدعم الوصول إلى الكاميرا.", "error", 4000);
            addMessage("bot","عفواً، يبدو أن متصفحك لا يدعم ميزة استخدام الكاميرا.", false, true);
        }
    }

    function closeCamera() {
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop()); 
        }
        cameraView.srcObject = null; 
        cameraModal.style.display = "none"; 
    }

    async function captureImageFromCamera() {
        const canvas = document.createElement('canvas');
        canvas.width = cameraView.videoWidth;
        canvas.height = cameraView.videoHeight;
        const context = canvas.getContext('2d');
        context.drawImage(cameraView, 0, 0, canvas.width, canvas.height);
        
        closeCamera(); // Close camera immediately after capture

        canvas.toBlob(async (blob) => {
            if (blob) {
                const capturedFile = new File([blob], `capture-${Date.now()}.jpg`, { type: 'image/jpeg' });
                await processAndUploadImageFile(capturedFile); // Reuse existing image processing logic
            } else {
                 setStatus("فشل التقاط الصورة.", "error", 3000);
                 addMessage("bot", "عفواً، حدث خطأ أثناء محاولة التقاط الصورة من الكاميرا.", false, true);
            }
        }, 'image/jpeg', 0.9); // Use JPEG format with 90% quality
    }

    initializeApp();
  </script>

</body>
</html>
