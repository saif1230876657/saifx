<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Saif AI - دردشة ذكاء اصطناعي</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --primary-hue: 205;
      --primary-saturation: 75%;
      --primary-lightness: 42%;

      --primary-color: hsl(var(--primary-hue), var(--primary-saturation), var(--primary-lightness));
      --primary-hover-color: hsl(var(--primary-hue), var(--primary-saturation), calc(var(--primary-lightness) - 5%));
      --primary-glow-color: hsla(var(--primary-hue), var(--primary-saturation), calc(var(--primary-lightness) + 10%), 0.5);

      --secondary-color: #6a7bff;
      --accent-color: #ff7eb3;
      
      --bg-main: #1a1d1e;
      --bg-surface: #24292b;
      --bg-surface-raised: #2e3335;
      --bg-input: #2e3335;

      --text-primary: #eef2f4;
      --text-secondary: #a5b3c1;
      --text-on-primary: #ffffff;
      
      --border-color: #3c4245;
      --border-color-light: #4d5458;
      
      --success-color: #4ac97c;
      --error-color: #ff6b6b;
      
      --user-message-bg: var(--secondary-color);
      --bot-message-bg: var(--bg-surface-raised);

      --shadow-xs: 0 1px 3px rgba(0,0,0,0.3);
      --shadow-sm: 0 4px 6px rgba(0,0,0,0.35);
      --shadow-md: 0 6px 12px rgba(0,0,0,0.4);
      --shadow-lg: 0 12px 24px rgba(0,0,0,0.45);
      
      --border-radius-sm: 8px;
      --border-radius-md: 12px;
      --border-radius-lg: 16px;
      --border-radius-xl: 24px;
      --border-radius-lg-buttons: 12px; 

      --chat-input-area-height: 60px; 
      --status-bar-area-height: 25px; 
      --search-log-area-height: 20px; 

      --scroll-btn-size: 42px; 
      --scroll-btn-spacing: 10px; 
    }

    * {
      box-sizing: border-box;
      font-family: 'Tajawal', sans-serif;
      margin: 0;
      padding: 0;
      scrollbar-width: thin;
      scrollbar-color: var(--primary-color) var(--bg-surface);
    }

    *::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    *::-webkit-scrollbar-track {
      background: var(--bg-surface);
      border-radius: 3px;
    }
    *::-webkit-scrollbar-thumb {
      background-color: var(--primary-color);
      border-radius: 3px;
    }

    html, body {
      height: 100%; 
      font-smooth: antialiased;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      margin: 0; 
      padding: 0; 
    }

    body {
      background: linear-gradient(135deg, #141618 0%, #1c2023 100%);
      display: flex;
      justify-content: center;
      align-items: center;
      color: var(--text-primary);
      overflow: hidden; 
      padding: 15px;
    }

    .container {
      width: 100%;
      max-width: 800px;
      height: 100%; 
      background: var(--bg-surface); 
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-lg);
      display: flex;
      flex-direction: column; 
      overflow: hidden; 
      position: relative; 
      box-shadow: var(--shadow-lg);
    }

    .header {
      background: linear-gradient(to right, var(--bg-surface-raised), var(--bg-surface));
      color: var(--text-primary);
      padding: 0.8rem 1.2rem; 
      display: flex;
      align-items: center;
      gap: 0.8rem; 
      position: relative; 
      border-bottom: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
      flex-shrink: 0; 
      z-index: 10; 
    }

    .header .delete-all-btn {
      cursor: pointer;
      transition: color 0.2s ease-in-out, transform 0.2s ease;
      color: var(--text-secondary);
      font-size: 1.1rem; 
      z-index: 11; 
      order: -1; 
      margin-right: auto; 
    }
    .delete-all-btn:hover {
      color: var(--error-color);
      transform: rotate(10deg) scale(1.1);
    }
    
    .header .fas.fa-robot {
      font-size: 1.6rem; 
      color: var(--primary-color);
      background: rgba(106, 123, 255, 0.1);
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      animation: pulseIcon 2.5s infinite ease-in-out;
    }

    @keyframes pulseIcon {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.8; box-shadow: 0 0 15px var(--primary-glow-color); }
    }
    
    .header h1 {
      font-size: 1.25rem; 
      font-weight: 700;
      color: var(--primary-color); 
      letter-spacing: 0.5px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-left: 0.4rem; 
      margin-right: 0.4rem;
      flex-grow: 0; 
      text-align: center;
      text-shadow: 0 0 8px rgba(106, 123, 255, 0.3);
    }

    #subjectControls {
        display: flex;
        gap: 0.8rem; 
    }

    .header-btn {
        background-color: var(--bg-surface-raised); 
        color: var(--text-primary);
        border: 1px solid var(--border-color-light);
        padding: 0.6rem 1rem; 
        border-radius: var(--border-radius-md); 
        cursor: pointer;
        font-size: 0.85rem; 
        font-weight: 500;
        transition: all 0.25s ease;
        white-space: nowrap;
        box-shadow: var(--shadow-xs);
    }
    .header-btn:hover {
        background-color: var(--primary-color);
        color: var(--text-on-primary);
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: var(--shadow-sm), 0 0 10px var(--primary-glow-color);
    }
    .header-btn:active {
        transform: translateY(0px);
        box-shadow: var(--shadow-xs);
    }

    .chat-container {
      flex: 1; 
      padding: 1.2rem 0.9rem; 
      overflow-y: auto; 
      background: var(--bg-main);
      scroll-behavior: smooth; 
      min-height: 0; 
      background-image: 
        radial-gradient(circle at 10% 20%, rgba(42, 60, 87, 0.05) 0%, transparent 20%),
        radial-gradient(circle at 90% 80%, rgba(106, 123, 255, 0.05) 0%, transparent 20%);
    }

    .message {
      margin-bottom: 1.4rem; 
      display: flex;
      flex-direction: column;
      animation: messageAppear 0.4s ease-out;
    }

    @keyframes messageAppear {
      from { opacity: 0; transform: translateY(15px) scale(0.98); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .message-header {
      font-size: 0.75rem; 
      color: var(--text-secondary);
      margin-bottom: 0.3rem;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      padding: 0 8px; 
    }

    .delete-btn {
      color: var(--text-secondary);
      font-size: 0.8rem; 
      cursor: pointer;
      transition: color 0.2s, transform 0.2s;
      opacity: 0.5; 
      background: rgba(255,255,255,0.05);
      padding: 3px 5px;
      border-radius: 4px;
    }

    .delete-btn:hover {
      opacity: 1;
      color: var(--error-color);
      transform: scale(1.15);
      background: rgba(255,107,107,0.1);
    }

    .message.user {
      align-items: flex-end;
    }
    .message.user .message-header {
      flex-direction: row-reverse; 
    }

    .message.bot {
      align-items: flex-start;
    }

    .bubble {
      max-width: 80%; 
      padding: 0.9rem 1.2rem; 
      border-radius: var(--border-radius-md); 
      word-wrap: break-word;
      white-space: pre-wrap;
      line-height: 1.65;
      transition: all 0.25s ease;
      box-shadow: var(--shadow-xs);
      position: relative;
    }

    .message.user .bubble {
      background: var(--user-message-bg);
      color: var(--text-on-primary);
      border-bottom-right-radius: var(--border-radius-sm); 
    }

    .message.bot .bubble {
      background: var(--bot-message-bg);
      color: var(--text-primary);
      border-bottom-left-radius: var(--border-radius-sm); 
      border: 1px solid rgba(255,255,255,0.05);
    }

    .message:hover .bubble {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .message-actions {
      margin-top: 8px;
      display: flex;
      gap: 8px; 
      padding: 0 8px; 
    }
    .message.user .message-actions { 
        justify-content: flex-end;
    }

    .message-actions button {
      background: rgba(255,255,255,0.08); 
      border: 1px solid var(--border-color-light); 
      cursor: pointer;
      font-size: 0.9rem; 
      padding: 5px 9px; 
      color: var(--text-secondary);
      transition: all 0.25s ease;
      border-radius: var(--border-radius-sm);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .message-actions button:hover {
      color: var(--text-on-primary);
      background-color: var(--primary-color);
      border-color: var(--primary-color);
      box-shadow: 0 0 10px var(--primary-glow-color);
    }

    .message-actions button.liked {
      color: var(--success-color);
      border-color: var(--success-color);
      background: rgba(74, 201, 124, 0.1);
    }
     .message-actions button.liked:hover {
      background-color: var(--success-color);
      color: var(--text-on-primary);
      box-shadow: 0 0 10px rgba(74, 201, 124, 0.4);
    }
    .message-actions button.retry-btn i { 
      color: hsl(var(--primary-hue), var(--primary-saturation), calc(var(--primary-lightness) + 15%));
    }
    .message-actions button.retry-btn:hover i {
      color: var(--text-on-primary); 
    }


    .chat-input {
      display: flex;
      align-items: flex-end; 
      border-top: 1px solid var(--border-color);
      padding: 0.8rem 1rem; 
      background: var(--bg-surface); 
      gap: 0.8rem; 
      position: relative; 
      z-index: 5; 
      flex-shrink: 0; 
      min-height: var(--chat-input-area-height); 
    }

    .chat-input textarea {
      flex: 1;
      padding: 0.8rem 1.1rem; 
      border: 1px solid var(--border-color);
      resize: none;
      font-size: 0.95rem;
      outline: none;
      border-radius: var(--border-radius-xl); 
      background: var(--bg-input);
      color: var(--text-primary);
      max-height: 120px; 
      line-height: 1.6;
      transition: border-color 0.25s ease, box-shadow 0.25s ease;
    }
     .chat-input textarea::placeholder {
        color: var(--text-secondary);
        opacity: 0.6;
     }
     .chat-input textarea:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px var(--primary-glow-color);
     }

    .chat-input-btn { 
      background: var(--primary-color);
      border: none;
      color: var(--text-on-primary);
      width: 44px; 
      height: 44px; 
      border-radius: 50%; 
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.1rem; 
      transition: all 0.25s ease;
      flex-shrink: 0; 
      box-shadow: var(--shadow-sm);
    }
    .chat-input-btn:hover {
      background: var(--primary-hover-color);
      transform: scale(1.08);
      box-shadow: 0 0 15px var(--primary-glow-color);
    }
    .chat-input-btn:active {
        transform: scale(0.92);
    }
    
    .chat-input-btn.recording {
        background: var(--error-color);
        animation: pulseRecording 1.5s infinite;
    }
    
    @keyframes pulseRecording {
        0% { box-shadow: 0 0 0 0 rgba(255,107,107,0.5); }
        70% { box-shadow: 0 0 0 12px rgba(255,107,107,0); }
        100% { box-shadow: 0 0 0 0 rgba(255,107,107,0); }
    }

    #imageUpload {
      display: none;
    }

    .upload-options-container {
      position: absolute;
      bottom: calc(100% + 8px); 
      right: 55px; 
      background-color: var(--bg-surface-raised);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-md);
      box-shadow: var(--shadow-md);
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 10px;
      z-index: 10;
      opacity: 0;
      visibility: hidden;
      transform: translateY(10px);
      transition: all 0.3s ease;
    }
    .upload-options-container.active {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    .upload-options-container button {
      background-color: var(--bg-input);
      color: var(--text-secondary);
      border: 1px solid var(--border-color-light);
      padding: 10px 14px;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
      transition: all 0.25s ease;
    }
    .upload-options-container button:hover {
      background-color: var(--primary-color);
      color: var(--text-on-primary);
      border-color: var(--primary-color);
      transform: translateY(-2px);
    }
    .upload-options-container button i {
      font-size: 1.1rem;
    }

    .status {
      text-align: center;
      padding: 0.4rem; 
      font-size: 0.8rem; 
      background-color: var(--bg-surface);
      color: var(--text-secondary);
      border-top: 1px solid var(--border-color);
      min-height: var(--status-bar-area-height); 
      transition: color 0.3s ease;
      flex-shrink: 0; 
      font-weight: 500;
    }

    .status.success { color: var(--success-color); }
    .status.error { color: var(--error-color); }

    a {
      color: var(--primary-color); 
      text-decoration: none;
      word-break: break-all;
      font-weight: 500;
    }

    a:hover {
      text-decoration: underline;
      color: hsl(var(--primary-hue), var(--primary-saturation), calc(var(--primary-lightness) + 10%)); 
    }

    .search-log {
      text-align: center;
      font-size: 0.75rem; 
      color: var(--text-secondary);
      opacity: 0.7; 
      padding: 0.2rem 0; 
      border-top: 1px dashed var(--border-color-light);
      background-color: var(--bg-main);
      min-height: var(--search-log-area-height);
      flex-shrink: 0; 
      font-weight: 500;
    }

    .toggle-details-btn {
      cursor: pointer;
      color: var(--primary-color);
      font-weight: 500;
      border: none;
      background: none;
      padding: 0;
      margin-top: 10px;
      display: block; 
      text-align: right; 
      font-size: 0.9rem;
      transition: color 0.25s ease;
    }

    .toggle-details-btn:hover {
      color: var(--accent-color);
      text-decoration: underline;
    }

    .camera-modal, .subject-modal { 
        display: none; 
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.8);
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(5px);
    }
    .camera-modal-content { 
        background-color: var(--bg-surface);
        padding: 25px;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-lg);
        text-align: center;
        max-width: 90%;
        max-height: 90%;
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative; 
        box-shadow: var(--shadow-lg);
    }
    .subject-modal-content {
        background-color: var(--bg-surface);
        padding: 30px; 
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-lg);
        text-align: center;
        max-width: 90%;
        width: 550px; 
        max-height: 90%;
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        box-shadow: var(--shadow-lg);
    }

    #cameraView {
        width: 100%;
        max-width: 450px;
        height: auto;
        border-radius: var(--border-radius-md);
        margin-bottom: 20px;
        background-color: #000; 
    }
    .camera-controls button { 
        background: var(--primary-color);
        border: none;
        color: var(--text-on-primary);
        padding: 12px 24px;
        font-size: 1rem;
        border-radius: var(--border-radius-md);
        cursor: pointer;
        margin: 8px; 
        transition: background-color 0.25s ease;
        font-weight: 500;
    }
     .camera-controls button:hover { 
        background: var(--primary-hover-color);
        transform: translateY(-2px);
    }
    .camera-controls button#cancelCameraBtn {
        background-color: var(--error-color);
    }
    .camera-controls button#cancelCameraBtn:hover {
        background-color: hsl(0, 90%, 45%); 
    }

    .subject-modal-content h2 {
        font-size: 1.8rem; 
        color: var(--primary-color);
        margin-bottom: 30px; 
        font-weight: 700;
        text-shadow: 0 0 10px rgba(106, 123, 255, 0.3);
    }
    .subject-modal-content .close-modal-btn {
        position: absolute;
        top: 15px;
        left: 20px; 
        font-size: 1.8rem;
        color: var(--text-secondary);
        cursor: pointer;
        background: none;
        border: none;
        padding: 0;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.25s ease;
    }
     .subject-modal-content .close-modal-btn:hover {
        color: var(--text-primary);
        background: rgba(255,255,255,0.1);
     }
    #subjectListContainer {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 18px; 
        margin-top: 20px;
        width: 100%;
    }
    #subjectListContainer button {
        background: var(--bg-input); 
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        padding: 16px 26px; 
        font-size: 1.05rem; 
        font-weight: 500;
        min-width: 160px; 
        border-radius: var(--border-radius-lg-buttons); 
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        box-shadow: var(--shadow-sm); 
    }
    #subjectListContainer button:hover {
        background-color: var(--primary-color);
        color: var(--text-on-primary);
        border-color: var(--primary-hover-color);
        transform: translateY(-4px) scale(1.03); 
        box-shadow: var(--shadow-md), 0 0 15px var(--primary-glow-color); 
    }
    #subjectListContainer button:active {
        transform: translateY(0px) scale(1);
    }

    .scroll-btn {
      position: absolute; 
      right: 25px;
      background-color: var(--primary-color);
      color: var(--text-on-primary);
      border: none;
      width: var(--scroll-btn-size);   
      height: var(--scroll-btn-size);  
      border-radius: 50%;
      display: none; 
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.1rem; 
      box-shadow: var(--shadow-md);
      transition: all 0.3s ease;
      z-index: 3; 
      opacity: 0;
      visibility: hidden;
    }
    .scroll-btn:hover {
      background-color: var(--primary-hover-color);
      transform: scale(1.12);
      box-shadow: 0 0 15px var(--primary-glow-color);
    }
    .scroll-btn.visible {
        display: flex;
        opacity: 0.85; 
        visibility: visible;
    }
    .scroll-btn.visible:hover {
        opacity: 1; 
    }

    #scrollToBottomBtn {
      bottom: calc(var(--chat-input-area-height) + var(--status-bar-area-height) + var(--search-log-area-height) + var(--scroll-btn-spacing));
    }
    #scrollToTopBtn {
      bottom: calc(var(--chat-input-area-height) + var(--status-bar-area-height) + var(--search-log-area-height) + var(--scroll-btn-spacing) + var(--scroll-btn-size) + var(--scroll-btn-spacing));
    }
    
    .voice-indicator {
        position: absolute;
        top: -30px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--error-color);
        color: white;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
        opacity: 0;
        transition: opacity 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .voice-indicator.active {
        opacity: 1;
    }

    /* Media Queries for Responsiveness */
    @media (max-width: 768px) { 
      .container {
        border-radius: 16px; 
      }
      body { 
        padding: 10px;
      }
      :root { 
        --chat-input-area-height: 55px; 
        --status-bar-area-height: 22px;
        --search-log-area-height: 18px;
        --scroll-btn-size: 38px;
        --scroll-btn-spacing: 8px;
      }
      .header { padding: 0.7rem 1rem; gap: 0.6rem;}
      .header h1 { font-size: 1.15rem; margin-left: 0.3rem; margin-right: 0.3rem;}
      .header .fas.fa-robot { font-size: 1.4rem; width: 36px; height: 36px; }
      .delete-all-btn { font-size: 1.05rem; }
      .header-btn { font-size: 0.8rem; padding: 0.5rem 0.8rem;}
      #subjectControls { gap: 0.5rem;}

      .bubble { max-width: 85%; padding: 0.8rem 1rem; line-height: 1.6; }
      .chat-input { padding: 0.6rem 0.8rem; gap: 0.6rem; } 
      .chat-input textarea { font-size: 0.9rem; padding: 0.7rem 1rem; } 
      .chat-input-btn { width: 40px; height: 40px; font-size: 1rem; } 
      .upload-options-container { right: 48px; } 
      .upload-options-container button { padding: 8px 12px; font-size: 0.85rem; }
    }

    @media (max-width: 480px) { 
      :root {
        --chat-input-area-height: 52px; 
        --status-bar-area-height: 20px;
        --search-log-area-height: 16px;
        --scroll-btn-size: 36px;
        --scroll-btn-spacing: 6px;
      }
       body { 
        padding: 8px;
      }
      .header { 
        padding: 0.6rem 0.8rem; 
        gap: 0.4rem; 
        flex-wrap: wrap; 
        justify-content: center;
      }
       .header .delete-all-btn {
        order: 1; 
        margin: 0 4px; 
        font-size: 1rem;
      }
      .header .fas.fa-robot {
        order: 2;
        margin: 0 4px;
        font-size: 1.3rem;
        width: 34px;
        height: 34px;
      }
      .header h1 { 
        order: 3;
        font-size: 1.1rem; 
        width: 100%; 
        text-align: center;
        margin: 5px 0; 
      }
      #subjectControls { 
        order: 4; 
        width: 100%; 
        justify-content: center; 
        margin-top: 0.3rem; 
        gap: 0.5rem;
      }
      
      .subject-modal-content {
        width: 92%;
        padding: 20px;
      }
      .subject-modal-content h2 {
        font-size: 1.6rem;
        margin-bottom: 20px;
      }
      #subjectListContainer button {
        padding: 14px 20px;
        font-size: 0.95rem;
        min-width: 140px;
      }

      .chat-container { padding: 1rem 0.6rem; }
      .message-header { font-size: 0.7rem; gap: 5px; }
      .bubble { max-width: 90%; padding: 0.7rem 0.9rem; line-height: 1.55; }
      .message-actions button { font-size: 0.85rem; padding: 4px 8px; }
      
      .chat-input { padding: 0.5rem 0.6rem; gap: 0.5rem; }
      .chat-input textarea { font-size: 0.85rem; padding: 0.6rem 0.9rem; max-height: 100px; }
      .chat-input-btn { width: 38px; height: 38px; font-size: 0.95rem; }
      .upload-options-container { right: 44px; } 
      .upload-options-container button { padding: 7px 10px; font-size: 0.8rem; }
      .upload-options-container button i { font-size: 1rem; }
      .status { font-size: 0.75rem; padding: 0.3rem;}
      .search-log { font-size: 0.7rem; padding: 0.15rem 0;}
      .scroll-btn { right: 18px; }
      .toggle-details-btn { font-size: 0.85rem; }
      .header-btn { font-size: 0.75rem; padding: 0.4rem 0.7rem;}
    }

    @media (max-width: 360px) { 
       :root {
        --chat-input-area-height: 50px;
        --status-bar-area-height: 20px; 
        --search-log-area-height: 15px;
        --scroll-btn-size: 34px;
       }
      .header h1 { font-size: 1rem; }
      .bubble { padding: 0.6rem 0.8rem; }
      .chat-input textarea { padding: 0.5rem 0.8rem; }
      .chat-input-btn { width: 36px; height: 36px; }
      .upload-options-container { right: 42px; } 
    }

  </style>
</head><body>
  <div class="container">
    <header class="header">
      <i class="fas fa-trash delete-all-btn" onclick="deleteAllMessages()" title="حذف كل الرسائل"></i>
      <i class="fas fa-robot"></i>
      <h1 id="botName">Saif AI</h1>
      <div id="subjectControls">
        <button id="enterSubjectsBtn" class="header-btn">مواد متخصصة</button>
        <button id="generalChatBtn" class="header-btn" style="display: none;">عام</button>
      </div>
    </header>

    <div id="chatContainer" class="chat-container">
      <!-- Messages will be here -->
    </div>

    <button id="scrollToTopBtn" class="scroll-btn" title="الانتقال إلى الأعلى">
      <i class="fas fa-arrow-up"></i>
    </button>
    <button id="scrollToBottomBtn" class="scroll-btn" title="الانتقال إلى الأسفل">
      <i class="fas fa-arrow-down"></i>
    </button>

    <div id="searchLog" class="search-log"></div>
    <div class="status" id="statusBar"></div>

    <div class="chat-input">
      <textarea id="userInput" rows="1" placeholder="اكتب رسالتك هنا..."></textarea>
      
      <div class="voice-indicator" id="voiceIndicator">
        <i class="fas fa-microphone"></i>
        <span>جاري الاستماع...</span>
      </div>
      
      <div class="upload-options-container" id="uploadOptionsContainer">
        <button onclick="triggerImageUpload()">
          <i class="fas fa-images"></i> رفع من المعرض
        </button>
        <button onclick="openCamera()">
          <i class="fas fa-camera"></i> استخدام الكاميرا
        </button>
      </div>
      
      <button class="chat-input-btn" id="toggleUploadBtn" title="إرفاق ملف">
        <i class="fas fa-plus"></i>
      </button>
      
      <button class="chat-input-btn" id="voiceInputBtn" title="التحدث">
        <i class="fas fa-microphone"></i>
      </button>
      
      <button class="chat-input-btn" onclick="sendMessage()" title="إرسال">
        <i class="fas fa-paper-plane"></i>
      </button>
      <input id="imageUpload" type="file" accept="image/*" onchange="handleFileSelect(event)" />
    </div>
  </div>

  <!-- Camera Modal -->
  <div id="cameraModal" class="camera-modal">
    <div class="camera-modal-content">
      <video id="cameraView" autoplay playsinline></video>
      <div class="camera-controls">
        <button id="captureBtn">التقاط صورة</button>
        <button id="cancelCameraBtn">إلغاء</button>
      </div>
    </div>
  </div>

  <!-- Subject Selection Modal -->
  <div id="subjectModal" class="subject-modal">
    <div class="subject-modal-content">
      <button class="close-modal-btn" onclick="closeSubjectModal()" title="إغلاق">×</button>
      <h2>اختر المادة</h2>
      <div id="subjectListContainer">
        <!-- Subject buttons will be populated here -->
      </div>
    </div>
  </div>

  <script>
    const geminiApiKey = "AIzaSyBUqzhaui0pz0PqhCsVEpQYfOHsCYKtPBk"; 
    const ocrApiKey = "K83201031288957";     

    const chatContainer = document.getElementById("chatContainer");
    const statusBar = document.getElementById("statusBar");
    const searchLog = document.getElementById("searchLog");
    const userInput = document.getElementById("userInput");
    const botNameElement = document.getElementById("botName");
    const imageUploadInput = document.getElementById("imageUpload");
    const toggleUploadBtn = document.getElementById("toggleUploadBtn");
    const uploadOptionsContainer = document.getElementById("uploadOptionsContainer");
    const scrollToTopBtn = document.getElementById('scrollToTopBtn');
    const scrollToBottomBtn = document.getElementById('scrollToBottomBtn');
    const voiceInputBtn = document.getElementById('voiceInputBtn');
    const voiceIndicator = document.getElementById('voiceIndicator');

    const cameraModal = document.getElementById('cameraModal');
    const cameraView = document.getElementById('cameraView');
    const captureBtn = document.getElementById('captureBtn');
    const cancelCameraBtn = document.getElementById('cancelCameraBtn');
    let cameraStream = null;

    const enterSubjectsBtn = document.getElementById('enterSubjectsBtn');
    const generalChatBtn = document.getElementById('generalChatBtn');
    const subjectModal = document.getElementById('subjectModal');
    const subjectListContainer = document.getElementById('subjectListContainer');

    const botName = "سيف AI";
    const localStorageKeyAllChats = "saifAiAllChatsHistory_v2"; 
    const localStorageKeyAdCounter = "saifAiAdCounter";
    const localStorageKeyImageUploadDate = "saifAiImageUploadDate";
    const localStorageKeyImageUploadCount = "saifAiImageUploadCount";
    const localStorageKeyCurrentSubject = "saifAiCurrentSubject_v2";


    const AD_URL = "https://www.profitableratecpm.com/k8fisnjjc?key=afa7ea920578f74cea5997d670bbe78e";
    const AD_DELAY_MS = 10000; 

    let allMessages = {}; 
    let messages = [];    
    
    let successfulResponseCount = 0;
    let userMessageCounterForAds = 0;
    let statusTimeout;
    
    let currentSubject = "general"; 
    const subjects = ["فيزياء", "كيمياء", "أحياء", "علوم", "لغة عربية", "فلسفة", "لغة إنجليزية", "رياضيات", "تربية دينية"];
    
    let recognition;
    let isListening = false;

    // Initialize speech recognition
    function initSpeechRecognition() {
        if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'ar-SA';

            recognition.onstart = function() {
                isListening = true;
                voiceInputBtn.classList.add('recording');
                voiceIndicator.classList.add('active');
                setStatus("جاري الاستماع...", "", null);
            };

            recognition.onresult = function(event) {
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        transcript += event.results[i][0].transcript;
                    } else {
                        // Keep appending interim results to show live transcription
                        transcript += event.results[i][0].transcript;
                    }
                }
                userInput.value = transcript;
                autoResizeTextarea();
            };

            recognition.onerror = function(event) {
                console.error('Speech recognition error', event.error);
                let userMessage = "حدث خطأ في التعرف على الصوت: ";
                switch (event.error) {
                    case 'no-speech':
                        userMessage += "لم يتم اكتشاف أي كلام. حاول التحدث بوضوح.";
                        break;
                    case 'audio-capture':
                        userMessage += "مشكلة في التقاط الصوت. تأكد أن الميكروفون يعمل.";
                        break;
                    case 'not-allowed':
                        userMessage += "لم يتم منح الإذن لاستخدام الميكروفون.";
                        break;
                    case 'network':
                        userMessage += "مشكلة في الشبكة. يتطلب التعرف على الصوت اتصالاً بالإنترنت.";
                        break;
                    default:
                        userMessage += event.error;
                }
                setStatus(userMessage, "error", 4000);
                stopListening();
            };

            recognition.onend = function() {
                stopListening();
                 // If there's final text, user can press send.
            };
        } else {
            voiceInputBtn.style.display = 'none'; // Hide button if not supported
            setStatus("المتصفح لا يدعم التعرف على الصوت", "error", 3000);
        }
    }
    
    function toggleListening() {
        if (!recognition) {
            setStatus("ميزة التعرف على الصوت غير متاحة.", "error", 3000);
            return;
        }
        if (isListening) {
            recognition.stop();
        } else {
            try {
                userInput.value = ""; // Clear previous text before starting new recognition
                autoResizeTextarea();
                recognition.start();
            } catch (e) {
                console.error("Error starting speech recognition:", e);
                // This catch might be for immediate errors like "recognition already started"
                // The `onerror` handler above is for errors during the recognition process.
                setStatus("لا يمكن بدء التعرف على الصوت. قد يكون قيد الاستخدام بالفعل.", "error", 3000);
                stopListening(); // Ensure UI is reset
            }
        }
    }
    
    function stopListening() {
        isListening = false;
        voiceInputBtn.classList.remove('recording');
        voiceIndicator.classList.remove('active');
        // Check if status was "جاري الاستماع..." and clear it if no other status is pending
        if (statusBar.textContent === "جاري الاستماع...") {
            setStatus("", "", 100); // Clear after a very short delay
        }
    }

    function initializeApp() {
        const storedAdCount = localStorage.getItem(localStorageKeyAdCounter);
        if (storedAdCount) {
            successfulResponseCount = parseInt(storedAdCount, 10) || 0;
        }

        loadAllMessagesAndSetCurrent(); 

        const storedSubject = localStorage.getItem(localStorageKeyCurrentSubject);
        if (storedSubject && (subjects.includes(storedSubject) || storedSubject === "general")) {
            currentSubject = storedSubject;
        } else {
            currentSubject = "general"; 
        }
        
        if (!allMessages[currentSubject]) {
            allMessages[currentSubject] = [];
        }
        messages = allMessages[currentSubject];


        updateSubjectUI(); 
        botNameElement.textContent = getBotDisplayName(); 

        addWelcomeMessage(); 
        refreshChat();
        autoResizeTextarea();

        toggleUploadBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            uploadOptionsContainer.classList.toggle('active');
        });

        document.addEventListener('click', (e) => {
            if (!uploadOptionsContainer.contains(e.target) && !toggleUploadBtn.contains(e.target) &&
                !subjectModal.contains(e.target) && e.target !== enterSubjectsBtn) { 
                uploadOptionsContainer.classList.remove('active');
            }
        });

        captureBtn.addEventListener('click', captureImageFromCamera);
        cancelCameraBtn.addEventListener('click', closeCamera);

        scrollToTopBtn.addEventListener('click', () => {
            chatContainer.scrollTo({ top: 0, behavior: 'smooth' });
        });

        scrollToBottomBtn.addEventListener('click', () => {
            chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
        });

        chatContainer.addEventListener('scroll', () => {
            const scrollTop = chatContainer.scrollTop;
            const scrollHeight = chatContainer.scrollHeight;
            const clientHeight = chatContainer.clientHeight;
            const scrollThreshold = 150; // Pixels from top/bottom to show buttons

            // Show/hide scroll to top button
            if (scrollTop > scrollThreshold) {
                scrollToTopBtn.classList.add('visible');
            } else {
                scrollToTopBtn.classList.remove('visible');
            }

            // Show/hide scroll to bottom button
            if (scrollHeight > clientHeight && scrollHeight - scrollTop - clientHeight > scrollThreshold) {
                scrollToBottomBtn.classList.add('visible');
            } else {
                scrollToBottomBtn.classList.remove('visible');
            }
        });
        chatContainer.dispatchEvent(new Event('scroll')); // Initial check

        enterSubjectsBtn.addEventListener('click', openSubjectModal);
        generalChatBtn.addEventListener('click', switchToGeneralMode);
        populateSubjectList();
        
        // Initialize voice recognition
        initSpeechRecognition();
        voiceInputBtn.addEventListener('click', toggleListening);
    }

    function getBotDisplayName() {
        if (currentSubject === "general") {
            return botName;
        }
        return `${botName} (${currentSubject})`;
    }
    
    function updateSubjectUI() {
        botNameElement.textContent = getBotDisplayName();
        if (currentSubject === "general") {
            generalChatBtn.style.display = 'none';
            enterSubjectsBtn.textContent = "مواد متخصصة";
        } else {
            generalChatBtn.style.display = 'inline-block'; 
            enterSubjectsBtn.textContent = `مادة: ${currentSubject}`;
        }
        localStorage.setItem(localStorageKeyCurrentSubject, currentSubject);
    }

    function openSubjectModal() {
        subjectModal.style.display = "flex";
    }

    function closeSubjectModal() {
        subjectModal.style.display = "none";
    }

    function populateSubjectList() {
        subjectListContainer.innerHTML = '';
        subjects.forEach(subject => {
            const btn = document.createElement('button');
            btn.textContent = subject;
            btn.onclick = () => selectSubject(subject);
            subjectListContainer.appendChild(btn);
        });
    }

    function selectSubject(subject) {
        if (currentSubject === subject) { 
            closeSubjectModal();
            return;
        }
        allMessages[currentSubject] = messages; // Save current subject's messages

        currentSubject = subject;
        messages = allMessages[currentSubject] || []; // Load new subject's messages or initialize
        if (!allMessages[currentSubject]) { // Ensure array exists for new subject
             allMessages[currentSubject] = []; 
        }

        updateSubjectUI();
        closeSubjectModal();
        addWelcomeMessage(); // Add or update welcome message for the new subject
        refreshChat(); 
        setStatus(`تم التحويل إلى وضع مادة: ${currentSubject}`, "success", 3000);
        saveAllMessagesToLocalStorage(); // Save all chats including the newly initialized one
    }

    function switchToGeneralMode() {
        if (currentSubject === "general") return; 

        allMessages[currentSubject] = messages; // Save current subject's messages

        currentSubject = "general";
        messages = allMessages[currentSubject] || []; // Load general chat messages or initialize
         if (!allMessages[currentSubject]) { // Ensure array exists for general chat
             allMessages[currentSubject] = [];
        }

        updateSubjectUI();
        addWelcomeMessage(); // Add or update welcome message for general mode
        refreshChat(); 
        setStatus("تم الرجوع إلى الوضع العام", "success", 3000);
        saveAllMessagesToLocalStorage();
    }


    function loadAllMessagesAndSetCurrent() {
        const storedAllMessages = localStorage.getItem(localStorageKeyAllChats);
        if (storedAllMessages) {
            try {
                const parsed = JSON.parse(storedAllMessages);
                if (typeof parsed === 'object' && parsed !== null) {
                    allMessages = parsed;
                    // Ensure all message arrays have correct Date objects
                    for (const subjectKey in allMessages) {
                        if (Object.hasOwnProperty.call(allMessages, subjectKey) && Array.isArray(allMessages[subjectKey])) {
                            allMessages[subjectKey] = allMessages[subjectKey].map(msg => ({
                                ...msg,
                                timestamp: new Date(msg.timestamp) // Re-hydrate Date objects
                            }));
                        } else {
                             // If a key exists but isn't an array (corrupted), reset it
                             allMessages[subjectKey] = []; 
                        }
                    }
                } else {
                    // If stored data is not an object (e.g., just "null" string or a primitive)
                    allMessages = {}; 
                }
            } catch (e) {
                console.error("خطأ في تحليل هيكل الرسائل الكلي من التخزين المحلي:", e);
                allMessages = {}; // Reset on error
                localStorage.removeItem(localStorageKeyAllChats); // Consider removing corrupted data
            }
        } else {
            allMessages = {}; // Initialize if nothing is stored
        }
        // Ensure "general" chat always has an array
        if (!allMessages["general"] || !Array.isArray(allMessages["general"])) {
            allMessages["general"] = [];
        }
    }

    function saveAllMessagesToLocalStorage() {
        if (currentSubject && messages) { // Ensure current subject and its messages are up-to-date
           allMessages[currentSubject] = messages;
        }
        localStorage.setItem(localStorageKeyAllChats, JSON.stringify(allMessages));
    }

    function addWelcomeMessage() {
        let welcomeMsgText = `مرحباً بك! أنا ${getBotDisplayName()}، كيف يمكنني مساعدتك اليوم؟ 💡 يمكنك رفع صورتين يوميًا وسأحاول استخلاص النص منها وإرساله للتحليل.`;
        if (currentSubject !== "general") {
             welcomeMsgText = `مرحباً! أنا ${getBotDisplayName()}. حاليًا في وضع الإجابة عن أسئلة مادة ${currentSubject} بناءً على المنهج الدراسي. كيف يمكنني مساعدتك ضمن هذا الإطار؟`;
        }
      
        // Remove any old initial welcome messages first to avoid duplicates if logic changes
        if (!messages.some(m => m.isInitialWelcome && m.sender === "bot")) {
            messages = messages.filter(m => !m.isInitialWelcome); // Clean up any stray welcome messages
            
            const welcomeMessageObject = {
                sender: "bot",
                text: welcomeMsgText,
                isImage: false,
                isSystemMessage: true, // Treat welcome as a system message for styling/filtering if needed
                timestamp: new Date(),
                isInitialWelcome: true
            };
            messages.unshift(welcomeMessageObject); // Add to the beginning
            allMessages[currentSubject] = messages; // Update the main store
            saveAllMessagesToLocalStorage(); // Persist
        } else {
            // If a welcome message exists, update its text if it's different
            // This is useful if the bot's name or subject changes and the welcome message needs to reflect that
            const welcomeIndex = messages.findIndex(m => m.isInitialWelcome && m.sender === "bot");
            if (welcomeIndex !== -1 && messages[welcomeIndex].text !== welcomeMsgText) {
                messages[welcomeIndex].text = welcomeMsgText;
                allMessages[currentSubject] = messages;
                saveAllMessagesToLocalStorage();
            }
        }
    }

    function addMessage(sender, text, isImage = false, isSystemMessage = false, isInitialWelcome = false) {
      const message = { sender, text, isImage, isSystemMessage, timestamp: new Date(), isInitialWelcome };
      
      messages.push(message);
      allMessages[currentSubject] = messages; // Keep the global store updated
      
      // Check if near bottom BEFORE adding the new message element to DOM
      const wasNearBottom = chatContainer.scrollHeight - chatContainer.scrollTop - chatContainer.clientHeight < 150;

      refreshChat(); // This will re-render everything, including the new message

      // Scroll logic after refreshChat
      if (sender === 'user') {
          chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
      } else if (isInitialWelcome) {
          // Only scroll for welcome if it's one of the very first messages
          if (messages.length <= 2) { // e.g. only welcome, or welcome + 1 user msg
            chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
          }
      } else if (wasNearBottom && !isImage) { // For bot text responses, if user was near bottom
          chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
      }
      // Image scrolling is handled by img.onload in refreshChat
    }

    function linkifyAndFormatText(text) {
      if (typeof text !== 'string') return '';
      // Regex to find URLs
      const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
      // Replace URLs with anchor tags
      const linkedText = text.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
      // Replace newlines with <br> for HTML display
      return linkedText.replace(/\n/g, '<br>');
    }

    function refreshChat() {
      chatContainer.innerHTML = ""; // Clear existing messages
      messages.forEach((msg, index) => {
        const messageElem = document.createElement("div");
        messageElem.classList.add("message", msg.sender);
        
        const header = document.createElement("div");
        header.classList.add("message-header");
        
        let senderName = msg.sender === "bot" ? getBotDisplayName() : "أنت";
        if (msg.sender === "bot" && msg.isSystemMessage && !msg.isInitialWelcome) {
            senderName = `${getBotDisplayName()} (نظام)`;
        }
        header.innerHTML = `<span>${senderName}</span>`;
        
        const deleteBtn = document.createElement("i");
        deleteBtn.className = "fas fa-trash delete-btn";
        deleteBtn.title = "حذف الرسالة";
        deleteBtn.onclick = () => deleteMessage(index); // Pass index to delete function
        header.appendChild(deleteBtn);
        
        messageElem.appendChild(header);
        
        const bubble = document.createElement("div");
        bubble.classList.add("bubble");

        if(msg.isImage) {
          const img = document.createElement("img");
          img.src = msg.text;
          img.style.maxWidth = "100%";
          img.style.maxHeight = "300px"; // Adjust as needed
          img.style.borderRadius = "var(--border-radius-sm)";
          img.alt = "صورة مرسلة";
          img.onload = () => {
              // Scroll to bottom if this image causes overflow and user was near bottom
              const isLastMessage = index === messages.length - 1;
              const wasNearBottomForImage = chatContainer.scrollHeight - chatContainer.scrollTop - chatContainer.clientHeight < 350; // Larger threshold for images
              if (isLastMessage || wasNearBottomForImage) {
                  chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
              }
          }
          img.onerror = () => {
              console.warn("فشل تحميل الصورة:", msg.text);
              bubble.textContent = "فشل تحميل الصورة"; // Fallback text
          }
          bubble.appendChild(img);
        } else {
          const originalText = msg.text;
          const characterLimit = 250; // Threshold for "المزيد" button

          // Add "المزيد" button for long bot messages (not system or welcome)
          if (msg.sender === "bot" && !msg.isSystemMessage && !msg.isInitialWelcome && originalText.length > characterLimit) {
            const shortText = originalText.substring(0, characterLimit) + "...";
            const contentContainer = document.createElement('div');
            const textSpan = document.createElement('span');
            textSpan.innerHTML = linkifyAndFormatText(shortText);
            contentContainer.appendChild(textSpan);

            const toggleButton = document.createElement('button');
            toggleButton.textContent = "المزيد من التفاصيل";
            toggleButton.className = "toggle-details-btn";
            toggleButton.dataset.expanded = "false";

            toggleButton.onclick = function() {
              const isExpanded = toggleButton.dataset.expanded === "true";
              if (isExpanded) {
                textSpan.innerHTML = linkifyAndFormatText(shortText);
                toggleButton.textContent = "المزيد من التفاصيل";
                toggleButton.dataset.expanded = "false";
              } else {
                textSpan.innerHTML = linkifyAndFormatText(originalText);
                toggleButton.textContent = "عرض أقل";
                toggleButton.dataset.expanded = "true";
              }
            };
            contentContainer.appendChild(toggleButton);
            bubble.appendChild(contentContainer);
          } else {
            bubble.innerHTML = linkifyAndFormatText(originalText);
          }
        }
        messageElem.appendChild(bubble);
        
        // Add action buttons for non-image, non-system bot messages
        if(msg.sender === "bot" && !msg.isImage && !msg.isSystemMessage && !msg.isInitialWelcome) {
          const actionsDiv = document.createElement("div");
          actionsDiv.classList.add("message-actions");
          
          const likeBtn = document.createElement("button");
          likeBtn.innerHTML = '<i class="fas fa-thumbs-up"></i>';
          likeBtn.title = "إعجاب";
          // Basic like functionality: toggle a class. Could be expanded to save state.
          likeBtn.addEventListener("click", (e) => e.currentTarget.classList.toggle("liked"));
          
          const copyBtn = document.createElement("button");
          copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
          copyBtn.title = "نسخ النص";
          copyBtn.addEventListener("click", () => {
            navigator.clipboard.writeText(msg.text)
            .then(() => setStatus("تم نسخ المحتوى بنجاح 👍", "success", 1500))
            .catch(err => setStatus("فشل النسخ: " + err.message, "error", 2000));
          });

          // Retry button: Only if there was a preceding user message
          if (index > 0 && messages[index - 1] && messages[index - 1].sender === 'user') {
            const retryBtn = document.createElement("button");
            retryBtn.innerHTML = '<i class="fas fa-redo"></i>';
            retryBtn.title = "إعادة السؤال";
            retryBtn.classList.add("retry-btn"); // For specific styling if needed
            retryBtn.onclick = () => retryQuery(index); // Pass current bot message index
            actionsDiv.appendChild(retryBtn);
          }
          
          actionsDiv.appendChild(likeBtn);
          actionsDiv.appendChild(copyBtn);
          messageElem.appendChild(actionsDiv);
        }
        
        chatContainer.appendChild(messageElem);
      });

      saveAllMessagesToLocalStorage(); // Save after any modification
      autoResizeTextarea(); // Adjust textarea in case content changed
      chatContainer.dispatchEvent(new Event('scroll')); // Re-check scroll button visibility
    }

    async function retryQuery(botMessageIndex) {
        // The user's query is the message *before* the bot's response
        if (botMessageIndex > 0 && messages[botMessageIndex - 1] && messages[botMessageIndex - 1].sender === 'user') {
            const originalUserQuery = messages[botMessageIndex - 1].text;
            if (originalUserQuery) {
                setStatus(`جاري إعادة إرسال السؤال: "${originalUserQuery.substring(0, 30)}..."`, "", null);
                // We don't re-add the user message, just process the query again
                await processQueryWithAI(originalUserQuery);
            } else {
                setStatus("لم يتم العثور على السؤال الأصلي.", "error", 2000);
            }
        } else {
            // This case should be rare if the retry button is only added when a user message precedes
            console.warn("Could not find preceding user message for retry for bot message at index:", botMessageIndex, messages);
            setStatus("خطأ: لم يتمكن من تحديد السؤال الأصلي لإعادته.", "error", 3000);
        }
    }

    function deleteMessage(index) {
      const isWelcome = messages[index].isInitialWelcome;
      messages.splice(index, 1); // Remove the message from the current subject's array
      allMessages[currentSubject] = messages; // Update the main store

      // If the deleted message was the initial welcome message, and no other welcome message exists
      if (isWelcome && messages.filter(m => m.sender === 'bot' && m.isInitialWelcome).length === 0) {
          addWelcomeMessage(); // Re-add a welcome message to ensure one is present
      }
      refreshChat(); // Re-render the chat display
      setStatus("تم حذف الرسالة.", "success", 1500);
    }

    function deleteAllMessages() {
      // Filter out only non-welcome messages for the count
      const nonWelcomeMessages = messages.filter(m => !m.isInitialWelcome);
      if (nonWelcomeMessages.length === 0) {
        setStatus("لا يوجد رسائل لحذفها (غير رسالة الترحيب).", "", 1500);
        return;
      }

      if (confirm("هل أنت متأكد أنك تريد حذف جميع الرسائل في هذه الدردشة؟ هذا الإجراء لا يمكن التراجع عنه.")) {
        messages = messages.filter(m => m.isInitialWelcome); // Keep only initial welcome messages
        allMessages[currentSubject] = messages; // Update the main store
        
        // Ensure a welcome message is present if all others are deleted
        if (messages.length === 0) { // If even welcome was somehow not filtered, or want to ensure one
            addWelcomeMessage(); // This will add one if none exists or update existing one
        } else { // If a welcome message was kept, ensure its text is up-to-date
            addWelcomeMessage(); // This will effectively refresh the welcome message text
        }
        refreshChat(); // Re-render
        setStatus("تم حذف جميع الرسائل في هذه الدردشة بنجاح.", "success", 2000);
      }
    }
    
    function setStatus(message, type = "", duration = 3000) {
      clearTimeout(statusTimeout);
      statusBar.textContent = message;
      statusBar.className = "status " + type; // Apply type class for styling (e.g., error, success)
      if (message && duration !== null) {
        statusTimeout = setTimeout(() => {
          statusBar.textContent = "";
          statusBar.className = "status";
        }, duration);
      } else if (!message) { // If message is empty, clear immediately
         statusBar.textContent = "";
         statusBar.className = "status";
      }
    }

    function triggerImageUpload() {
        uploadOptionsContainer.classList.remove('active');
        imageUploadInput.click();
    }

    function handleFileSelect(event) {
        if (event.target.type === 'file' && event.target.files && event.target.files[0]) {
            const file = event.target.files[0];
            processAndUploadImageFile(file);
            event.target.value = ""; // Reset file input to allow selecting the same file again
        }
    }
    
    async function processAndUploadImageFile(file) {
        if (!checkImageUploadLimit()) return;

        // Ad display logic (if you want to keep it tied to image uploads)
        setTimeout(() => {
            window.open(AD_URL, '_blank');
            console.log("تم فتح الرابط الإعلاني بسبب رفع الصورة (بعد ~10 ثوان).");
        }, AD_DELAY_MS); 

        if (file.size > 5 * 1024 * 1024) { // 5MB limit
            setStatus("حجم الصورة كبير جدًا (الحد الأقصى 5 ميجا بايت).", "error", 3000);
            return;
        }
        
        const reader = new FileReader();
        reader.onload = (e) => {
            addMessage("user", e.target.result, true); // Display image thumbnail to user
            extractTextFromImageAndProcess(file); // Then process it
        }
        reader.readAsDataURL(file);
        
        incrementImageUploadCount();
    }

    function checkImageUploadLimit() {
        const today = new Date().toISOString().split('T')[0];
        const lastUploadDate = localStorage.getItem(localStorageKeyImageUploadDate);
        let uploadCount = parseInt(localStorage.getItem(localStorageKeyImageUploadCount) || "0");

        if (lastUploadDate === today) {
            if (uploadCount >= 2) {
                setStatus("لقد تعديت الحد الأقصى لعدد الصور لهذا اليوم (صورتان).", "error", 4000);
                addMessage("bot", "عفواً، لقد استنفدت الحصة اليومية لرفع الصور (صورتان). يمكنك المحاولة مرة أخرى غداً.", false, true);
                return false;
            }
        } else {
            // New day, reset count
            localStorage.setItem(localStorageKeyImageUploadDate, today);
            localStorage.setItem(localStorageKeyImageUploadCount, "0");
            uploadCount = 0;
        }
        return true;
    }

    function incrementImageUploadCount() {
        const today = new Date().toISOString().split('T')[0];
        localStorage.setItem(localStorageKeyImageUploadDate, today); // Ensure date is current
        let currentCount = parseInt(localStorage.getItem(localStorageKeyImageUploadCount) || "0");
        localStorage.setItem(localStorageKeyImageUploadCount, (currentCount + 1).toString());
    }

    async function extractTextFromImageAndProcess(file) {
        if (!ocrApiKey) { 
             addMessage("bot", "ميزة استخلاص النص من الصور غير مفعلة حاليًا. (مفتاح OCR مفقود)", false, true);
             setStatus("مفتاح خدمة OCR غير مكوّن.", "error", 5000);
             return;
        }

        setStatus(`جاري معالجة الصورة واستخلاص النص منها...`, "", null); // Indefinite status
        const formData = new FormData();
        formData.append('apikey', ocrApiKey);
        formData.append('language', 'ara'); // Arabic language for OCR
        formData.append('isOverlayRequired', 'false');
        formData.append('file', file);

        try {
            const ocrResponse = await fetch('https://api.ocr.space/parse/image', {
                method: 'POST',
                body: formData,
            });

            if (!ocrResponse.ok) {
                const errorData = await ocrResponse.json().catch(() => ({ ErrorMessage: "فشل في تحليل استجابة الخطأ من OCR" }));
                console.error("خطأ من OCR.space:", errorData);
                throw new Error(`فشل استخلاص النص: ${errorData.ErrorMessage || ocrResponse.statusText}`);
            }

            const ocrData = await ocrResponse.json();

            if (ocrData.IsErroredOnProcessing) {
                console.error("خطأ في معالجة OCR:", ocrData.ErrorMessage);
                throw new Error(`خطأ في معالجة الصورة: ${ocrData.ErrorMessage.join(', ')}`);
            }
            
            if (ocrData.ParsedResults && ocrData.ParsedResults.length > 0 && ocrData.ParsedResults[0].ParsedText.trim() !== "") {
                const extractedText = ocrData.ParsedResults[0].ParsedText.trim();
                addMessage("bot", `تم استخلاص النص التالي من الصورة:\n"${extractedText}"`, false, true); // System message showing extracted text
                setStatus("تم استخلاص النص بنجاح، جاري إرساله للتحليل...", "success", 2500);
                await processQueryWithAI(extractedText); // Send extracted text to Gemini
            } else {
                addMessage("bot", "لم يتم العثور على نص واضح في الصورة أو أن النص غير مدعوم.", false, true);
                setStatus("لم يتم استخلاص نص من الصورة.", "error", 3000);
            }
        } catch (error) {
            console.error("خطأ أثناء استخلاص النص من الصورة:", error);
            addMessage("bot", `عفواً، حدث خطأ أثناء محاولة استخلاص النص من الصورة. ${error.message}`, false, true);
            setStatus("فشل استخلاص النص من الصورة.", "error", 4000);
        }
    }
    
    function generateChatPrompt(userMessage) {
      const maxHistoryMessages = 8; // Max number of *text* messages to include in history
      let relevantHistory = "";
      // Filter out images and certain system messages from history to keep prompt concise
      const textMessages = messages.filter(m => 
        !m.isImage && 
        !(m.sender === 'bot' && m.isSystemMessage && !m.isInitialWelcome && !m.text.includes("تم تفعيل وضع مادة") && !m.text.includes("تم الرجوع إلى وضع الدردشة العام"))
      );
      
      let currentBotDisplayName = getBotDisplayName();
      // Base system prompt
      let baseSystemPrompt = `أنت ${currentBotDisplayName}، مساعد ذكاء اصطناعي ودود، صادق، إيجابي، وذكي جداً. هدفك هو مساعدة المستخدم والإجابة على أسئلته بوضوح وبطريقة تفاعلية ومفصلة. تجنب الردود المقتضبة جداً وحاول أن تكون محادثتك جذابة. إذا لم تعرف الإجابة، اعترف بذلك بلطف وحاول تقديم المساعدة إن أمكن. استخدم بعض الرموز التعبيرية بشكل مناسب ولكن باعتدال. إذا سألك المستخدم "من صنعك" أو "مين عملك" أو "من هو مطورك" أو أي سؤال مشابه، يجب أن تكون إجابتك دائمًا "أنا من صنع وتطوير سيف هاني".\n\n`;

      let finalSystemPrompt = baseSystemPrompt;

      // Add subject-specific instructions if not in general mode
      if (currentSubject && currentSubject !== "general") {
          const subjectInstruction = `أنت الآن في وضع خبير مادة "${currentSubject}". جميع إجاباتك يجب أن تستند بشكل صارم وحصري إلى المنهج الدراسي المعتمد لمادة "${currentSubject}" في السياق التعليمي المصري إن أمكن، ما لم يحدد المستخدم خلاف ذلك. لا تقدم أي معلومات أو آراء خارج هذا النطاق المحدد. إذا كان السؤال لا يتعلق مباشرة بمنهج "${currentSubject}"، يجب عليك أن توضح أن السؤال خارج نطاق تخصص المادة الحالي وأنك تستطيع فقط الإجابة على الأسئلة المتعلقة بمنهج "${currentSubject}". لقد تم إعلام المستخدم بأن "الإجابات ستكون من المنهج الدراسي فقط". حافظ على تركيزك الكامل على مادة "${currentSubject}". ابدأ ردودك المتعلقة بالمادة بتأكيد أنك تجيب ضمن نطاق المادة.\n\n`;
          finalSystemPrompt = subjectInstruction + baseSystemPrompt; // Prepend subject instruction
      }

      // Build message history for the prompt
      const startIndex = Math.max(0, textMessages.length - maxHistoryMessages);
      for (let i = startIndex; i < textMessages.length; i++) {
        const msg = textMessages[i];
        // Skip the generic welcome message from history if it's the default one
        if (msg.sender === "bot" && msg.isInitialWelcome && msg.text.includes("كيف يمكنني مساعدتك اليوم؟")) continue;
        relevantHistory += (msg.sender === "user" ? "المستخدم: " : (currentBotDisplayName + (msg.isSystemMessage && !msg.isInitialWelcome ? " (نظام)" : "") +": ")) + msg.text + "\n";
      }
      
      // Combine system prompt, history, and current user message
      return `${finalSystemPrompt}${relevantHistory}المستخدم: ${userMessage}\n${currentBotDisplayName}:`;
    }

    async function fetchGeminiResponse(prompt) {
      if (!geminiApiKey) { 
          console.error("لم يتم تكوين مفتاح Gemini API.");
          throw new Error("عفواً، خدمة الذكاء الاصطناعي غير مكوّنة حالياً. (مفتاح Gemini مفقود)");
      }

      const requestBody = {
        contents: [{ parts: [{ text: prompt }] }],
        // Optional: Add safetySettings if needed, or generationConfig
        // generationConfig: {
        //   temperature: 0.7,
        //   topK: 40,
        //   topP: 0.95,
        //   maxOutputTokens: 1024,
        // }
      };

      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiApiKey}`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(requestBody)
        });

        if(!response.ok) {
          const errorData = await response.json().catch(() => null); // Try to parse error
          console.error("استجابة خطأ من واجهة برمجة تطبيقات Gemini:", errorData);
          let errorMessage = `خطأ ${response.status}: ${response.statusText}.`;
          
          if (response.statusText && response.statusText.toLowerCase().includes("failed to fetch")) { // Explicitly handle network failure
             throw new Error("Failed to fetch"); // This will be caught and handled below
          }
          if (errorData && errorData.error && errorData.error.message) {
             if (errorData.error.message.toLowerCase().includes("api key") || errorData.error.message.toLowerCase().includes("permission")) {
                 errorMessage += " قد يكون هناك خطأ في إعدادات الطلب أو صلاحيات مفتاح Gemini.";
             } else {
                 errorMessage += ` التفاصيل: ${errorData.error.message.substring(0, 200)}`; // Truncate long error messages
             }
          }
          throw new Error(errorMessage);
        }

        const data = await response.json();

        // Standard way to get text from Gemini response
        if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
          return data.candidates[0].content.parts[0].text;
        } else if (data.promptFeedback?.blockReason) {
            // Handle cases where the prompt was blocked
            console.warn("تم حظر الطلب بواسطة واجهة برمجة تطبيقات Gemini:", data.promptFeedback.blockReason, data.promptFeedback.safetyRatings);
            return `لم أتمكن من معالجة طلبك بسبب سياسات المحتوى الخاصة بـ Gemini (السبب: ${data.promptFeedback.blockReason}). حاول تعديل سؤالك.`;
        } else if (data.candidates && data.candidates[0]?.finishReason) {
            // Handle cases where response might be incomplete due to safety, max tokens etc.
            let botMessage = (data.candidates[0].content?.parts?.[0]?.text || ""); // Get any partial text
            const reason = data.candidates[0].finishReason;
            if (reason === "SAFETY") {
                return botMessage + (botMessage ? "\n\n" : "") + "لم أتمكن من إكمال الرد بسبب قيود السلامة من Gemini. حاول تعديل سؤالك أو الموضوع.";
            } else if (reason === "MAX_TOKENS") {
                return botMessage + (botMessage ? "\n\n" : "") + "(تم اختصار الرد لأنه تجاوز الحد الأقصى للطول المسموح به من Gemini)";
            } else {
                 console.warn("استجابة واجهة برمجة تطبيقات Gemini مع finishReason ولكن بدون محتوى كافٍ:", reason, data);
                 return botMessage + (botMessage ? "\n\n" : "") + `لم يتم استلام رد مكتمل من Gemini (السبب: ${reason}).`;
            }
        } else {
          // Fallback for unexpected response structure
          console.warn("تنسيق استجابة واجهة برمجة تطبيقات Gemini غير متوقع:", data);
          return "لم يتم استلام رد بالتنسيق الصحيح من خادم Gemini. قد يكون الرد غير كامل أو هناك مشكلة فنية.";
        }
      } catch (error) {
          console.error("خطأ في جلب الاستجابة من Gemini:", error);
          // Special handling for API key related messages to avoid exposing key in UI
          if (error.message && (error.message.toLowerCase().includes("api key") || (geminiApiKey && error.message.toLowerCase().includes(geminiApiKey.toLowerCase())))) {
              throw new Error("حدث خطأ أثناء الاتصال بخادم Gemini. يرجى مراجعة وحدة التحكم للمزيد من التفاصيل.");
          }
          throw error; // Re-throw other errors to be handled by processQueryWithAI
      }
    }

    async function processQueryWithAI(queryText) {
        if (!queryText || queryText.trim() === "") return;
        
        searchLog.textContent = `آخر استعلام: ${queryText.substring(0, 60)}${queryText.length > 60 ? '...' : ''}`;
        setStatus(`${getBotDisplayName()} يفكر بالاستعلام: "${queryText.substring(0,30)}..."`, "", null); // Indefinite status

        try {
            const prompt = generateChatPrompt(queryText);
            const responseText = await fetchGeminiResponse(prompt);
            addMessage("bot", responseText);
            setStatus("تم استلام الرد بنجاح! ✅", "success"); // Default duration (3s)

            successfulResponseCount++;
            localStorage.setItem(localStorageKeyAdCounter, successfulResponseCount.toString());

            // Ad logic (if still desired based on successful responses)
            // if (successfulResponseCount % 5 === 0) { // Example: every 5 successful responses
            //     setTimeout(() => window.open(AD_URL, '_blank'), AD_DELAY_MS_SUCCESS);
            // }

        } catch (error) {
            console.error("فشل إرسال الرسالة إلى Gemini أو معالجة الرد:", error);
            let displayError;
            if (error.message && error.message.toLowerCase().includes("failed to fetch")) {
                displayError = "فشل الاتصال بالخادم. يرجى التحقق من اتصالك بالإنترنت والمحاولة مرة أخرى.";
            } else if (error.message && error.message.includes("عفواً، خدمة الذكاء الاصطناعي غير مكوّنة حالياً.")) {
                displayError = error.message; // "Gemini key missing" message
            } else {
                displayError = "عفواً، واجهت مشكلة أثناء محاولة معالجة طلبك مع Gemini. 😥";
                // Avoid showing raw API key errors in UI if they slip through
                if (error.message && !error.message.includes("حدث خطأ أثناء الاتصال بخادم Gemini") && !error.message.toLowerCase().includes("api key")) {
                    displayError += " التفاصيل: " + error.message.substring(0,100); // Add some detail but not too much
                } else if (error.message.includes("حدث خطأ أثناء الاتصال بخادم Gemini")) {
                     displayError = "عفواً، واجهت مشكلة في الاتصال بخدمة Gemini.";
                }
            }
            addMessage("bot", displayError, false, true); // Add error as a system message from bot
            setStatus("فشل في الحصول على الرد من Gemini. ❌", "error"); // Default duration
        }
    }

    async function sendMessage() {
      const messageText = userInput.value.trim();
      if (!messageText) return;

      addMessage("user", messageText);
      userInput.value = ""; // Clear input field
      autoResizeTextarea(); // Reset textarea height

      // Ad logic for user messages
      userMessageCounterForAds++;
      if (userMessageCounterForAds % 4 === 0) { // Every 4th user message
        setTimeout(() => {
            window.open(AD_URL, '_blank');
            console.log(`تم فتح رابط الإعلان بعد الرسالة رقم ${userMessageCounterForAds} من المستخدم.`);
        }, 500); // Short delay for ad popup
      }
      
      await processQueryWithAI(messageText);
    }

    userInput.addEventListener("keydown", function(event) {
      if(event.key === "Enter" && !event.shiftKey) {
        event.preventDefault(); // Prevent newline in textarea
        sendMessage();
      }
    });
    userInput.addEventListener("input", autoResizeTextarea); // Auto-resize on input
    
    function autoResizeTextarea() {
        userInput.style.height = 'auto'; // Temporarily shrink to get correct scrollHeight
        let newHeight = userInput.scrollHeight;
        const maxHeight = parseInt(getComputedStyle(userInput).maxHeight) || 120; // Get max-height from CSS
        
        if (newHeight > maxHeight) {
            newHeight = maxHeight;
            userInput.style.overflowY = 'auto'; // Enable scrollbar if content exceeds max-height
        } else {
            userInput.style.overflowY = 'hidden'; // Hide scrollbar if content is within max-height
        }
        userInput.style.height = newHeight + 'px';
    }
    
    // Camera Functionality
    async function openCamera() {
        uploadOptionsContainer.classList.remove('active'); // Close options popup
        if (!checkImageUploadLimit()) return;

        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
                cameraView.srcObject = cameraStream;
                cameraModal.style.display = "flex"; // Show the modal
            } catch (err) {
                console.error("خطأ في الوصول إلى الكاميرا:", err);
                setStatus("لا يمكن الوصول إلى الكاميرا. تأكد من منح الأذونات.", "error", 4000);
                addMessage("bot", "عفواً، لم أتمكن من الوصول إلى الكاميرا. يرجى التأكد من أنك سمحت بالوصول إليها في إعدادات المتصفح.", false, true);
            }
        } else {
            setStatus("متصفحك لا يدعم الوصول إلى الكاميرا.", "error", 4000);
            addMessage("bot","عفواً، يبدو أن متصفحك لا يدعم ميزة استخدام الكاميرا.", false, true);
        }
    }

    function closeCamera() {
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop()); // Stop all tracks
        }
        cameraView.srcObject = null; // Clear the video source
        cameraModal.style.display = "none"; // Hide the modal
    }

    async function captureImageFromCamera() {
        const canvas = document.createElement('canvas');
        canvas.width = cameraView.videoWidth;
        canvas.height = cameraView.videoHeight;
        const context = canvas.getContext('2d');
        context.drawImage(cameraView, 0, 0, canvas.width, canvas.height);
        
        closeCamera(); // Close camera view immediately after capture

        // Convert canvas to blob, then to file, then process
        canvas.toBlob(async (blob) => {
            if (blob) {
                const capturedFile = new File([blob], `capture-${Date.now()}.jpg`, { type: 'image/jpeg' });
                await processAndUploadImageFile(capturedFile);
            } else {
                 setStatus("فشل التقاط الصورة.", "error", 3000);
                 addMessage("bot", "عفواً، حدث خطأ أثناء محاولة التقاط الصورة من الكاميرا.", false, true);
            }
        }, 'image/jpeg', 0.9); // 0.9 quality JPEG
    }

    // Initialize the application
    initializeApp();
  </script>

</body>
</html>
